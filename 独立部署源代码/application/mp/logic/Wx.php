<?php
 namespace app\mp\logic; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\logic\Defs as IndexDefs; use app\mp\service\Subjects; use app\Defs; use app\index\logic\Subject as SubjectLogic; use EasyWeChat\Factory; use app\mp\service\Users; use app\index\logic\Expert as ExpertLogic; use app\index\logic\AppointOrder as AppointOrderLogic; use app\index\service\EventLogs as EventLogsService; use app\index\logic\Sms as SmsLogic; class Wx extends Base { public function webOauth($code, $referer_url) { goto uY5fH; L4GwZ: if ($refererUrl) { goto Amo24; } goto i8kb9; i8kb9: Log::error("\167\x65\x62\117\x61\165\164\x68\40\x66\141\151\154\145\x64\40\164\157\40\160\165\154\x6c\40\x72\x65\146\x65\162\x65\162\137\x75\162\x6c"); goto OGsBz; uY5fH: wxPaySetting(); goto HiHWV; Sjw81: goto fz1E4; goto sbEge; sbEge: Amo24: goto MQspF; OLe0O: fz1E4: goto PCp_O; OGsBz: return "\x6d\160\x2f\x49\156\144\145\x78\x2f\151\156\x64\x65\x78"; goto Sjw81; SEfWw: return $refererUrl; goto OLe0O; IZMTl: $refererUrl = htmlspecialchars_decode($referer_url); goto L4GwZ; HiHWV: try { goto QR3UP; PaMAC: $userInfo = $user->toArray(); goto Rm_Gz; YZHAR: goto FLuG7; goto VsP5U; QR3UP: $app = \EasyWeChat\Factory::officialAccount(config("\167\170\56\157\146\x66\x69\x63\x69\141\x6c\x5f\141\143\143\157\165\x6e\x74")); goto RtpGU; S0Szr: if (empty($userInfo["\151\x73\x5f\x73\x6e\x61\x70\163\x68\x6f\x74\165\x73\145\162"])) { goto Ks8Rc; } goto VZytY; WcAVo: $wxUser = Users::I()->saveUserFromWx($userInfo["\x72\141\167"]); goto ZfKbN; ZfKbN: FLuG7: goto sso8b; VsP5U: Ks8Rc: goto WcAVo; VZytY: $wxUser = Users::I()->saveUserFromWx($userInfo["\162\141\167"]); goto YZHAR; sso8b: Users::I()->setLoginSession($wxUser); goto i3r0f; Rm_Gz: Log::notice("\x57\x78\x20\x6f\141\x75\164\150\40\162\x65\164\165\x72\x6e\40\165\163\145\x72\72\40" . var_export($userInfo, true)); goto S0Szr; RtpGU: $user = $app->oauth->userFromCode($code); goto PaMAC; i3r0f: } catch (\Exception $e) { Log::error("\167\x65\x62\117\141\x75\164\x68\x20\x66\141\x69\154\145\144\x20\x74\157\x20\143\162\145\141\164\x65\x2f\x75\160\144\141\x74\x65\x20\165\163\x65\x72\x2c\40\x65\162\x72\157\x72\72" . $e->getMessage()); wexception("\345\276\xae\xe4\xbf\241\347\224\xa8\xe6\210\267\346\216\x88\346\235\203\345\xa4\xb1\350\264\245\x2c\x20\x6d\x73\x67\72\40" . $e->getMessage()); } goto IZMTl; MQspF: Log::notice("\x77\x65\142\117\141\x75\164\150\x20\163\x75\x63\x63\145\163\x73\x20\x74\157\40\x70\165\154\x6c\40\x72\x65\146\145\x72\145\x72\x5f\x75\162\154\x20{$refererUrl}"); goto SEfWw; PCp_O: } public function events() { goto B9ewu; mlA9s: $app->server->push(function ($message) { goto Kn63B; qSHlT: Gkzb3: goto zRacY; Kn63B: $msg = "\163\165\x63\143\x65\x73\x73"; goto x02G3; OIFfG: kxLDV: goto qSHlT; zRacY: return $msg; goto b2YTk; K542S: switch ($message["\x4d\x73\x67\124\171\160\x65"]) { case "\x65\x76\x65\156\164": goto RDTEX; G3cwg: $msg = $reply; goto Zj2TL; Zj2TL: k2_XZ: goto zxdgd; drNZg: $arr = explode("\x5f", str_replace("\161\162\x73\x63\145\156\x65\137", '', $message["\105\166\145\x6e\x74\x4b\145\x79"])); goto CjiV1; Xod6S: goto vTOKd; goto iXxVh; zxdgd: BWfG7: goto Xod6S; vQ33c: if (!($message["\x45\166\x65\x6e\x74"] == "\x43\x4c\x49\103\113")) { goto BWfG7; } goto LKrKN; iXxVh: Td7kH: goto Lb5Q8; CjiV1: switch ($arr[0]) { case "\164\145\163\x74": $msg = $this->replySubjectLink($arr[2]); goto mIY67; case "\145\170\160\145\x72\164": $msg = $this->replyExpertLink($arr[2]); goto mIY67; case "\x63\x6f\x6d\x62\151\156\x61\164\x69\x6f\156": $msg = $this->replyCombinationLink($arr[2]); goto mIY67; case "\x41\151\x6f\x42\x69\x6e\x64\122\x65\160\157\162\x74": $msg = $this->replyReportLink($arr[1], $message["\x46\x72\x6f\155\x55\x73\145\162\116\x61\x6d\x65"]); goto mIY67; } goto VHAy9; iaIrf: if (!$reply) { goto k2_XZ; } goto G3cwg; P00ho: mIY67: goto tP53D; onXH7: goto Gkzb3; goto AanOa; Lb5Q8: if (!($message["\105\x76\145\156\164\x4b\145\171"] && $message["\x54\x69\143\x6b\x65\164"])) { goto KKJat; } goto drNZg; Ct_1e: $reply = Db::table("\167\x78\137\x6d\145\156\165\x73")->where(["\153\x65\171" => $event_key])->value("\155\163\147"); goto iaIrf; tP53D: KKJat: goto Mr7o4; VHAy9: wFh8T: goto P00ho; RDTEX: if ($message["\105\166\x65\x6e\164"] == "\163\x75\x62\x73\x63\x72\x69\142\145" || $message["\105\x76\145\156\x74"] == "\123\103\101\x4e") { goto Td7kH; } goto vQ33c; LKrKN: $event_key = $message["\105\166\145\156\x74\x4b\145\171"]; goto Ct_1e; Mr7o4: vTOKd: goto onXH7; AanOa: default: } goto OIFfG; x02G3: Log::notice("\x57\x78\x20\x65\x76\x65\156\x74\x73\x3a\x20" . var_export($message, true)); goto K542S; b2YTk: }); goto SIwTH; SIwTH: $response = $app->server->serve(); goto E8QEY; E8QEY: $response->send(); goto CveKG; B9ewu: wxPaySetting(); goto IPwBB; IPwBB: $app = \EasyWeChat\Factory::officialAccount(config("\x77\x78\56\157\146\146\x69\143\x69\141\x6c\137\x61\143\x63\157\165\156\x74")); goto mlA9s; CveKG: } protected function replySubjectLink($subject_id) { goto R8AlR; Y1RzP: return new \EasyWeChat\Kernel\Messages\News($items); goto X0sfj; R8AlR: $subject = Subjects::I()->getSubjectById($subject_id); goto SGpQ2; O61z1: return "\163\165\x63\143\145\163\x73"; goto x3QLE; SGpQ2: if (!empty($subject)) { goto a0rmH; } goto O61z1; Xph0M: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\x69\x74\154\x65" => $subject["\x6e\141\x6d\x65"], "\144\145\163\143\162\151\160\x74\x69\157\156" => "\347\202\xb9\345\x87\xbb\xe5\274\200\345\247\213\346\xb5\x8b\350\257\204", "\x75\x72\154" => url("\155\x70\x2f\x53\165\142\x6a\145\143\164\57\144\145\164\141\151\x6c", ["\151\x64" => $subject_id], false, true), "\151\x6d\x61\x67\x65" => generateUploadFullUrl($subject["\x69\x6d\141\x67\x65\137\x75\162\154"])])]; goto Y1RzP; x3QLE: a0rmH: goto Xph0M; X0sfj: } protected function replyCombinationLink($id) { goto zkoG6; wdrji: return "\x73\x75\x63\x63\x65\x73\163"; goto U6vZu; zkoG6: $row = Db::table("\163\x75\142\152\x65\x63\164\137\143\x6f\x6d\142\x69\156\x61\x74\x69\157\156")->where(["\x69\x64" => $id])->find(); goto FGygN; FGygN: if (!empty($row)) { goto HLmqp; } goto wdrji; U6vZu: HLmqp: goto CWVrE; CWVrE: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\x69\164\154\145" => $row["\x6e\x61\x6d\x65"], "\x64\x65\x73\x63\x72\151\x70\x74\151\157\156" => "\347\202\271\345\207\273\xe5\xbc\x80\345\247\213\xe6\265\213\xe8\xaf\204", "\165\x72\x6c" => url("\155\x70\57\123\x75\142\152\x65\x63\x74\57\143\157\155\142\151\156\141\x74\151\157\x6e\137\164\x65\163\164", ["\143\157\x6d\142\151\156\x61\x74\151\x6f\156\137\151\x64" => $id], false, true), "\151\x6d\141\147\x65" => generateUploadFullUrl($row["\142\141\x6e\156\x65\x72"])])]; goto Uscyr; Uscyr: return new \EasyWeChat\Kernel\Messages\News($items); goto Eir6v; Eir6v: } protected function replyExpertLink($expert_id) { goto PjIGi; PjIGi: $expert = ExpertLogic::I()->getInfos($expert_id); goto Mtmqf; q4QZx: vKhkY: goto JuB84; JuB84: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\x69\164\x6c\145" => $expert["\162\145\141\x6c\x5f\156\x61\x6d\x65"], "\x64\145\163\x63\162\151\160\164\x69\157\x6e" => "\347\202\271\345\x87\xbb\346\x9f\245\xe7\x9c\x8b\344\270\223\xe5\256\266", "\x75\x72\x6c" => url("\155\160\57\x45\x78\x70\145\x72\164\x2f\144\x65\x74\141\151\x6c", ["\x65\170\x70\145\x72\x74\x49\x64" => $expert_id], false, true), "\151\155\141\147\145" => generateUploadFullUrl($expert["\167\157\x72\x6b\x69\x6d\x67\x5f\x75\x72\154"])])]; goto EJH31; EJH31: return new \EasyWeChat\Kernel\Messages\News($items); goto DGrlG; Mtmqf: if (!empty($expert)) { goto vKhkY; } goto pGCwb; pGCwb: return "\x73\165\x63\143\145\163\163"; goto q4QZx; DGrlG: } protected function replyReportLink($order_no, $open_id) { goto z3QB1; eBIKl: $subject = Subjects::I()->getSubjectById($order["\x73\x75\142\x6a\x65\143\x74\x5f\x69\144"]); goto XahjY; lI3Se: return new \EasyWeChat\Kernel\Messages\News($items); goto G00iV; jAyda: if (!empty($order)) { goto rO915; } goto Md63J; XahjY: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\x74\x69\x74\x6c\145" => $subject["\x6e\x61\x6d\x65"], "\x64\x65\163\x63\x72\x69\x70\164\151\157\x6e" => "\347\202\xb9\xe5\207\273\xe6\x9f\245\347\x9c\213\xe6\265\x8b\350\257\x95\xe6\212\xa5\345\x91\x8a", "\x75\162\154" => url("\155\160\x2f\123\x75\142\152\x65\143\x74\x2f\x72\x65\x70\x6f\162\164", ["\157\x72\x64\145\x72\137\156\157" => $order_no, "\142\x69\x6e\x64\x5f\x6f\160\x65\156\x69\144" => $open_id], false, true), "\151\x6d\x61\x67\x65" => generateUploadFullUrl($subject["\x69\155\x61\x67\x65\x5f\165\162\x6c"])])]; goto lI3Se; l0Z_b: rO915: goto eBIKl; Md63J: return "\x73\x75\143\143\x65\x73\163"; goto l0Z_b; z3QB1: $order = Subjects::I()->getOrderByNo($order_no); goto jAyda; G00iV: } public function paidSubjectOrder() { goto VI1zG; dSef0: $app = Factory::payment(config("\167\x78\x2e\x70\x61\171\155\x65\x6e\x74")); goto W8Xzu; VI1zG: wxPaySetting(); goto dSef0; BdkvT: $response->send(); goto oqFLQ; W8Xzu: $response = $app->handlePaidNotify(function ($msg, $fail) { goto J8rTK; uqjCc: $order = Subjects::I()->getOrderByNo($msg["\157\165\x74\137\164\162\141\x64\145\x5f\x6e\x6f"]); goto c06nu; e4CMk: $save["\x70\x61\x79\137\x74\x69\155\145"] = date("\x59\x2d\155\55\x64\x20\110\x3a\151\72\x73", strtotime($msg["\x74\151\155\145\x5f\145\156\x64"])); goto L9vON; aE9sI: OUKXK: goto uqjCc; ld0jP: $this->saveTransaction(1, $msg); goto fro8t; fro8t: return true; goto Oakgw; t5UQr: return true; goto Y3ZJL; Y3ZJL: Euuu3: goto CnpQG; c06nu: if (!(empty($order) || $order["\x70\x61\x79\137\163\164\141\164\x75\x73"] == Defs::PAY_SUCCESS)) { goto Euuu3; } goto t5UQr; SWL1u: $save["\x6e\157\x74\x69\x66\x79\x5f\164\x69\155\145"] = date("\131\55\155\55\144\x20\x48\x3a\x69\x3a\x73"); goto LAIPD; qemSb: return $fail("\351\200\x9a\xe4\277\241\xe5\xa4\261\xe8\xb4\xa5\357\xbc\x8c\xe8\xaf\267\347\xa8\x8d\345\x90\x8e\xe5\206\215\xe9\200\232\xe7\237\245\346\210\221"); goto aE9sI; L9vON: FAmJR: goto NJ8hn; JgOsp: goto FAmJR; goto TIbDh; NJ8hn: Db::table("\x73\x75\142\152\145\x63\x74\137\157\x72\x64\145\162")->where(["\x6f\x72\144\x65\x72\x5f\x6e\157" => $order["\157\162\x64\145\162\x5f\x6e\x6f"]])->update($save); goto ld0jP; TIbDh: xBcx2: goto KO1kS; J8rTK: file_put_contents(LOG_PATH . "\x77\x78\137\x70\x61\171\x2e\x6c\x6f\147", var_export($msg, true), FILE_APPEND); goto dwe2Z; KO1kS: $save["\x70\x61\x79\x5f\x73\164\x61\164\x75\163"] = Defs::PAY_SUCCESS; goto e4CMk; dwe2Z: if (!($msg["\162\x65\164\x75\x72\156\137\143\157\144\145"] == "\x46\101\111\x4c")) { goto OUKXK; } goto qemSb; GNq88: $save["\x70\141\171\137\163\x74\141\x74\x75\x73"] = Defs::PAY_FAIL; goto JgOsp; CnpQG: $save = []; goto SWL1u; LAIPD: if ($msg["\162\145\163\165\x6c\x74\x5f\x63\157\x64\145"] == "\123\125\103\103\x45\123\123") { goto xBcx2; } goto GNq88; Oakgw: }); goto BdkvT; oqFLQ: } public function paidExpertOrder() { goto Jwf2u; pQ2FO: $response->send(); goto P4Qmz; j48Bv: $app = Factory::payment(config("\167\x78\56\x70\141\x79\155\x65\156\x74")); goto Rxnag; Rxnag: $response = $app->handlePaidNotify(function ($msg, $fail) { goto bw9Oh; YIlMQ: return true; goto LoQYW; atADW: HwkeE: goto zFj8W; kTLyy: SWtIB: goto T9aFz; LvwOR: $order = AppointOrderLogic::I()->getInfos($msg["\157\165\164\x5f\164\162\141\144\145\x5f\156\x6f"]); goto TOvMf; zFj8W: if (!($order["\x73\x74\141\164\x75\x73"] == IndexDefs::ORDER_PENDING_STATUS)) { goto mnpus; } goto cdk_4; OimU0: Ye0GD: goto LvwOR; ZAk4Z: $appointTimeSms = convertAppointTimesToShow($order["\x61\160\160\x6f\x69\x6e\x74\x5f\x74\151\155\145"]); goto PL3K2; xjtaS: if (!($msg["\x72\145\164\165\162\x6e\137\143\157\144\145"] == "\106\101\x49\114")) { goto Ye0GD; } goto ixDw2; Nzuer: $save["\160\x61\171\x5f\x74\151\x6d\x65"] = date("\131\x2d\x6d\55\x64\40\x48\x3a\x69\x3a\163", strtotime($msg["\164\x69\x6d\x65\x5f\145\156\144"])); goto atADW; nhJjK: Db::table("\x65\170\160\145\x72\164\137\x6f\162\x64\145\162")->where(["\x6f\162\x64\145\162\137\x6e\157" => $order["\x6f\162\144\145\x72\137\x6e\157"]])->update($save); goto G08mw; TOvMf: if (!(empty($order) || $order["\x70\141\x79\137\163\x74\x61\x74\165\x73"] == Defs::PAY_SUCCESS)) { goto n2Ukb; } goto YIlMQ; Kc3Jx: if ($msg["\162\145\x73\x75\x6c\x74\x5f\143\x6f\x64\145"] == "\123\125\x43\x43\x45\x53\123") { goto SWtIB; } goto eI8ET; ixDw2: return $fail("\351\200\x9a\xe4\xbf\xa1\xe5\244\261\350\264\xa5\357\xbc\x8c\350\257\267\347\250\215\xe5\x90\216\345\x86\x8d\351\200\232\xe7\237\245\xe6\210\221"); goto OimU0; a6EJH: logEvent("\xe5\x8f\x91\351\200\201\351\xa2\204\xe7\272\xa6\351\x80\232\347\x9f\xa5\347\x9f\xad\344\277\xa1\xe5\210\xb0\345\xae\xa2\xe6\x88\xb7{$order["\x63\145\154\154\x70\x68\157\156\x65"]}\345\xa4\261\xe8\264\xa5", EventLogsService::eSeverityError); goto Pl4lC; Pl4lC: Log::error("\x66\141\x69\154\145\144\40\x74\157\40\163\x65\x6e\x64\40\163\155\163\x20\x74\x6f\40\x63\x75\x73\164\157\155\x65\162\40{$order["\143\145\x6c\x6c\160\150\157\x6e\x65"]}"); goto YvVPa; zB3DO: $save["\156\x6f\x74\x69\x66\171\137\164\151\155\145"] = date("\x59\x2d\155\55\x64\x20\110\x3a\x69\72\163"); goto Kc3Jx; YvVPa: XeNBj: goto IzCEZ; IzCEZ: O28Q4: goto X6rEB; F_jIn: $save = []; goto zB3DO; T9aFz: $save["\160\141\171\137\x73\x74\x61\x74\x75\163"] = Defs::PAY_SUCCESS; goto Nzuer; avDGT: return true; goto cQ2tr; G08mw: if (!($order["\x73\x74\x61\x74\165\x73"] == IndexDefs::ORDER_PENDING_STATUS)) { goto fJKhK; } goto nFG5B; X6rEB: fJKhK: goto qOUnm; nFG5B: if (!(systemSetting("\163\145\156\144\137\141\160\160\x6f\x69\x6e\x74\137\157\162\x64\145\162\137\164\x6f\x5f\143\165\x73\164\x6f\x6d\x65\162") == "\x79\x65\x73")) { goto O28Q4; } goto ZAk4Z; eI8ET: $save["\x70\141\x79\137\163\x74\x61\164\165\163"] = Defs::PAY_FAIL; goto AVpx4; PL3K2: $smsResult = SmsLogic::I()->sendAppoitOrderToCustomer($order["\143\x65\x6c\x6c\x70\150\157\156\145"], date("\x6d\346\234\210\x64\xe6\x97\xa5", strtotime($order["\141\x70\160\x6f\x69\156\x74\x5f\144\141\164\145"])) . "\x20" . $appointTimeSms, systemSetting("\141\x70\x70\x6f\151\x6e\x74\137\157\x72\144\145\162\137\x6f\x66\x66\151\143\x65\x5f\x61\144\x64\162\x65\163\163")); goto VdNCx; BMKEw: mnpus: goto nhJjK; qOUnm: $this->saveTransaction(2, $msg); goto avDGT; cdk_4: $save["\x73\164\x61\164\x75\x73"] = IndexDefs::ORDER_APPOINTED_STATUS; goto BMKEw; VdNCx: if ($smsResult) { goto XeNBj; } goto a6EJH; bw9Oh: file_put_contents(LOG_PATH . "\167\x78\137\x70\141\x79\56\154\x6f\x67", var_export($msg, true), FILE_APPEND); goto xjtaS; AVpx4: goto HwkeE; goto kTLyy; LoQYW: n2Ukb: goto F_jIn; cQ2tr: }); goto pQ2FO; Jwf2u: wxPaySetting(); goto j48Bv; P4Qmz: } protected function saveTransaction($fee_type, $msg) { goto duKnq; E2y8V: Db::table("\x74\162\141\156\x73\141\x63\164\x69\157\x6e\163")->insert(["\x6f\x72\x64\145\162\137\x6e\x6f" => $msg["\157\165\x74\x5f\164\x72\141\144\x65\x5f\156\157"], "\146\145\x65\x5f\x74\171\x70\x65" => $fee_type, "\x74\157\164\x61\x6c\x5f\x66\x65\145" => $msg["\164\157\164\x61\154\x5f\x66\x65\x65"], "\x63\x68\141\156\156\x65\154" => $msg["\155\x63\x68\137\x69\144"] == 1, "\160\141\x79\154\x6f\x61\144" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto G_AdI; j4IS2: dYgXr: goto STqRl; admXW: Db::table("\x74\x72\x61\156\163\141\x63\x74\x69\x6f\x6e\163")->where(["\157\x72\144\145\x72\x5f\x6e\x6f" => $msg["\x6f\165\164\x5f\164\x72\141\x64\145\x5f\x6e\157"], "\x66\145\x65\x5f\164\x79\160\145" => $fee_type])->update(["\x74\x6f\164\x61\154\137\146\145\145" => $msg["\164\x6f\x74\x61\154\137\x66\x65\145"], "\x63\x68\x61\x6e\x6e\145\154" => $msg["\x6d\x63\x68\137\x69\x64"] == 1, "\x70\x61\171\x6c\x6f\141\144" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto j4IS2; dt6Yq: PGUqE: goto admXW; G_AdI: goto dYgXr; goto dt6Yq; duKnq: $row = Db::table("\164\162\x61\156\163\141\x63\164\x69\157\x6e\163")->where(["\157\x72\144\x65\x72\x5f\156\x6f" => $msg["\x6f\x75\x74\x5f\x74\162\x61\144\145\137\156\157"], "\146\x65\x65\x5f\164\171\160\x65" => $fee_type])->field("\151\x64")->find(); goto gZTSc; gZTSc: if ($row) { goto PGUqE; } goto E2y8V; STqRl: } }

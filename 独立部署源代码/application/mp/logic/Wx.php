<?php
 namespace app\mp\logic; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\logic\Defs as IndexDefs; use app\mp\service\Subjects; use app\Defs; use app\index\logic\Subject as SubjectLogic; use EasyWeChat\Factory; use app\mp\service\Users; use app\index\logic\Expert as ExpertLogic; use app\index\logic\AppointOrder as AppointOrderLogic; use app\index\service\EventLogs as EventLogsService; use app\index\logic\Sms as SmsLogic; class Wx extends Base { public function webOauth($code, $referer_url) { goto BL8Ta; nbk2Y: if ($refererUrl) { goto KqzXk; } goto p1RoW; irE6c: KqzXk: goto SPz35; fV2WX: z4Ntn: goto J9H4c; WikpZ: $refererUrl = htmlspecialchars_decode($referer_url); goto nbk2Y; BL8Ta: wxPaySetting(); goto t3O04; p1RoW: Log::error("\167\145\142\117\141\x75\x74\150\40\146\x61\x69\154\145\x64\40\164\x6f\x20\160\165\x6c\x6c\x20\x72\x65\146\x65\162\x65\x72\x5f\165\162\154"); goto nVx_a; nVx_a: return "\155\160\x2f\x49\x6e\x64\x65\170\57\151\x6e\144\x65\x78"; goto x7DyR; t3O04: try { goto lIuPz; RWsVJ: dUIkE: goto kcBRP; qKJgt: Users::I()->setLoginSession($wxUser); goto Ajw3t; JsepW: Log::notice("\x57\170\x20\157\141\165\x74\150\40\x72\x65\x74\x75\162\x6e\40\x75\163\145\x72\72\x20" . var_export($userInfo, true)); goto bD21g; aBiKr: $wxUser = Users::I()->saveUserFromWx($userInfo["\162\x61\167"]); goto TqiPQ; t_MOn: $user = $app->oauth->userFromCode($code); goto mLP1Q; mLP1Q: $userInfo = $user->toArray(); goto JsepW; lIuPz: $app = \EasyWeChat\Factory::officialAccount(config("\x77\170\x2e\x6f\x66\146\x69\143\151\x61\x6c\137\141\x63\x63\x6f\165\156\x74")); goto t_MOn; kcBRP: $wxUser = Users::I()->saveUserFromWx($userInfo["\x72\x61\x77"]); goto Y7P7N; Y7P7N: VpqbM: goto qKJgt; TqiPQ: goto VpqbM; goto RWsVJ; bD21g: if (empty($userInfo["\151\163\137\163\156\141\160\163\150\157\x74\165\x73\x65\162"])) { goto dUIkE; } goto aBiKr; Ajw3t: } catch (\Exception $e) { Log::error("\x77\145\x62\117\x61\x75\164\150\40\x66\x61\x69\154\x65\144\x20\164\157\x20\143\x72\x65\141\164\145\57\x75\x70\x64\x61\164\145\x20\x75\x73\x65\x72\54\x20\145\x72\x72\x6f\x72\x3a" . $e->getMessage()); wexception("\345\xbe\256\344\277\xa1\347\x94\xa8\346\x88\267\346\216\x88\xe6\x9d\x83\xe5\244\xb1\xe8\264\245\x2c\x20\155\163\x67\72\40" . $e->getMessage()); } goto WikpZ; WF3KW: return $refererUrl; goto fV2WX; x7DyR: goto z4Ntn; goto irE6c; SPz35: Log::notice("\x77\145\142\x4f\141\165\x74\150\x20\163\x75\x63\143\145\x73\163\40\164\157\x20\160\165\x6c\154\x20\x72\145\146\145\162\145\x72\137\x75\162\154\x20{$refererUrl}"); goto WF3KW; J9H4c: } public function events() { goto pEBKC; LK0jV: $response->send(); goto vBE21; pEBKC: wxPaySetting(); goto RivUQ; t38L2: $app->server->push(function ($message) { goto xXzQl; bjuFG: Log::notice("\127\170\40\145\x76\x65\156\x74\163\x3a\40" . var_export($message, true)); goto Op3Eq; ybUPX: QrOCn: goto fm7sh; Op3Eq: switch ($message["\115\163\147\124\171\x70\x65"]) { case "\145\x76\145\156\x74": goto fgEuW; DQoKB: if (!$reply) { goto flQXv; } goto miV73; xKb8m: if (!($message["\105\x76\145\x6e\x74\113\x65\171"] && $message["\124\151\x63\153\145\164"])) { goto Sl1It; } goto qWpjK; ZS1Oa: Bq0We: goto OSbp2; DZCw8: i0NQN: goto obzdv; qWpjK: $arr = explode("\137", str_replace("\x71\162\163\143\145\156\145\137", '', $message["\105\166\145\x6e\164\x4b\145\171"])); goto kEF5b; BdDqn: Y4McO: goto z4JET; fgEuW: if ($message["\x45\x76\x65\x6e\164"] == "\x73\165\142\x73\143\162\x69\142\x65" || $message["\x45\166\x65\156\x74"] == "\x53\103\101\116") { goto K834z; } goto R1DuT; OSbp2: Sl1It: goto DZCw8; R1DuT: if (!($message["\x45\166\145\x6e\x74"] == "\103\x4c\x49\x43\x4b")) { goto Y4McO; } goto Hdugu; Hdugu: $event_key = $message["\x45\x76\x65\156\164\113\x65\x79"]; goto HOABJ; L2yem: iXUoS: goto ZS1Oa; SGBPk: flQXv: goto BdDqn; obzdv: goto QrOCn; goto w0EXy; miV73: $msg = $reply; goto SGBPk; kEF5b: switch ($arr[0]) { case "\164\x65\x73\x74": $msg = $this->replySubjectLink($arr[2]); goto Bq0We; case "\x65\x78\x70\145\x72\x74": $msg = $this->replyExpertLink($arr[2]); goto Bq0We; case "\143\157\x6d\x62\151\156\141\x74\151\157\x6e": $msg = $this->replyCombinationLink($arr[2]); goto Bq0We; case "\x41\x69\x6f\x42\151\x6e\x64\122\145\x70\157\162\164": $msg = $this->replyReportLink($arr[1], $message["\106\x72\x6f\x6d\x55\163\x65\x72\x4e\141\x6d\x65"]); goto Bq0We; } goto L2yem; nkou_: K834z: goto xKb8m; HOABJ: $reply = Db::table("\167\170\x5f\155\145\156\x75\x73")->where(["\x6b\x65\171" => $event_key])->value("\x6d\x73\x67"); goto DQoKB; z4JET: goto i0NQN; goto nkou_; w0EXy: default: } goto hUsrQ; xXzQl: $msg = "\163\165\x63\x63\145\163\163"; goto bjuFG; fm7sh: return $msg; goto b4nJJ; hUsrQ: GcV4X: goto ybUPX; b4nJJ: }); goto tAuVk; RivUQ: $app = \EasyWeChat\Factory::officialAccount(config("\x77\170\56\x6f\x66\x66\x69\143\151\141\154\x5f\141\x63\x63\x6f\165\156\164")); goto t38L2; tAuVk: $response = $app->server->serve(); goto LK0jV; vBE21: } protected function replySubjectLink($subject_id) { goto KpyM8; gvloB: if (!empty($subject)) { goto f1epS; } goto xha1g; xha1g: return "\x73\x75\143\x63\x65\x73\x73"; goto LzgDd; KpyM8: $subject = Subjects::I()->getSubjectById($subject_id); goto gvloB; tkrVP: return new \EasyWeChat\Kernel\Messages\News($items); goto Y8vBQ; LzgDd: f1epS: goto O33qO; O33qO: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\151\x74\x6c\x65" => $subject["\x6e\141\155\x65"], "\x64\145\163\143\x72\x69\160\164\x69\x6f\156" => "\xe7\202\271\xe5\x87\273\xe5\xbc\x80\xe5\xa7\213\xe6\265\x8b\xe8\xaf\x84", "\165\162\x6c" => url("\x6d\x70\57\123\x75\x62\x6a\x65\x63\x74\x2f\x64\145\164\x61\x69\x6c", ["\151\144" => $subject_id], false, true), "\151\x6d\141\147\145" => generateUploadFullUrl($subject["\x69\x6d\141\x67\x65\137\x75\162\x6c"])])]; goto tkrVP; Y8vBQ: } protected function replyCombinationLink($id) { goto c4nrn; a8jGt: if (!empty($row)) { goto dngAs; } goto iPyqR; c4nrn: $row = Db::table("\x73\x75\x62\x6a\x65\x63\164\x5f\x63\x6f\155\142\x69\x6e\141\164\151\x6f\x6e")->where(["\151\144" => $id])->find(); goto a8jGt; sb1wc: return new \EasyWeChat\Kernel\Messages\News($items); goto m1hv9; iPyqR: return "\163\165\x63\x63\145\163\163"; goto slHoF; slHoF: dngAs: goto wBbpC; wBbpC: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\151\164\x6c\145" => $row["\x6e\141\155\145"], "\x64\x65\163\143\162\151\x70\x74\x69\x6f\x6e" => "\xe7\202\271\345\207\273\xe5\xbc\200\345\xa7\x8b\346\265\x8b\350\257\204", "\x75\x72\x6c" => url("\155\x70\57\123\x75\142\x6a\145\143\x74\x2f\143\157\155\x62\151\x6e\x61\x74\151\157\156\137\164\145\163\164", ["\143\x6f\x6d\142\x69\x6e\x61\164\x69\157\x6e\x5f\x69\144" => $id], false, true), "\151\x6d\141\147\x65" => generateUploadFullUrl($row["\x62\141\x6e\x6e\x65\162"])])]; goto sb1wc; m1hv9: } protected function replyExpertLink($expert_id) { goto QNui3; V9Co4: return "\x73\165\143\x63\x65\x73\x73"; goto WV726; SYBYR: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\x74\151\164\x6c\145" => $expert["\162\145\141\x6c\x5f\156\141\155\145"], "\x64\145\163\143\162\x69\160\x74\151\157\156" => "\xe7\x82\xb9\xe5\x87\xbb\346\237\245\347\x9c\x8b\xe4\270\x93\xe5\xae\xb6", "\x75\162\x6c" => url("\155\x70\57\x45\170\x70\x65\162\164\57\x64\145\164\141\x69\154", ["\x65\x78\160\x65\x72\164\111\144" => $expert_id], false, true), "\151\x6d\141\147\x65" => generateUploadFullUrl($expert["\x77\157\x72\x6b\x69\155\147\x5f\165\162\x6c"])])]; goto nabNw; QNui3: $expert = ExpertLogic::I()->getInfos($expert_id); goto CzFIZ; WV726: Y6jKx: goto SYBYR; CzFIZ: if (!empty($expert)) { goto Y6jKx; } goto V9Co4; nabNw: return new \EasyWeChat\Kernel\Messages\News($items); goto RKVSP; RKVSP: } protected function replyReportLink($order_no, $open_id) { goto ug7SX; ug7SX: $order = Subjects::I()->getOrderByNo($order_no); goto tVNnj; jmOXX: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\x74\x69\x74\154\145" => $subject["\156\141\155\x65"], "\x64\x65\163\x63\162\151\160\x74\x69\x6f\x6e" => "\347\202\xb9\xe5\x87\xbb\346\237\245\347\x9c\x8b\346\xb5\213\xe8\xaf\x95\xe6\x8a\245\xe5\x91\x8a", "\x75\162\x6c" => url("\155\160\57\x53\165\x62\152\145\x63\x74\x2f\162\145\x70\x6f\162\x74", ["\x6f\162\x64\145\162\x5f\156\x6f" => $order_no, "\x62\151\x6e\x64\137\x6f\160\x65\156\x69\144" => $open_id], false, true), "\x69\155\141\x67\145" => generateUploadFullUrl($subject["\151\155\x61\x67\x65\137\165\162\x6c"])])]; goto Z_tRi; tVNnj: if (!empty($order)) { goto IcMkf; } goto iQVAW; D32Gi: IcMkf: goto iqP_I; iqP_I: $subject = Subjects::I()->getSubjectById($order["\163\165\x62\x6a\145\x63\164\x5f\x69\x64"]); goto jmOXX; Z_tRi: return new \EasyWeChat\Kernel\Messages\News($items); goto fb7eF; iQVAW: return "\x73\x75\143\x63\145\163\x73"; goto D32Gi; fb7eF: } public function paidSubjectOrder() { goto ww6Cv; ww6Cv: wxPaySetting(); goto ShM_j; pMaJz: $response->send(); goto XeWGP; YUn4Q: $response = $app->handlePaidNotify(function ($msg, $fail) { goto sZKZT; W0X6i: $save["\160\x61\x79\x5f\x74\151\155\x65"] = date("\x59\x2d\x6d\55\x64\x20\110\72\151\72\163", strtotime($msg["\164\151\x6d\x65\x5f\145\156\x64"])); goto YYSLy; gWjhT: if ($msg["\x72\145\x73\x75\154\164\x5f\143\157\x64\x65"] == "\x53\125\103\x43\105\123\123") { goto ygadC; } goto Wi_8H; lvM6b: return true; goto WnnqF; Wi_8H: $save["\x70\x61\171\137\x73\x74\x61\x74\165\163"] = Defs::PAY_FAIL; goto rJ402; IGF8V: $this->saveTransaction(1, $msg); goto lvM6b; YYSLy: mEf5e: goto rXFAd; iBiVo: if (!($msg["\x72\x65\164\x75\x72\x6e\x5f\143\157\x64\145"] == "\106\101\111\114")) { goto mpXc2; } goto SaO9I; DOsnv: $order = Subjects::I()->getOrderByNo($msg["\x6f\x75\x74\x5f\x74\162\141\x64\x65\x5f\156\157"]); goto Rxq6S; sZKZT: file_put_contents(LOG_PATH . "\x77\x78\137\x70\141\171\56\x6c\x6f\x67", var_export($msg, true), FILE_APPEND); goto iBiVo; SaO9I: return $fail("\xe9\200\x9a\xe4\277\xa1\345\xa4\261\350\xb4\xa5\xef\xbc\x8c\350\xaf\xb7\xe7\250\215\xe5\x90\216\345\206\215\351\200\232\xe7\x9f\245\346\x88\221"); goto W1uKf; iFVNg: $save = []; goto jBTW3; mtlnq: ygadC: goto BPgGJ; Rxq6S: if (!(empty($order) || $order["\160\141\171\x5f\x73\x74\141\164\x75\x73"] == Defs::PAY_SUCCESS)) { goto hLBLV; } goto w5iW0; jBTW3: $save["\156\157\164\151\x66\171\137\164\x69\x6d\145"] = date("\131\55\x6d\55\144\x20\110\x3a\x69\x3a\163"); goto gWjhT; TrzhN: hLBLV: goto iFVNg; BPgGJ: $save["\x70\141\x79\137\163\x74\141\x74\165\163"] = Defs::PAY_SUCCESS; goto W0X6i; rJ402: goto mEf5e; goto mtlnq; rXFAd: Db::table("\163\x75\142\x6a\x65\x63\164\x5f\157\162\x64\x65\162")->where(["\157\162\144\145\x72\137\x6e\157" => $order["\x6f\162\x64\145\x72\x5f\156\x6f"]])->update($save); goto IGF8V; W1uKf: mpXc2: goto DOsnv; w5iW0: return true; goto TrzhN; WnnqF: }); goto pMaJz; ShM_j: $app = Factory::payment(config("\x77\x78\x2e\x70\x61\171\x6d\145\x6e\x74")); goto YUn4Q; XeWGP: } public function paidExpertOrder() { goto T1E25; sbHN4: $app = Factory::payment(config("\x77\x78\56\160\141\x79\x6d\145\156\164")); goto LTRWJ; cnoQi: $response->send(); goto n6kY0; T1E25: wxPaySetting(); goto sbHN4; LTRWJ: $response = $app->handlePaidNotify(function ($msg, $fail) { goto qhNcO; O7Ffm: $save["\163\164\141\x74\x75\x73"] = IndexDefs::ORDER_APPOINTED_STATUS; goto chtav; ZSTww: if (!(empty($order) || $order["\160\141\171\137\163\164\141\164\x75\163"] == Defs::PAY_SUCCESS)) { goto t3vMo; } goto TCuNy; vbtPu: $appointTimeSms = convertAppointTimesToShow($order["\141\x70\160\157\151\156\164\137\x74\151\155\x65"]); goto Wyjt9; NHvyH: goto COWe9; goto NH6as; nXpVG: wKVTx: goto H9GD5; YU5_F: return true; goto NDsPM; N7Tin: return $fail("\351\200\x9a\xe4\277\xa1\xe5\xa4\xb1\350\264\245\357\xbc\x8c\xe8\xaf\267\347\250\215\345\220\216\xe5\x86\x8d\351\200\232\xe7\x9f\xa5\xe6\x88\x91"); goto j1ZnX; SVRD5: $order = AppointOrderLogic::I()->getInfos($msg["\x6f\x75\x74\137\164\x72\x61\x64\145\x5f\x6e\157"]); goto ZSTww; chtav: U2BCh: goto xO3uM; Yo10Q: COWe9: goto YD1Jh; W3uQi: if (!(systemSetting("\x73\x65\156\x64\x5f\141\160\160\x6f\x69\156\164\x5f\x6f\162\144\145\x72\x5f\x74\x6f\x5f\143\x75\163\164\157\155\145\162") == "\171\x65\163")) { goto EghrQ; } goto vbtPu; NH6as: Nk84S: goto JwhmK; YD1Jh: if (!($order["\x73\164\x61\164\x75\x73"] == IndexDefs::ORDER_PENDING_STATUS)) { goto U2BCh; } goto O7Ffm; W1YGL: $save["\160\141\171\137\x73\x74\x61\164\x75\x73"] = Defs::PAY_FAIL; goto NHvyH; hKG_l: logEvent("\345\217\221\xe9\200\201\351\242\x84\xe7\272\246\xe9\200\232\347\x9f\245\347\x9f\xad\xe4\xbf\xa1\345\210\260\345\xae\242\xe6\210\267{$order["\143\x65\x6c\154\160\x68\157\x6e\145"]}\xe5\244\261\350\264\245", EventLogsService::eSeverityError); goto H_6DN; JwhmK: $save["\160\141\x79\x5f\x73\164\x61\164\x75\x73"] = Defs::PAY_SUCCESS; goto DAikD; h5NUl: wWOTH: goto kVtEZ; WCr2E: if ($msg["\x72\x65\x73\165\154\x74\x5f\x63\x6f\x64\x65"] == "\x53\125\x43\103\105\x53\x53") { goto Nk84S; } goto W1YGL; ow_n6: t3vMo: goto rCqpp; j1ZnX: bCNgc: goto SVRD5; JHLda: $save["\156\157\164\151\146\171\137\x74\151\155\x65"] = date("\x59\55\x6d\55\144\x20\110\x3a\151\x3a\163"); goto WCr2E; DAikD: $save["\x70\141\x79\137\x74\x69\x6d\145"] = date("\x59\55\155\55\144\40\110\72\x69\72\163", strtotime($msg["\x74\151\155\x65\137\x65\x6e\144"])); goto Yo10Q; kVtEZ: EghrQ: goto nXpVG; xO3uM: Db::table("\145\170\160\x65\162\164\137\x6f\162\x64\145\x72")->where(["\157\162\x64\x65\x72\137\x6e\x6f" => $order["\157\x72\144\145\x72\x5f\156\x6f"]])->update($save); goto hLgBy; hLgBy: if (!($order["\163\x74\141\x74\165\x73"] == IndexDefs::ORDER_PENDING_STATUS)) { goto wKVTx; } goto W3uQi; ZMvbq: if (!($msg["\x72\145\164\x75\162\x6e\x5f\143\x6f\144\x65"] == "\x46\101\111\114")) { goto bCNgc; } goto N7Tin; qhNcO: file_put_contents(LOG_PATH . "\x77\x78\137\160\141\x79\56\154\157\x67", var_export($msg, true), FILE_APPEND); goto ZMvbq; H_6DN: Log::error("\146\141\x69\154\x65\x64\40\x74\x6f\x20\163\145\156\144\40\x73\155\x73\x20\x74\x6f\40\x63\165\x73\164\157\x6d\145\x72\x20{$order["\143\145\x6c\x6c\160\x68\157\156\145"]}"); goto h5NUl; H9GD5: $this->saveTransaction(2, $msg); goto YU5_F; Wyjt9: $smsResult = SmsLogic::I()->sendAppoitOrderToCustomer($order["\x63\145\x6c\x6c\x70\x68\x6f\156\145"], date("\x6d\xe6\234\x88\144\xe6\227\245", strtotime($order["\x61\x70\x70\x6f\x69\156\164\137\144\141\164\x65"])) . "\x20" . $appointTimeSms, systemSetting("\x61\160\x70\157\151\156\x74\x5f\x6f\162\144\145\162\137\x6f\x66\x66\151\143\x65\137\141\144\144\x72\x65\163\x73")); goto ocpdF; ocpdF: if ($smsResult) { goto wWOTH; } goto hKG_l; rCqpp: $save = []; goto JHLda; TCuNy: return true; goto ow_n6; NDsPM: }); goto cnoQi; n6kY0: } protected function saveTransaction($fee_type, $msg) { goto spTNs; Hqx45: I81UB: goto n2BSF; spTNs: $row = Db::table("\164\162\x61\156\163\x61\x63\164\151\x6f\x6e\x73")->where(["\x6f\x72\144\145\x72\x5f\156\x6f" => $msg["\157\x75\164\x5f\x74\x72\x61\144\145\137\156\x6f"], "\146\145\145\x5f\x74\x79\x70\x65" => $fee_type])->field("\151\144")->find(); goto nQuaG; nQuaG: if ($row) { goto Do0uF; } goto hSSrj; SjEuv: goto I81UB; goto V0AHh; V0AHh: Do0uF: goto G8uR2; hSSrj: Db::table("\164\162\x61\156\x73\141\143\164\x69\x6f\156\163")->insert(["\x6f\x72\144\145\162\137\x6e\x6f" => $msg["\x6f\165\164\x5f\164\162\141\x64\x65\x5f\156\x6f"], "\x66\x65\x65\137\x74\171\x70\x65" => $fee_type, "\164\x6f\x74\x61\154\137\146\145\x65" => $msg["\x74\157\x74\141\154\x5f\x66\x65\x65"], "\x63\150\x61\156\156\145\x6c" => $msg["\155\x63\150\137\x69\144"] == 1, "\x70\x61\171\154\157\x61\x64" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto SjEuv; G8uR2: Db::table("\x74\162\x61\x6e\x73\x61\143\x74\x69\157\x6e\163")->where(["\x6f\162\144\145\x72\137\156\157" => $msg["\157\x75\x74\137\164\x72\x61\144\145\x5f\x6e\x6f"], "\146\145\145\x5f\x74\x79\160\x65" => $fee_type])->update(["\164\157\164\141\154\x5f\146\x65\x65" => $msg["\164\x6f\164\141\x6c\x5f\x66\x65\145"], "\143\x68\141\x6e\156\x65\154" => $msg["\x6d\x63\x68\137\x69\x64"] == 1, "\x70\141\x79\154\157\141\x64" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto Hqx45; n2BSF: } }

<?php
 namespace app\cli\logic; use app\index\service\Setting; use think\Log; class BackupDB { private $mysql_dump = ROOT_PATH . "\x62\151\156" . DS . "\155\x79\163\161\154\x64\x75\x6d\x70\x2e\x65\170\145"; private $compressor = ROOT_PATH . "\x62\151\x6e" . DS . "\67\x7a\x2e\x65\170\x65"; public $backup_path = ROOT_PATH . "\x64\x62" . DS . "\142\x61\x63\153\x75\x70"; public $expiration = 30 * 86400; public $error = null; public function __construct() { goto efhQ7; efhQ7: $config = ["\x44\102\137\x42\101\103\x4b\x55\120\137\120\x41\x54\110" => systemSetting("\104\x42\x5f\x42\x41\x43\113\x55\120\x5f\120\x41\124\110"), "\104\102\137\102\101\103\x4b\125\120\x5f\105\130\120\x49\x52\x41\x54\111\117\116" => systemSetting("\x44\x42\137\102\x41\103\x4b\125\x50\x5f\105\x58\x50\x49\122\x41\124\x49\x4f\116")]; goto nFm98; nFm98: if (!$config["\104\102\137\x42\101\103\113\x55\120\137\120\101\124\110"]) { goto mThPh; } goto fDd_3; fp1K9: mkdir($this->backup_path, 0775); goto LMGFy; LMGFy: aF9yb: goto CizJl; d2XfN: $this->backup_path = rtrim($this->backup_path, "\57\134"); goto ej2Ly; CizJl: if (!(!file_exists($this->backup_path) || !is_writable($this->backup_path))) { goto CctcV; } goto LgPGx; KZb92: CctcV: goto wPxQ_; LgPGx: exception("\345\xa4\x87\344\273\275\347\x9b\256\345\275\225\xef\xbc\x9a" . $this->backup_path . "\xe6\227\xa0\346\xb3\x95\xe5\x86\x99\345\x85\245\357\xbc\x8c\xe8\257\267\xe6\xa3\200\xe6\237\xa5\xe6\235\x83\351\231\x90"); goto KZb92; xBRvG: SCy1q: goto d2XfN; SqjmY: if (!$config["\104\102\x5f\102\x41\103\x4b\125\120\x5f\105\130\120\x49\122\x41\x54\x49\117\116"]) { goto SCy1q; } goto hg2em; qcWOa: mThPh: goto SqjmY; fDd_3: $this->backup_path = $config["\x44\102\x5f\102\101\103\x4b\125\x50\137\120\101\x54\x48"]; goto qcWOa; ej2Ly: if (file_exists($this->backup_path)) { goto aF9yb; } goto fp1K9; hg2em: $this->expiration = $config["\x44\x42\x5f\x42\101\103\x4b\125\x50\x5f\105\x58\120\111\x52\101\124\111\117\116"] * 86400; goto xBRvG; wPxQ_: } public function cleanUp() { goto eUnCR; zeqgF: if (!empty($backupDate)) { goto j3Csk; } goto C7Tqq; ZNoYh: OZnzg: goto dyq12; R1ooR: Jl1C4: goto mCA6A; uco2M: $unlinkCount++; goto B9ekT; dyq12: if (!(0 !== strpos($file, $filenamePrefix))) { goto kCOAA; } goto dUKGR; dUKGR: goto DUarW; goto S5Uhv; eJreL: closedir($handle); goto Xpw1k; ve5UK: $backupDate = explode("\x23", $path_parts["\x66\151\x6c\x65\x6e\x61\155\x65"])[1]; goto zeqgF; dVl9L: if (!(false !== ($file = readdir($handle)))) { goto NXFDJ; } goto Tu3uR; JcAn5: goto DUarW; goto mXzRD; EvOLd: j3Csk: goto D63lh; SCsW3: $path_parts = pathinfo($file); goto ve5UK; LQvbm: $unlinkCount = 0; goto CrluY; zCYO4: VYvrm: goto wEqfz; C7Tqq: goto DUarW; goto EvOLd; FDlHT: goto DUarW; goto xJfbF; IXKqS: unlink($this->backup_path . DS . $file); goto uco2M; WnNH3: if (is_dir($this->backup_path) && file_exists($this->backup_path) && ($handle = opendir($this->backup_path))) { goto Jl1C4; } goto r4hti; r4hti: exception("\x66\141\x69\x6c\x65\x64\x20\164\x6f\40\x66\151\156\144\x20{$this->backup_path}"); goto D2iXL; PlND0: goto DUarW; goto ZNoYh; e_TrA: echo $file . "\345\267\xb2\350\xbf\207\xe6\234\237\72\x20" . floor($time / 86400) . "\345\244\xa9\xd\12"; goto IXKqS; xJfbF: GoBnM: goto aL1Sz; D2iXL: goto VYvrm; goto R1ooR; CrluY: DUarW: goto dVl9L; D63lh: if (!(false === strtotime($backupDate))) { goto GoBnM; } goto FDlHT; mXzRD: NXFDJ: goto eJreL; B9ekT: IejgA: goto JcAn5; S5Uhv: kCOAA: goto SCsW3; P4tjr: $filenamePrefix = sprintf("\45\163\43", $conf["\x64\141\x74\x61\142\x61\163\145"]); goto WnNH3; ISB1h: if (!($time >= $this->expiration)) { goto IejgA; } goto e_TrA; aL1Sz: $time = $t_now - strtotime($backupDate); goto ISB1h; mCA6A: $t_now = time(); goto LQvbm; Tu3uR: if (!($file == "\x2e" || $file == "\56\x2e")) { goto OZnzg; } goto PlND0; Xpw1k: return "\346\270\205\xe7\220\x86\345\244\207\344\273\xbd\346\226\x87\344\xbb\266{$unlinkCount}\xe4\270\252"; goto zCYO4; eUnCR: $conf = config("\144\x61\x74\141\x62\141\163\145"); goto P4tjr; wEqfz: } public function backup() { goto fgFMm; cruZ7: $cmd = sprintf("\x6d\171\163\161\154\144\x75\155\x70\40\55\x2d\x73\x6b\151\160\55\154\x6f\143\x6b\55\x74\141\x62\154\145\163\40\55\150\x25\163\40\55\x75\x25\163\40\x2d\x70\45\163\x20\x25\x73\40\76\40\x25\x73", $conf["\150\157\163\164\156\141\155\145"], $conf["\x75\163\145\162\x6e\x61\x6d\145"], $conf["\160\141\x73\163\x77\157\x72\x64"], $conf["\144\141\164\x61\x62\141\x73\145"], $file_sql); goto C9CkK; GhW3V: $file_zip = $this->backup_path . DS . $filename . "\56\x7a\x69\160"; goto fbkLI; e1NNh: goto kUHbS; goto T56V_; d7cPI: $result = system($cmd); goto f33_u; BPsqC: $cmd = sprintf("\42{$this->mysql_dump}\42\40\55\55\163\153\151\160\55\x6c\157\x63\153\x2d\x74\x61\x62\x6c\x65\x73\x20\55\x68\45\x73\40\55\165\x25\163\x20\x2d\160\x25\x73\x20\45\x73\40\x3e\40\x25\163", $conf["\150\x6f\163\164\156\x61\x6d\x65"], $conf["\x75\x73\x65\162\156\x61\155\x65"], $conf["\x70\x61\x73\x73\x77\157\162\x64"], $conf["\x64\141\x74\141\x62\x61\x73\145"], $file_sql); goto yTYEX; fbkLI: if (IS_WIN) { goto JplZh; } goto uoqmK; kNEsb: $result = system($cmd); goto tbGAz; UOpV1: if (IS_WIN) { goto MT9zH; } goto cruZ7; C9CkK: goto Bl5Gk; goto RZ494; f33_u: if (!($result === false)) { goto k2bh9; } goto xp_W0; fgFMm: $conf = config("\x64\141\x74\x61\142\x61\x73\145"); goto B8BJ3; uoqmK: $cmd = "\x7a\x69\x70\x20\55\x72\x20{$file_zip}\40{$file_sql}"; goto e1NNh; B8BJ3: $filename = sprintf("\45\x73\43\45\163", $conf["\x64\141\x74\x61\142\x61\163\145"], date("\131\155\x64")); goto YYVxE; JbbjC: YfWqH: goto GhW3V; T56V_: JplZh: goto CYQXM; Sr9MB: unlink($file_sql); goto DkNCB; RZ494: MT9zH: goto BPsqC; T0mlO: k2bh9: goto Sr9MB; yTYEX: Bl5Gk: goto kNEsb; hbd5q: exception("\x66\x61\x69\154\145\x64\40\x74\x6f\x20\163\171\163\164\x65\155\x20{$cmd}"); goto JbbjC; A1JrM: kUHbS: goto d7cPI; DkNCB: return "\xe5\xa4\207\344\273\xbd\346\210\x90\xe5\212\x9f{$filename}"; goto hVPHL; tbGAz: if (!($result === false)) { goto YfWqH; } goto hbd5q; xp_W0: exception("\x66\141\151\154\x65\144\40\164\x6f\x20\x73\x79\163\164\145\x6d\x20{$cmd}"); goto T0mlO; CYQXM: $cmd = "\42{$this->compressor}\x22\x20\141\40{$file_zip}\x20{$file_sql}"; goto A1JrM; YYVxE: $file_sql = $this->backup_path . DS . $filename . "\56\x73\x71\154"; goto UOpV1; hVPHL: } }

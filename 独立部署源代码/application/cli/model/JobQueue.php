<?php
 namespace app\cli\model; use app\cli\controller\Jobs; use think\Log; use think\Model; use app\Defs; class JobQueue extends Model { protected $pk = "\151\144"; protected $table = "\152\x6f\x62\x5f\161\x75\145\x75\145"; const JOB_STATUS_QUEUED = 1; const JOB_STATUS_RUNNING = 2; const JOB_STATUS_DONE = 3; const JOB_STATUS = array(self::JOB_STATUS_QUEUED => array("\x76\x61\154\165\145" => self::JOB_STATUS_QUEUED, "\x6c\x61\x62\x65\154" => "\xe6\216\x92\351\230\237\xe4\270\xad", "\x63\x6c\x73" => "\144\145\x66\141\x75\x6c\x74"), self::JOB_STATUS_RUNNING => array("\x76\141\154\x75\x65" => self::JOB_STATUS_RUNNING, "\x6c\x61\142\x65\x6c" => "\xe8\xbf\x90\xe8\241\x8c\xe4\270\xad", "\143\154\163" => "\x73\x65\143\157\156\x64\141\162\x79"), self::JOB_STATUS_DONE => array("\x76\141\154\x75\x65" => self::JOB_STATUS_DONE, "\x6c\x61\142\x65\x6c" => "\345\xb7\262\345\xae\x8c\346\210\220", "\x63\154\163" => "\163\x75\x63\143\145\163\163")); const JOB_RESULT_PENDING = "\xe5\xbe\205\xe5\xae\232"; const JOB_RESULT_SUCCESS = "\xe6\210\220\345\x8a\x9f"; const JOB_RESULT_FAILURE = "\xe5\xa4\xb1\350\264\xa5"; public function getExecuteTimeAttr($value) { return $value; } public function getExecuteEndTimeAttr($value) { return $value; } public function failJob($message = '') { return $this->resolveJob(self::JOB_RESULT_FAILURE, $message); } public function resolveJob($result, $message = '') { goto yoXch; Da7jd: $this->result = $result; goto WxoOO; kjtit: $this->save(); goto V6W8Y; yoXch: Log::record("\x52\145\163\157\154\166\x69\156\x67\40\152\x6f\x62\40{$this->id}\x20\x61\x73\40{$result}\72\40{$message}"); goto q3Fgj; WxoOO: $this->execute_end_time = date("\x59\55\155\x2d\x64\x20\110\x3a\x69\x3a\163"); goto kjtit; q3Fgj: $this->status = self::JOB_STATUS_DONE; goto gCy7w; QtdgT: return true; goto d_eU9; V6W8Y: Scheduler::update(["\x6c\141\163\x74\x5f\x72\165\x6e" => date("\x59\x2d\x6d\55\144\40\x48\x3a\151\72\x73")], ["\x69\x64" => $this->scheduler_id]); goto QtdgT; gCy7w: $this->message = truncateString($message, 1024); goto Da7jd; d_eU9: } public function runJob() { goto pA8rL; IlrFb: $callable_name = null; goto FeWo_; NfO3w: return false; goto Hupk0; pA8rL: $jobs = new Jobs(); goto VpOVK; ZHyS3: try { goto NoEPK; DlA4u: return true; goto Gt2am; NoEPK: $resultMsg = call_user_func([$jobs, $func]); goto N1okV; N1okV: $this->resolveJob(self::JOB_RESULT_SUCCESS, $resultMsg); goto DlA4u; Gt2am: } catch (\Exception $e) { $this->failJob($e->getMessage()); return false; } goto vIUNo; FeWo_: if (!(false == is_callable([$jobs, $func], false, $callable_name))) { goto IeZkn; } goto ysF_B; ysF_B: $this->failJob("\x4e\157\x74\x20\x43\141\x6c\x6c\x61\x62\154\145\72\x20" . $callable_name); goto NfO3w; Hupk0: IeZkn: goto ZHyS3; VpOVK: $func = $this->target; goto IlrFb; vIUNo: } }

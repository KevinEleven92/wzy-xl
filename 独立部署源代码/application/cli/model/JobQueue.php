<?php
 namespace app\cli\model; use app\cli\controller\Jobs; use think\Log; use think\Model; use app\Defs; class JobQueue extends Model { protected $pk = "\151\144"; protected $table = "\152\x6f\142\x5f\161\x75\x65\165\145"; const JOB_STATUS_QUEUED = 1; const JOB_STATUS_RUNNING = 2; const JOB_STATUS_DONE = 3; const JOB_STATUS = array(self::JOB_STATUS_QUEUED => array("\x76\141\154\165\x65" => self::JOB_STATUS_QUEUED, "\154\x61\x62\145\154" => "\xe6\216\222\351\230\237\xe4\xb8\255", "\x63\x6c\x73" => "\x64\145\146\x61\165\x6c\164"), self::JOB_STATUS_RUNNING => array("\x76\141\154\x75\x65" => self::JOB_STATUS_RUNNING, "\154\x61\142\145\x6c" => "\350\xbf\x90\xe8\xa1\x8c\344\270\255", "\143\x6c\163" => "\163\x65\x63\x6f\x6e\x64\x61\162\171"), self::JOB_STATUS_DONE => array("\x76\141\154\x75\145" => self::JOB_STATUS_DONE, "\154\141\142\145\x6c" => "\xe5\267\xb2\345\256\x8c\346\210\x90", "\x63\x6c\163" => "\x73\165\143\x63\145\x73\x73")); const JOB_RESULT_PENDING = "\345\276\205\345\xae\232"; const JOB_RESULT_SUCCESS = "\346\210\220\345\x8a\x9f"; const JOB_RESULT_FAILURE = "\xe5\xa4\xb1\350\264\245"; public function getExecuteTimeAttr($value) { return $value; } public function getExecuteEndTimeAttr($value) { return $value; } public function failJob($message = '') { return $this->resolveJob(self::JOB_RESULT_FAILURE, $message); } public function resolveJob($result, $message = '') { goto ID7wi; ID7wi: Log::record("\x52\145\163\157\x6c\166\x69\x6e\x67\40\x6a\x6f\142\x20{$this->id}\40\x61\x73\40{$result}\72\x20{$message}"); goto y9NuB; fCotF: $this->save(); goto d2O4e; d2O4e: Scheduler::update(["\154\141\x73\164\x5f\x72\x75\156" => date("\131\x2d\155\55\144\x20\110\72\151\x3a\x73")], ["\x69\144" => $this->scheduler_id]); goto AxCeI; AxCeI: return true; goto cCnLw; AUKdI: $this->execute_end_time = date("\x59\55\x6d\x2d\x64\40\110\x3a\151\72\163"); goto fCotF; y9NuB: $this->status = self::JOB_STATUS_DONE; goto G4Cn2; GKtFn: $this->result = $result; goto AUKdI; G4Cn2: $this->message = truncateString($message, 1024); goto GKtFn; cCnLw: } public function runJob() { goto X_zrS; X_zrS: $jobs = new Jobs(); goto bOrti; DvRDo: mGHVB: goto UgI6g; UgI6g: try { goto UrSW_; Cwqlw: $this->resolveJob(self::JOB_RESULT_SUCCESS, $resultMsg); goto wSprf; wSprf: return true; goto Ks14v; UrSW_: $resultMsg = call_user_func([$jobs, $func]); goto Cwqlw; Ks14v: } catch (\Exception $e) { $this->failJob($e->getMessage()); return false; } goto jCbh2; terRX: $this->failJob("\116\x6f\164\40\103\x61\x6c\154\x61\x62\154\145\72\x20" . $callable_name); goto piyHU; j92mL: $callable_name = null; goto ssxh2; bOrti: $func = $this->target; goto j92mL; ssxh2: if (!(false == is_callable([$jobs, $func], false, $callable_name))) { goto mGHVB; } goto terRX; piyHU: return false; goto DvRDo; jCbh2: } }

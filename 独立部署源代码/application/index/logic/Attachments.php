<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\index\model\Attachments as AttachmentsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; class Attachments extends Base { const ATTACH_SUBJECT_MODEL_TABLE = 1; const ATTACH_SUBJECT_STANDARD_TABLE = 2; const ATTACH_SUBJECT_ITEM_TABLE = 3; const ATTACH_PROGRESS_LOGS = 4; public static $attachTypeDefs = array(self::ATTACH_SUBJECT_MODEL_TABLE => array("\154\141\142\x65\x6c" => "\346\265\213\350\xaf\204\xe6\xa8\241\xe5\x9e\x8b\350\241\250"), self::ATTACH_SUBJECT_STANDARD_TABLE => array("\x6c\x61\142\x65\x6c" => "\xe6\265\213\xe8\257\204\345\276\227\xe5\210\x86\xe8\xaf\x84\344\274\260\xe8\241\xa8"), self::ATTACH_SUBJECT_ITEM_TABLE => array("\x6c\x61\142\x65\154" => "\xe6\xb5\213\xe8\xaf\204\351\242\x98\xe7\233\xae\350\xa1\250"), self::ATTACH_PROGRESS_LOGS => array("\x6c\x61\x62\145\154" => "\xe8\277\233\xe5\272\246\346\x97\xa5\345\xbf\x97")); protected function __construct() { parent::__construct(); } public function insertAttach($originalName, $saveName, $mimeType, $fileSize, $description, $attachmentType, $externalId, $externalId2 = 0) { goto MRwWR; MRwWR: $attachmentsModel = new AttachmentsModel(); goto sECwe; sECwe: $attachmentsModel->data(["\157\x72\x69\x67\x69\x6e\x61\x6c\137\x6e\141\155\x65" => $originalName, "\163\x61\x76\145\x5f\x6e\141\155\x65" => $saveName, "\x6d\151\x6d\x65\137\x74\x79\160\x65" => $mimeType, "\144\145\163\143\x72\151\x70\x74\x69\x6f\156" => $description, "\x73\x69\x7a\x65" => $fileSize, "\141\164\x74\x61\143\150\x6d\145\x6e\164\x5f\x74\x79\x70\145" => $attachmentType, "\145\170\x74\x65\162\156\141\x6c\137\151\144" => intval($externalId), "\x65\170\164\x65\162\x6e\141\154\137\151\144\x32" => intval($externalId2), "\x65\156\164\145\x72\x65\x64" => Db::raw("\156\157\167\x28\x29")]); goto xj_fv; BuEjC: return $attachmentId; goto YEmsu; xj_fv: $attachmentsModel->save(); goto Il6jL; naYMh: Log::notice("\164\150\x65\40\x6e\145\x77\40\x61\x74\x74\141\143\150\155\x65\x6e\164\40\x69\x64\72\40" . $attachmentId); goto BuEjC; Il6jL: $attachmentId = $attachmentsModel->attachment_id; goto naYMh; YEmsu: } public function getAttaches($attachmentType, $externalId, $externalId2 = 0) { goto Wk6vb; rGo0x: return $attaches; goto dVDeZ; QBod8: $conditions = ["\x61\164\164\141\143\150\155\145\156\164\137\164\x79\160\145" => $attachmentType, "\x65\170\x74\145\162\x6e\x61\x6c\137\x69\144" => $externalId, "\x73\x74\x61\164\x75\x73" => IndexDefs::ATTACHMENT_OK]; goto O5wKT; NVsad: return []; goto UJFXC; A7B4r: $attaches = Db::table("\x61\x74\164\141\143\x68\155\x65\156\x74\x73")->where($conditions)->field("\141\x74\164\141\143\150\155\x65\156\164\137\151\144\54\15\12\40\40\x20\x20\x20\40\40\40\40\40\x20\40\x6f\162\x69\x67\x69\156\141\154\x5f\156\141\x6d\145\54\xd\xa\11\11\x9\163\141\x76\145\137\x6e\x61\155\145\54\xd\12\x9\11\11\155\151\x6d\x65\x5f\164\x79\160\x65\x2c\xd\xa\x9\11\x9\144\x65\163\143\162\x69\160\x74\151\x6f\156\54\xd\12\x9\x9\11\163\x69\172\145\x2c\xd\12\x9\x9\11\141\x74\x74\x61\x63\x68\155\x65\x6e\x74\137\x74\171\x70\x65\54\15\12\11\x9\11\145\170\164\x65\x72\x6e\x61\x6c\137\151\x64\54\xd\12\x9\x9\11\x65\170\164\x65\162\156\141\154\137\x69\144\x32\54\xd\xa\x9\11\x9\x65\x6e\164\145\x72\x65\x64")->order("\141\x74\x74\x61\143\150\x6d\145\x6e\x74\137\151\x64", "\x64\145\163\x63")->select(); goto rGo0x; Jmh9u: $conditions["\x65\x78\x74\145\162\x6e\x61\x6c\x5f\151\144\62"] = $externalId2; goto WCDst; Wk6vb: if (!empty($externalId)) { goto uUUta; } goto NVsad; WCDst: JaMzK: goto A7B4r; O5wKT: if (!$externalId2) { goto JaMzK; } goto Jmh9u; UJFXC: uUUta: goto QBod8; dVDeZ: } public function getAttachById($attachmentId) { return Db::table("\141\164\164\x61\143\x68\155\145\156\164\163")->where(["\x61\164\x74\141\143\150\155\145\x6e\164\x5f\151\144" => $attachmentId])->find(); } public function deleteAttach($attachmentId) { goto IJ9Bv; cH9x9: return true; goto ueyGg; U6tMb: $attachmentId = explode("\54", $attachmentId); goto n3dcX; IJ9Bv: if (!($attachmentId && !is_array($attachmentId))) { goto jRSEf; } goto U6tMb; KLoq2: AttachmentsModel::where($where)->setField("\x73\x74\x61\164\165\x73", IndexDefs::ATTACHMENT_DEL); goto cH9x9; ho387: $where["\141\164\164\141\143\150\155\x65\x6e\x74\137\x69\144"] = count($attachmentId) > 1 ? ["\151\156", $attachmentId] : $attachmentId[0]; goto KLoq2; n3dcX: jRSEf: goto ho387; ueyGg: } public function deleteAttaches($externalId, $attachmentType) { Db::table("\x61\164\164\x61\143\x68\x6d\x65\x6e\164\163")->where(["\x61\x74\164\x61\x63\150\155\145\x6e\x74\x5f\x74\x79\x70\145" => $attachmentType, "\x65\170\164\x65\x72\156\x61\154\x5f\151\144" => $externalId, "\163\x74\141\164\x75\x73" => IndexDefs::ATTACHMENT_OK])->setField("\163\164\x61\164\165\163", IndexDefs::ATTACHMENT_DEL); return true; } public function relateAttaches($attachment_ids, $external_id, $external_id2 = 0) { goto y6GF3; Y1mfr: Tf3qz: goto J2ihj; J2ihj: if (is_array($attachment_ids)) { goto PjauV; } goto ehMGb; vJC2R: $save = []; goto hgduy; f3ebk: PjauV: goto vJC2R; feLo3: return; goto Y1mfr; pkLKP: Db::table("\141\164\164\x61\x63\x68\155\145\x6e\164\163")->where(["\141\164\164\141\143\x68\x6d\145\x6e\164\x5f\x69\x64" => ["\151\156", $attachment_ids]])->update($save); goto TZwn1; hgduy: $save["\145\170\164\x65\162\x6e\x61\x6c\x5f\x69\x64"] = $external_id; goto MX9Gc; MX9Gc: if (!$external_id2) { goto otf4K; } goto pXw0V; s6fQJ: otf4K: goto pkLKP; pXw0V: $save["\x65\x78\164\145\162\156\141\154\x5f\151\x64\x32"] = $external_id2; goto s6fQJ; y6GF3: if (!empty($attachment_ids)) { goto Tf3qz; } goto feLo3; ehMGb: $attachment_ids = explode("\54", $attachment_ids); goto f3ebk; TZwn1: } }

<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\index\model\Attachments as AttachmentsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; class Attachments extends Base { const ATTACH_SUBJECT_MODEL_TABLE = 1; const ATTACH_SUBJECT_STANDARD_TABLE = 2; const ATTACH_SUBJECT_ITEM_TABLE = 3; const ATTACH_PROGRESS_LOGS = 4; public static $attachTypeDefs = array(self::ATTACH_SUBJECT_MODEL_TABLE => array("\154\141\142\145\x6c" => "\346\265\x8b\350\257\204\346\xa8\xa1\345\x9e\213\xe8\241\xa8"), self::ATTACH_SUBJECT_STANDARD_TABLE => array("\x6c\x61\142\145\154" => "\xe6\265\x8b\350\xaf\204\xe5\276\227\345\210\206\350\257\204\xe4\xbc\260\xe8\241\250"), self::ATTACH_SUBJECT_ITEM_TABLE => array("\154\x61\x62\145\154" => "\346\xb5\213\350\257\x84\xe9\242\230\347\x9b\256\xe8\241\250"), self::ATTACH_PROGRESS_LOGS => array("\154\141\142\145\x6c" => "\350\277\x9b\xe5\272\xa6\xe6\227\245\xe5\xbf\x97")); protected function __construct() { parent::__construct(); } public function insertAttach($originalName, $saveName, $mimeType, $fileSize, $description, $attachmentType, $externalId, $externalId2 = 0) { goto Xdy8j; IyxRU: $attachmentsModel->save(); goto suEVL; ZnKgE: Log::notice("\x74\x68\145\40\x6e\145\167\40\x61\x74\x74\141\143\x68\x6d\x65\x6e\164\x20\x69\144\x3a\40" . $attachmentId); goto ILwBT; ILwBT: return $attachmentId; goto V0v4t; ajptX: $attachmentsModel->data(["\157\x72\x69\x67\x69\156\141\154\x5f\156\141\155\x65" => $originalName, "\x73\141\x76\145\137\156\x61\x6d\145" => $saveName, "\155\151\x6d\x65\137\x74\x79\160\x65" => $mimeType, "\x64\145\163\143\162\x69\160\x74\151\x6f\x6e" => $description, "\x73\x69\x7a\145" => $fileSize, "\141\164\164\141\143\x68\155\145\156\164\137\x74\x79\160\x65" => $attachmentType, "\145\170\164\x65\162\x6e\141\154\x5f\x69\144" => intval($externalId), "\145\x78\164\145\162\156\141\154\x5f\151\x64\62" => intval($externalId2), "\145\156\164\145\162\x65\144" => Db::raw("\x6e\157\167\x28\x29")]); goto IyxRU; suEVL: $attachmentId = $attachmentsModel->attachment_id; goto ZnKgE; Xdy8j: $attachmentsModel = new AttachmentsModel(); goto ajptX; V0v4t: } public function getAttaches($attachmentType, $externalId, $externalId2 = 0) { goto r3zcg; JAzHX: $conditions = ["\141\x74\164\x61\143\x68\155\145\x6e\x74\137\x74\171\x70\x65" => $attachmentType, "\145\x78\x74\145\162\x6e\141\154\137\x69\144" => $externalId, "\163\x74\x61\164\x75\163" => IndexDefs::ATTACHMENT_OK]; goto yCqn6; r3zcg: if (!empty($externalId)) { goto bZB5z; } goto VVcEr; pQ8Mu: bZB5z: goto JAzHX; LdfcD: $attaches = Db::table("\x61\x74\x74\141\143\x68\x6d\x65\156\x74\163")->where($conditions)->field("\x61\164\x74\141\143\150\155\145\x6e\x74\137\151\x64\x2c\15\12\x20\x20\x20\40\x20\40\x20\x20\x20\40\x20\40\157\162\x69\147\151\x6e\141\x6c\x5f\x6e\x61\155\x65\54\15\12\11\x9\x9\163\141\x76\145\137\156\x61\155\145\x2c\15\xa\x9\11\11\155\x69\155\145\x5f\x74\171\x70\145\x2c\15\xa\x9\11\x9\144\145\163\x63\162\x69\x70\164\x69\157\156\54\15\xa\11\11\x9\163\151\x7a\145\x2c\xd\12\11\11\11\x61\x74\164\x61\143\150\155\x65\x6e\x74\x5f\164\x79\x70\145\x2c\15\xa\x9\11\11\x65\170\x74\x65\162\x6e\141\154\137\151\x64\x2c\15\xa\x9\11\11\145\x78\164\x65\162\x6e\x61\x6c\x5f\151\144\62\54\15\12\x9\11\11\x65\156\x74\x65\x72\145\x64")->order("\141\x74\164\141\x63\x68\155\x65\x6e\164\137\x69\x64", "\x64\x65\163\x63")->select(); goto rySzl; H1g9H: $conditions["\145\x78\164\x65\x72\156\x61\154\x5f\151\x64\x32"] = $externalId2; goto mO4HO; rySzl: return $attaches; goto vX5YA; mO4HO: W73ML: goto LdfcD; yCqn6: if (!$externalId2) { goto W73ML; } goto H1g9H; VVcEr: return []; goto pQ8Mu; vX5YA: } public function getAttachById($attachmentId) { return Db::table("\141\164\x74\141\143\x68\x6d\x65\156\164\x73")->where(["\141\x74\164\141\143\150\x6d\145\x6e\164\137\x69\x64" => $attachmentId])->find(); } public function deleteAttach($attachmentId) { goto mrxvi; mrxvi: if (!($attachmentId && !is_array($attachmentId))) { goto GXVR_; } goto bAHBd; f8jL0: $where["\141\164\164\141\143\x68\155\x65\156\x74\137\x69\144"] = count($attachmentId) > 1 ? ["\151\156", $attachmentId] : $attachmentId[0]; goto tpJ3e; tpJ3e: AttachmentsModel::where($where)->setField("\163\164\x61\x74\165\163", IndexDefs::ATTACHMENT_DEL); goto Uw_Hm; wUy3E: GXVR_: goto f8jL0; bAHBd: $attachmentId = explode("\x2c", $attachmentId); goto wUy3E; Uw_Hm: return true; goto N12zw; N12zw: } public function deleteAttaches($externalId, $attachmentType) { Db::table("\x61\164\x74\x61\143\150\x6d\x65\156\x74\163")->where(["\141\164\x74\x61\x63\150\x6d\145\156\x74\x5f\164\171\x70\x65" => $attachmentType, "\x65\x78\164\145\x72\156\x61\154\137\x69\x64" => $externalId, "\163\164\x61\x74\x75\163" => IndexDefs::ATTACHMENT_OK])->setField("\x73\164\x61\x74\x75\x73", IndexDefs::ATTACHMENT_DEL); return true; } public function relateAttaches($attachment_ids, $external_id, $external_id2 = 0) { goto An7Np; Witva: Db::table("\x61\x74\164\x61\x63\150\x6d\x65\156\x74\163")->where(["\141\x74\x74\141\x63\150\x6d\x65\x6e\x74\x5f\x69\144" => ["\x69\x6e", $attachment_ids]])->update($save); goto eUGBy; S83yd: $attachment_ids = explode("\x2c", $attachment_ids); goto FR4uL; QazDw: kw2z_: goto Witva; An7Np: if (!empty($attachment_ids)) { goto lUdGn; } goto zsdvo; r8bT_: if (!$external_id2) { goto kw2z_; } goto LDMFy; LDMFy: $save["\145\x78\164\145\162\x6e\141\x6c\137\151\x64\62"] = $external_id2; goto QazDw; Wj7nJ: if (is_array($attachment_ids)) { goto Ia0EW; } goto S83yd; raVPt: $save["\145\x78\x74\145\x72\x6e\141\154\x5f\151\x64"] = $external_id; goto r8bT_; zsdvo: return; goto MxHne; iDf3w: $save = []; goto raVPt; FR4uL: Ia0EW: goto iDf3w; MxHne: lUdGn: goto Wj7nJ; eUGBy: } }

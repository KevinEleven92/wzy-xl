<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\index\model\Attachments as AttachmentsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; class Attachments extends Base { const ATTACH_SUBJECT_MODEL_TABLE = 1; const ATTACH_SUBJECT_STANDARD_TABLE = 2; const ATTACH_SUBJECT_ITEM_TABLE = 3; const ATTACH_PROGRESS_LOGS = 4; public static $attachTypeDefs = array(self::ATTACH_SUBJECT_MODEL_TABLE => array("\x6c\x61\x62\145\x6c" => "\xe6\265\x8b\350\257\x84\346\xa8\241\xe5\236\213\350\241\250"), self::ATTACH_SUBJECT_STANDARD_TABLE => array("\154\x61\x62\x65\x6c" => "\xe6\xb5\x8b\xe8\257\x84\345\xbe\227\xe5\x88\x86\xe8\xaf\x84\344\274\260\xe8\241\250"), self::ATTACH_SUBJECT_ITEM_TABLE => array("\154\x61\x62\x65\154" => "\346\265\213\350\257\204\351\242\230\347\233\256\350\xa1\xa8"), self::ATTACH_PROGRESS_LOGS => array("\x6c\141\x62\x65\x6c" => "\xe8\277\233\xe5\272\xa6\xe6\x97\xa5\xe5\xbf\227")); protected function __construct() { parent::__construct(); } public function insertAttach($originalName, $saveName, $mimeType, $fileSize, $description, $attachmentType, $externalId, $externalId2 = 0) { goto vjJP2; vjJP2: $attachmentsModel = new AttachmentsModel(); goto DynF4; K1UTi: $attachmentId = $attachmentsModel->attachment_id; goto YmO9d; HNpTr: return $attachmentId; goto E3TgJ; DynF4: $attachmentsModel->data(["\157\162\151\147\151\156\141\154\137\x6e\x61\x6d\145" => $originalName, "\x73\x61\x76\x65\137\156\141\155\145" => $saveName, "\155\x69\x6d\x65\137\x74\x79\x70\x65" => $mimeType, "\144\145\163\x63\162\151\160\x74\151\157\156" => $description, "\x73\151\172\145" => $fileSize, "\x61\x74\x74\x61\x63\150\155\x65\x6e\x74\x5f\164\171\x70\145" => $attachmentType, "\145\170\x74\145\x72\x6e\141\x6c\x5f\151\x64" => intval($externalId), "\x65\x78\164\145\x72\x6e\141\x6c\x5f\x69\144\x32" => intval($externalId2), "\x65\156\164\x65\162\x65\144" => Db::raw("\x6e\157\167\x28\51")]); goto HAudi; YmO9d: Log::notice("\x74\x68\x65\x20\x6e\x65\167\x20\x61\164\164\141\143\x68\x6d\x65\156\164\x20\151\144\72\40" . $attachmentId); goto HNpTr; HAudi: $attachmentsModel->save(); goto K1UTi; E3TgJ: } public function getAttaches($attachmentType, $externalId, $externalId2 = 0) { goto aC0BE; X4_Nq: if (!$externalId2) { goto Giag6; } goto UrRBN; aC0BE: if (!empty($externalId)) { goto CZf2d; } goto FkzhT; SCLBY: $attaches = Db::table("\141\164\164\x61\x63\150\x6d\145\156\x74\x73")->where($conditions)->field("\141\x74\x74\x61\x63\150\155\145\x6e\164\137\x69\144\54\15\xa\x20\40\40\x20\x20\x20\x20\x20\40\40\40\x20\157\x72\x69\x67\151\156\141\154\137\156\x61\x6d\145\x2c\xd\xa\x9\11\x9\x73\141\166\x65\x5f\x6e\x61\x6d\145\54\15\12\11\x9\x9\155\x69\x6d\145\x5f\x74\x79\x70\145\54\xd\xa\x9\x9\11\x64\145\163\143\x72\151\160\x74\151\157\156\x2c\xd\12\x9\x9\x9\x73\x69\172\x65\x2c\xd\12\11\x9\11\x61\164\x74\x61\x63\150\155\x65\156\164\x5f\x74\171\160\145\x2c\15\xa\11\x9\11\x65\x78\164\145\162\x6e\141\x6c\137\151\144\54\xd\xa\11\x9\x9\x65\170\x74\x65\x72\156\x61\154\x5f\x69\144\x32\54\15\12\x9\11\x9\x65\x6e\164\145\x72\x65\x64")->order("\x61\164\x74\x61\143\x68\155\x65\156\x74\x5f\151\144", "\x64\x65\x73\143")->select(); goto fKk1w; AbKV4: $conditions = ["\x61\164\x74\141\143\x68\x6d\x65\156\164\137\x74\171\160\145" => $attachmentType, "\x65\x78\164\145\162\156\141\154\x5f\151\144" => $externalId, "\x73\x74\141\164\165\x73" => IndexDefs::ATTACHMENT_OK]; goto X4_Nq; FkzhT: return []; goto wUiKh; owkuS: Giag6: goto SCLBY; UrRBN: $conditions["\145\x78\x74\145\x72\x6e\141\x6c\137\151\144\x32"] = $externalId2; goto owkuS; wUiKh: CZf2d: goto AbKV4; fKk1w: return $attaches; goto zsHhi; zsHhi: } public function getAttachById($attachmentId) { return Db::table("\141\164\164\141\143\150\x6d\145\156\x74\x73")->where(["\141\164\164\x61\x63\150\x6d\145\156\164\137\151\144" => $attachmentId])->find(); } public function deleteAttach($attachmentId) { goto uZNcr; UqyJB: return true; goto vNpPH; FSZEI: $attachmentId = explode("\54", $attachmentId); goto Swt52; oW_7m: $where["\141\x74\164\x61\x63\x68\155\x65\x6e\x74\137\x69\x64"] = count($attachmentId) > 1 ? ["\151\x6e", $attachmentId] : $attachmentId[0]; goto Q6enn; uZNcr: if (!($attachmentId && !is_array($attachmentId))) { goto mZ4G7; } goto FSZEI; Q6enn: AttachmentsModel::where($where)->setField("\163\164\x61\164\165\163", IndexDefs::ATTACHMENT_DEL); goto UqyJB; Swt52: mZ4G7: goto oW_7m; vNpPH: } public function deleteAttaches($externalId, $attachmentType) { Db::table("\141\164\x74\x61\x63\x68\155\x65\156\164\163")->where(["\141\164\x74\141\143\150\x6d\x65\156\x74\137\x74\171\160\145" => $attachmentType, "\x65\x78\x74\145\x72\x6e\141\x6c\x5f\x69\144" => $externalId, "\163\164\x61\164\165\163" => IndexDefs::ATTACHMENT_OK])->setField("\x73\x74\141\x74\165\163", IndexDefs::ATTACHMENT_DEL); return true; } public function relateAttaches($attachment_ids, $external_id, $external_id2 = 0) { goto xv06K; kUy4w: gM_jV: goto ZHkeB; kTWc1: Db::table("\x61\x74\x74\x61\x63\150\x6d\145\x6e\164\163")->where(["\x61\164\164\x61\143\150\x6d\x65\x6e\164\x5f\x69\144" => ["\x69\156", $attachment_ids]])->update($save); goto Q64EN; ALZoW: $save["\145\x78\164\145\162\156\141\x6c\x5f\x69\x64\62"] = $external_id2; goto bmbMU; ZHkeB: $save = []; goto Pxg7N; xv06K: if (!empty($attachment_ids)) { goto aUneA; } goto ZDt2r; bmbMU: X81cC: goto kTWc1; Pxg7N: $save["\145\x78\164\145\162\156\141\154\x5f\x69\144"] = $external_id; goto mswRo; Orx2i: if (is_array($attachment_ids)) { goto gM_jV; } goto J7Gxu; J7Gxu: $attachment_ids = explode("\x2c", $attachment_ids); goto kUy4w; ZDt2r: return; goto MaG8U; MaG8U: aUneA: goto Orx2i; mswRo: if (!$external_id2) { goto X81cC; } goto ALZoW; Q64EN: } }

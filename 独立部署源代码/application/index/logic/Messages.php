<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; class Messages extends Base { const MESSAGE_ADMIN_SYSTEM_CATEGORY = 1; public static $messageCategoryDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\347\263\xbb\347\273\237\351\x80\232\xe7\237\245"); public static $messageCategoryHtmlDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\74\163\160\141\156\x20\x63\x6c\x61\x73\x73\75\x22\142\141\144\147\145\40\142\x61\x64\x67\145\x2d\x70\162\151\155\x61\162\x79\x22\x3e\xe7\263\xbb\347\273\237\351\200\232\xe7\237\245\74\57\x73\x70\x61\156\x3e"); protected function __construct() { parent::__construct(); } public function load($adminId, $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto wFJyG; frEAm: $conditions["\141\x64\x6d\x69\156\137\x69\144"] = $adminId; goto pnEot; LODS6: foreach ($records as &$record) { $record["\x63\150\145\x63\x6b\145\x64"] = true; nCheU: } goto Cf3nw; IEQLS: $records = Db::table("\155\145\163\163\x61\147\x65\163")->where($conditions)->limit($limit)->order($order)->field(["\x6d\x65\x73\163\141\x67\145\137\x69\144", "\141\x64\x6d\151\156\x5f\x69\x64", "\164\151\164\154\x65", "\x63\x6f\156\x74\145\x6e\x74", "\x63\x61\x74\145\x67\157\x72\171", "\x69\163\137\x72\145\141\144", "\x72\145\141\x64\137\164\x69\x6d\x65", "\x65\x6e\164\145\x72\145\144"])->select(); goto LODS6; R9xDx: LqYQv: goto U3fvb; vn6bI: $totalCount = Db::table("\155\x65\x73\163\141\147\x65\163")->where($conditions)->count(); goto IEQLS; Cf3nw: WKsBf: goto faEXW; pnEot: t0N0c: goto vn6bI; uE_P0: $order = "\155\x65\163\163\141\147\145\x5f\151\144\x20\144\145\163\143"; goto wzn8k; wzn8k: goto Wlzki; goto R9xDx; UuTGi: $conditions = []; goto YRo7W; YRo7W: if (!$adminId) { goto t0N0c; } goto frEAm; wFJyG: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto rbU1E; rbU1E: if ($sort == "\x63\141\x74\x65\147\x6f\x72\171") { goto LqYQv; } goto uE_P0; Xj1T1: Wlzki: goto UuTGi; U3fvb: $order = "\143\x61\x74\145\x67\x6f\x72\171\40" . $order; goto Xj1T1; faEXW: return ["\x74\157\164\141\x6c" => $totalCount, "\162\x6f\167\x73" => $records]; goto JXK7S; JXK7S: } public function add($category, $title, $content, $adminId = 0) { goto suY7X; ZpAH3: $messageId = Db::table("\x6d\145\x73\x73\141\147\x65\163")->insertGetId($datas); goto EapUV; EapUV: return $messageId; goto pluzQ; suY7X: $datas = ["\141\x64\155\151\x6e\137\x69\x64" => $adminId, "\x74\151\164\x6c\145" => mb_truncateString($title, 200), "\x63\x6f\x6e\x74\x65\x6e\164" => $content, "\143\141\164\145\147\x6f\162\x79" => $category]; goto ZpAH3; pluzQ: } public function markRead($messageId) { Db::table("\x6d\145\163\163\x61\x67\145\x73")->where(["\155\x65\163\163\x61\147\x65\137\151\x64" => $messageId, "\x69\163\x5f\162\x65\141\144" => 0])->update(["\151\163\137\162\145\x61\x64" => 1, "\162\x65\x61\x64\x5f\164\x69\x6d\x65" => date("\x59\x2d\x6d\x2d\144\x20\x48\72\x69\x3a\163")]); return true; } public function markAllRead($adminId) { goto ru534; xMvwj: Db::table("\x6d\145\x73\163\x61\x67\x65\x73")->where($conditions)->update(["\151\x73\x5f\162\x65\141\x64" => 1, "\x72\145\141\144\x5f\x74\x69\x6d\x65" => Db::raw("\156\x6f\x77\50\x29")]); goto R9j_Y; dNqe1: $conditions["\x61\x64\x6d\x69\156\137\151\x64"] = $adminId; goto AUCZj; pPnzz: if (!$adminId) { goto uQyrn; } goto dNqe1; ru534: $conditions = ["\151\163\x5f\x72\145\141\144" => 0]; goto pPnzz; AUCZj: uQyrn: goto xMvwj; R9j_Y: } public function markSelectedRead($messageIds) { Db::table("\155\145\x73\x73\x61\147\x65\163")->where(["\x6d\145\x73\163\141\x67\145\x5f\x69\x64" => ["\x69\156", $messageIds], "\151\x73\137\x72\145\141\x64" => 0])->update(["\x69\163\137\x72\145\141\144" => 1, "\x72\145\141\x64\137\164\x69\x6d\145" => Db::raw("\156\x6f\x77\50\x29")]); } public function getInfos($messageId) { $infos = Db::table("\155\x65\x73\163\141\147\145\163")->where("\155\x65\163\163\141\147\x65\x5f\x69\144", $messageId)->field(true)->find(); return $infos; } public function unreadCount($adminId) { goto BOgg6; mFHLw: if (!$adminId) { goto ez_Pc; } goto epnYd; a_Gg8: return $count; goto vJfWh; nmHHj: ez_Pc: goto xs4zJ; xs4zJ: $count = Db::table("\155\145\163\x73\141\147\x65\x73")->where($conditions)->count(); goto a_Gg8; BOgg6: $conditions = ["\x69\x73\x5f\x72\145\x61\x64" => 0]; goto mFHLw; epnYd: $conditions["\141\144\x6d\151\156\x5f\x69\x64"] = $adminId; goto nmHHj; vJfWh: } }

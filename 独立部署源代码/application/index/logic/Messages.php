<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; class Messages extends Base { const MESSAGE_ADMIN_SYSTEM_CATEGORY = 1; public static $messageCategoryDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\xe7\xb3\xbb\xe7\273\x9f\351\x80\x9a\347\x9f\xa5"); public static $messageCategoryHtmlDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\74\163\160\x61\156\40\x63\x6c\141\x73\163\x3d\42\142\x61\x64\147\145\40\x62\x61\144\x67\x65\x2d\160\x72\x69\x6d\x61\162\171\42\76\xe7\263\273\xe7\xbb\x9f\351\200\x9a\347\237\245\74\57\163\160\x61\156\x3e"); protected function __construct() { parent::__construct(); } public function load($adminId, $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto QoSi0; apNBp: return ["\164\157\164\141\x6c" => $totalCount, "\x72\x6f\167\x73" => $records]; goto dp5UQ; vpjjc: CVWXX: goto Cw41z; v3Isv: $records = Db::table("\x6d\x65\x73\163\x61\147\x65\x73")->where($conditions)->limit($limit)->order($order)->field(["\x6d\x65\x73\x73\141\x67\145\x5f\x69\144", "\x61\144\x6d\151\x6e\137\x69\144", "\x74\151\164\x6c\x65", "\x63\157\156\164\145\156\x74", "\x63\141\164\x65\x67\x6f\162\x79", "\151\x73\137\162\145\141\x64", "\162\145\141\x64\x5f\164\151\x6d\x65", "\x65\x6e\164\145\x72\145\x64"])->select(); goto Cjnfv; rfpEu: $conditions["\x61\x64\155\x69\156\137\151\144"] = $adminId; goto eQmRE; pqQHA: if ($sort == "\x63\x61\164\x65\x67\x6f\162\x79") { goto CVWXX; } goto qmzbp; o4JaA: oc0qm: goto j0Khy; QoSi0: $limit = ($page - 1) * $rows . "\54" . $rows; goto pqQHA; nGKbo: $totalCount = Db::table("\x6d\x65\x73\x73\141\x67\x65\x73")->where($conditions)->count(); goto v3Isv; Cw41z: $order = "\143\141\x74\x65\x67\x6f\162\171\40" . $order; goto o4JaA; eQmRE: VSQ1q: goto nGKbo; ZTQEm: kkM6g: goto apNBp; qmzbp: $order = "\x6d\x65\163\x73\x61\147\x65\137\x69\x64\x20\x64\x65\163\x63"; goto toaA5; Cjnfv: foreach ($records as &$record) { $record["\143\x68\145\x63\153\x65\x64"] = true; ZWtq3: } goto ZTQEm; cub9x: if (!$adminId) { goto VSQ1q; } goto rfpEu; toaA5: goto oc0qm; goto vpjjc; j0Khy: $conditions = []; goto cub9x; dp5UQ: } public function add($category, $title, $content, $adminId = 0) { goto Pk9wp; SzifP: return $messageId; goto O2v26; Pk9wp: $datas = ["\x61\144\x6d\x69\x6e\137\151\x64" => $adminId, "\164\x69\164\154\145" => mb_truncateString($title, 200), "\143\157\156\164\145\156\x74" => $content, "\x63\x61\164\x65\x67\x6f\x72\x79" => $category]; goto IlpmT; IlpmT: $messageId = Db::table("\155\145\x73\x73\x61\147\x65\x73")->insertGetId($datas); goto SzifP; O2v26: } public function markRead($messageId) { Db::table("\155\145\x73\x73\x61\x67\145\163")->where(["\155\x65\163\x73\141\x67\145\x5f\x69\x64" => $messageId, "\151\x73\137\x72\x65\141\144" => 0])->update(["\151\163\x5f\162\x65\141\x64" => 1, "\162\x65\141\144\x5f\164\151\155\x65" => date("\131\x2d\155\x2d\x64\40\x48\x3a\151\72\x73")]); return true; } public function markAllRead($adminId) { goto WnluA; WnluA: $conditions = ["\x69\x73\137\162\145\141\144" => 0]; goto eAM9i; H9AW8: dV68d: goto kw_JZ; eAM9i: if (!$adminId) { goto dV68d; } goto kb77q; kw_JZ: Db::table("\x6d\x65\163\x73\x61\x67\145\163")->where($conditions)->update(["\151\163\137\162\x65\x61\144" => 1, "\x72\145\x61\x64\137\164\x69\155\145" => Db::raw("\x6e\157\x77\x28\51")]); goto YtLKv; kb77q: $conditions["\141\x64\155\x69\156\x5f\x69\x64"] = $adminId; goto H9AW8; YtLKv: } public function markSelectedRead($messageIds) { Db::table("\x6d\145\x73\x73\x61\x67\x65\x73")->where(["\155\145\x73\163\141\x67\145\137\x69\x64" => ["\151\x6e", $messageIds], "\x69\x73\137\x72\145\x61\144" => 0])->update(["\151\x73\137\162\x65\141\144" => 1, "\162\x65\141\x64\137\164\151\x6d\145" => Db::raw("\x6e\x6f\167\50\51")]); } public function getInfos($messageId) { $infos = Db::table("\x6d\145\163\x73\x61\147\145\163")->where("\x6d\145\x73\x73\141\x67\145\x5f\x69\x64", $messageId)->field(true)->find(); return $infos; } public function unreadCount($adminId) { goto wRfT9; U6g1e: $count = Db::table("\155\x65\x73\163\141\x67\x65\x73")->where($conditions)->count(); goto D5vz8; D5vz8: return $count; goto uEbXe; TRREe: jpddG: goto U6g1e; wRfT9: $conditions = ["\151\x73\137\162\145\x61\x64" => 0]; goto OZLc5; OZLc5: if (!$adminId) { goto jpddG; } goto shbld; shbld: $conditions["\x61\x64\x6d\x69\156\x5f\151\x64"] = $adminId; goto TRREe; uEbXe: } }

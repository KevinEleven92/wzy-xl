<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class Survey extends Base { public function __construct() { } public function loadSurvey($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto s_5fG; sE3wz: $conditions["\x64\x65\x6c\145\x74\145\137\x66\154\141\147"] = $search["\x64\145\154\x65\164\145\137\x66\x6c\141\x67"]; goto jrgmP; s_5fG: if ($sort == "\x73\164\141\164\x75\x73") { goto wbnTX; } goto QvYCK; bf2Ao: fusmA: goto Pic5E; UO2N4: foreach ($records as &$record) { goto HI7uo; k3FL0: $record["\142\x61\156\x6e\x65\162"] = generateThumbnailUrl($record["\142\141\x6e\156\x65\x72"], 100); goto NWnlB; NWnlB: $record["\143\x6f\x6d\x70\x6c\145\x74\x65\x64\137\143\157\165\x6e\164"] = Db::table("\163\165\x72\x76\145\171\x5f\x6f\162\144\x65\162")->where(["\x73\165\x72\166\x65\x79\x5f\151\x64" => $record["\x69\x64"], "\146\151\156\x69\163\x68\145\144" => 1])->count(); goto hWSXI; tU9_V: Ad85c: goto NxLFH; KpBci: $subjectIds = explode("\54", $record["\x73\x75\x62\152\145\143\x74\x73"]); goto lA9w5; qEqMS: QpMql: goto n1GSs; NxLFH: $record["\163\165\x62\152\145\x63\164\x73\137\156\x61\x6d\x65\163"] = $subjectNames; goto k3FL0; BbZgP: $record["\144\x65\163\143\x72\x69\160\164\151\x6f\156"] = ellipsisString($record["\x64\x65\x73\143\x72\151\160\x74\x69\157\x6e"], 32); goto qEqMS; lA9w5: foreach ($subjectIds as $subjectId) { goto qLsIp; BOcof: EQfSz: goto lnrNC; qLsIp: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto HC1VA; I3Yt8: $subjectNames .= "\74\x62\162\x20\x2f\x3e"; goto MKF1I; PZPf5: $subjectNames .= $subjectName; goto Ek7__; Ek7__: ZmT3h: goto BOcof; nPTIz: if (!$subjectNames) { goto gb4sg; } goto I3Yt8; HC1VA: if (!$subjectName) { goto ZmT3h; } goto nPTIz; MKF1I: gb4sg: goto PZPf5; lnrNC: } goto tU9_V; hWSXI: $record["\x77\141\x72\x6e\x69\x6e\147\137\x63\x6f\x75\x6e\x74"] = Db::table("\x73\165\x62\x6a\145\143\164\x5f\157\x72\x64\x65\162")->where("\x73\x75\x72\x76\x65\171\x5f\157\162\x64\145\x72\x5f\151\x64", "\151\156", function ($query) use($record) { $query->table("\x73\x75\x72\166\x65\x79\x5f\x6f\x72\144\x65\x72")->where(["\163\165\162\x76\145\x79\x5f\x69\x64" => $record["\151\144"], "\146\x69\156\x69\163\x68\x65\144" => 1])->field("\151\x64"); })->where("\167\x61\x72\156\151\156\147\137\154\x65\166\x65\154", "\76", Defs::MEASURE_WARNING_GREEN_LEVEL)->group("\x73\165\x72\166\x65\171\137\x6f\x72\x64\x65\x72\x5f\x69\x64")->count(); goto BbZgP; HI7uo: $subjectNames = ''; goto KpBci; n1GSs: } goto N39yo; o3QTB: $subjectPairs = []; goto o0YqK; o0YqK: Ebnpn: goto CmOGZ; M59Yh: sPkR4: goto j8_dl; yiFXV: $conditions = []; goto rkRIN; avyCk: goto w141k; goto S6PzG; N39yo: GLFNh: goto ebohw; twKjs: $conditions["\x73\x74\x61\x74\x75\163"] = $search["\x73\x74\x61\x74\x75\163"]; goto dN7zk; NZ2OB: OfZh6: goto Kt61k; ebohw: return ["\x74\x6f\164\141\154" => $totalCount, "\x72\x6f\x77\163" => $records]; goto cvnSL; RsK77: $order = "\x73\164\x61\x74\165\x73\40{$order}"; goto tJ2qN; Kt61k: $conditions["\144\x65\154\145\x74\x65\x5f\146\154\x61\147"] = 0; goto M59Yh; S6PzG: wbnTX: goto RsK77; XSp1b: if (!empty($subjectPairs)) { goto Ebnpn; } goto o3QTB; CmOGZ: $totalCount = Db::table("\163\x75\162\x76\x65\x79")->where($conditions)->count(); goto BCaRs; QvYCK: $order = "\151\x64\x20\x64\x65\x73\x63"; goto avyCk; BCaRs: $records = Db::table("\x73\165\x72\166\145\171")->where($conditions)->page($page, $rows)->order($order)->field(true)->select(); goto UO2N4; EC6j3: $subjectPairs = Db::table("\x73\165\x62\152\x65\x63\x74")->where([])->column("\x6e\x61\x6d\145", "\151\144"); goto XSp1b; Pic5E: if (empty($search["\x73\164\141\164\x75\x73"])) { goto wX0tZ; } goto twKjs; jrgmP: goto sPkR4; goto NZ2OB; hUEmH: $conditions["\156\x61\x6d\x65"] = ["\x6c\x69\153\x65", "\x25" . $search["\156\141\x6d\145"] . "\45"]; goto bf2Ao; dN7zk: wX0tZ: goto EC6j3; rkRIN: if (!isset($search["\144\145\x6c\145\164\145\137\146\x6c\x61\147"])) { goto OfZh6; } goto sE3wz; j8_dl: if (empty($search["\x6e\141\x6d\145"])) { goto fusmA; } goto hUEmH; tJ2qN: w141k: goto yiFXV; cvnSL: } public function getDefaultSurvey() { return ["\x6e\x61\x6d\x65" => '', "\142\141\x6e\x6e\x65\x72" => '', "\x64\x65\x73\143\162\x69\x70\164\151\157\156" => '', "\x73\165\142\152\145\143\164\x73" => '', "\143\x66\147\x5f\146\162\x65\x65" => 1, "\143\146\147\137\145\156\x74\145\x72\137\160\x65\162\x73\x6f\156\141\154\x5f\x64\x61\164\x61" => 1, "\x63\146\147\x5f\x70\145\162\x73\157\x6e\141\154\137\144\x61\164\x61" => "\156\141\x6d\145\54\x73\x65\x78\54\141\x67\x65\54\x6d\157\142\151\x6c\145", "\x63\146\147\x5f\166\151\145\x77\x5f\x72\145\x70\x6f\162\x74" => 0, "\x73\164\141\164\165\x73" => IndexDefs::ENTITY_DRAFT_STATUS]; } public function getSurvey($id) { $survey = Db::table("\163\165\162\x76\x65\x79")->where("\x69\144", $id)->field("\52")->find(); return $survey; } public function saveSurvey($id, $formData) { goto NESsn; ZznOs: uzwBQ: goto xLOpU; KAOBC: $model = SurveyModel::get($id); goto v1P62; n45zs: hwQN3: goto CGXQ2; ReB40: EEpQw: goto wlAdF; aAPeH: if (!$banner) { goto uzwBQ; } goto ZSo90; iYqeI: if (empty($id)) { goto hwQN3; } goto z4vtw; BHOYT: L_wSQ: goto oR2B8; IErS4: goto EEpQw; goto BHOYT; CGXQ2: OperationLogs::I()->subjecCombinationtLog("\xe6\226\xb0\345\xa2\x9e\346\x99\xae\xe6\x9f\xa5\40\x2d\x20{$model->name}", beautifyLogArray($formData, [], "\163\165\x72\166\145\171"), OperationLogs::OPT_ADD_TYPE, $model->id); goto EcDC9; p4Q9U: BhlSj: goto IErS4; xLOpU: $formData["\155\x74\151\x6d\145"] = date("\131\x2d\x6d\55\x64\x20\110\72\x69\x3a\x73"); goto LPcMe; wlAdF: $banner = autoGenerateBannerImage($formData["\156\141\x6d\x65"], $formData["\x62\141\x6e\156\145\162"]); goto aAPeH; oR2B8: $model = new SurveyModel(); goto ReB40; WuDlC: $originals = Db::table("\163\x75\x62\x6a\145\143\x74\x5f\143\x6f\x6d\x62\x69\x6e\x61\164\x69\x6f\x6e")->where(["\151\144" => $id])->field(true)->find(); goto KAOBC; YRmxv: exception("\xe6\x97\xa0\346\xb3\x95\xe6\x89\276\345\210\xb0\350\xaf\245\351\207\x8f\xe8\241\xa8"); goto p4Q9U; ZSo90: $formData["\142\x61\x6e\156\145\x72"] = $banner; goto ZznOs; NESsn: if (empty($id)) { goto L_wSQ; } goto WuDlC; QZ052: goto KmT3v; goto n45zs; EcDC9: KmT3v: goto DdMqW; oWG2k: $model->allowField(true)->save(); goto iYqeI; LPcMe: $model->data($formData); goto oWG2k; z4vtw: OperationLogs::I()->subjecCombinationtLog("\xe4\xbf\xae\xe6\224\271\346\231\256\xe6\x9f\xa5\40\55\40{$model->name}", beautifyLogArray($formData, $originals, "\163\x75\x72\166\x65\x79"), OperationLogs::OPT_UPDATE_TYPE, $id); goto QZ052; v1P62: if ($model) { goto BhlSj; } goto YRmxv; DdMqW: } public function deleteSurvey($id) { goto LmVc6; ulS0h: $model->data(["\144\145\154\x65\164\x65\137\146\x6c\141\147" => 1]); goto oCOft; B1m35: if ($model) { goto oWXSH; } goto Vc96b; LmVc6: $model = SurveyModel::get($id); goto B1m35; x0N3T: oWXSH: goto ulS0h; oCOft: $model->save(); goto E98NV; Vc96b: exception("\xe6\227\240\xe6\263\x95\xe6\211\xbe\xe5\210\xb0\350\257\xa5\xe9\x87\x8f\xe8\xa1\xa8"); goto x0N3T; E98NV: } public function deleteForceSurvey($id) { goto ld3AI; R6mKd: Db::table("\163\x75\x72\x76\x65\171")->where(["\151\x64" => $id])->delete(); goto o30lV; ld3AI: $orderIds = Db::table("\x73\165\x72\166\x65\x79\137\157\162\x64\145\162")->where(["\x73\x75\162\x76\145\171\x5f\x69\x64" => $id])->column("\151\x64"); goto w9zS4; nJa5y: Db::table("\163\165\162\x76\x65\x79\x5f\x6f\162\144\145\x72")->where(["\163\165\x72\x76\x65\x79\x5f\151\144" => $id])->delete(); goto CzFrQ; Nrmsc: Db::table("\x73\x75\142\152\x65\x63\164\137\x6f\162\144\145\x72")->where(["\x73\165\x72\166\145\x79\137\x6f\162\x64\145\162\x5f\x69\x64" => ["\151\x6e", $orderIds]])->delete(); goto Z1Chk; w9zS4: if (!$orderIds) { goto UItPg; } goto Nrmsc; Z1Chk: UItPg: goto nJa5y; CzFrQ: Db::table("\163\165\162\x76\x65\171\137\x6f\162\x67\x61\x6e\x69\172\x61\x74\151\x6f\x6e")->where(["\163\x75\x72\x76\x65\171\x5f\151\x64" => $id])->delete(); goto R6mKd; o30lV: } }

<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class Survey extends Base { public function __construct() { } public function loadSurvey($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto sscDD; jBUnX: $order = "\x69\x64\x20\x64\x65\x73\143"; goto OvMFQ; F1eR0: $totalCount = Db::table("\x73\x75\162\x76\145\171")->where($conditions)->count(); goto N_YZl; tOPbU: $conditions["\x73\164\x61\164\x75\x73"] = $search["\x73\164\141\164\x75\163"]; goto aj6LC; o9Pse: goto CoGP2; goto ZPqMa; WCcct: CoGP2: goto ixShg; jQuDh: if (!empty($subjectPairs)) { goto GdeiI; } goto DbF1a; sscDD: if ($sort == "\x73\x74\141\x74\165\x73") { goto H3z4U; } goto jBUnX; OvMFQ: goto axdKt; goto MuNxa; ixShg: if (empty($search["\156\141\x6d\145"])) { goto Z09wf; } goto lmRkY; fgJsL: $conditions = []; goto n6VTA; tCswF: S__LV: goto Bk2xu; fkdlk: foreach ($records as &$record) { goto SUbsb; b8KSv: Xy6iR: goto O9ttz; SUbsb: $subjectNames = ''; goto SsTFL; i2Hi6: $record["\143\x6f\155\160\x6c\145\x74\145\x64\137\143\x6f\165\156\164"] = Db::table("\x73\x75\x72\166\x65\171\x5f\x6f\162\144\145\x72")->where(["\163\x75\162\x76\145\x79\x5f\151\x64" => $record["\x69\144"], "\x66\x69\x6e\x69\x73\x68\x65\144" => 1])->count(); goto hP0yh; hP0yh: $record["\x77\141\x72\156\x69\156\x67\x5f\x63\157\165\156\164"] = Db::table("\x73\x75\x62\152\x65\143\x74\x5f\157\162\x64\x65\x72")->where("\x73\165\162\166\145\171\137\157\162\144\145\162\x5f\x69\144", "\x69\x6e", function ($query) use($record) { $query->table("\x73\165\162\x76\x65\171\137\157\162\144\x65\162")->where(["\163\x75\162\x76\145\171\x5f\151\x64" => $record["\151\x64"], "\146\151\x6e\x69\163\x68\145\x64" => 1])->field("\151\144"); })->where("\167\x61\x72\x6e\x69\156\x67\x5f\x6c\145\x76\x65\154", "\x3e", Defs::MEASURE_WARNING_GREEN_LEVEL)->group("\163\x75\162\166\145\x79\x5f\x6f\162\x64\x65\162\137\x69\x64")->count(); goto uPmYI; SsTFL: $subjectIds = explode("\54", $record["\x73\x75\142\152\145\143\164\x73"]); goto rxHmI; O9ttz: $record["\163\165\x62\x6a\x65\143\164\163\x5f\156\x61\x6d\x65\163"] = $subjectNames; goto f0IN0; uPmYI: $record["\x64\145\x73\x63\162\151\160\x74\151\x6f\156"] = ellipsisString($record["\144\145\x73\143\162\151\160\x74\151\157\x6e"], 32); goto HiW6v; f0IN0: $record["\x62\141\156\156\145\x72"] = generateThumbnailUrl($record["\142\x61\156\156\145\x72"], 100); goto i2Hi6; rxHmI: foreach ($subjectIds as $subjectId) { goto kWfaz; ULBX1: X2oIT: goto WQLND; nfibO: kMBvx: goto O2Juh; EozUn: if (!$subjectName) { goto X2oIT; } goto sNISF; WQLND: SqNT5: goto b6IJy; O2Juh: $subjectNames .= $subjectName; goto ULBX1; sNISF: if (!$subjectNames) { goto kMBvx; } goto kvztG; kvztG: $subjectNames .= "\x3c\142\162\40\57\x3e"; goto nfibO; kWfaz: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto EozUn; b6IJy: } goto b8KSv; HiW6v: Z4HtA: goto ebkLJ; ebkLJ: } goto tCswF; yj5Et: $subjectPairs = Db::table("\x73\x75\142\152\145\143\x74")->where([])->column("\x6e\141\155\145", "\x69\144"); goto jQuDh; CrXc2: Z09wf: goto Ns2up; n6VTA: if (!isset($search["\144\145\154\145\164\145\x5f\146\x6c\x61\x67"])) { goto suxIp; } goto Er84h; aj6LC: MBusR: goto yj5Et; bQIlN: axdKt: goto fgJsL; oaE9n: $order = "\x73\x74\x61\164\165\x73\40{$order}"; goto bQIlN; Bk2xu: return ["\164\157\x74\141\x6c" => $totalCount, "\x72\x6f\167\163" => $records]; goto WmUkl; Ns2up: if (empty($search["\x73\x74\x61\x74\165\163"])) { goto MBusR; } goto tOPbU; lmRkY: $conditions["\x6e\x61\x6d\x65"] = ["\154\x69\x6b\145", "\45" . $search["\x6e\x61\155\x65"] . "\x25"]; goto CrXc2; ZPqMa: suxIp: goto UEhKs; UEhKs: $conditions["\x64\x65\154\x65\164\x65\137\146\x6c\141\147"] = 0; goto WCcct; hwn9V: GdeiI: goto F1eR0; DbF1a: $subjectPairs = []; goto hwn9V; MuNxa: H3z4U: goto oaE9n; N_YZl: $records = Db::table("\x73\x75\x72\x76\145\171")->where($conditions)->page($page, $rows)->order($order)->field(true)->select(); goto fkdlk; Er84h: $conditions["\x64\145\154\x65\164\x65\x5f\x66\x6c\x61\147"] = $search["\144\145\154\x65\164\x65\137\x66\154\x61\147"]; goto o9Pse; WmUkl: } public function getDefaultSurvey() { return ["\x6e\141\x6d\x65" => '', "\142\141\x6e\x6e\145\162" => '', "\x64\145\x73\x63\162\x69\160\164\151\157\x6e" => '', "\x73\165\x62\x6a\145\x63\164\163" => '', "\x63\146\x67\x5f\x66\162\145\145" => 1, "\143\x66\x67\137\145\156\164\x65\x72\137\160\x65\162\163\157\x6e\x61\154\x5f\144\141\x74\x61" => 1, "\x63\146\147\x5f\x70\x65\x72\163\x6f\x6e\x61\x6c\137\144\x61\164\141" => "\156\141\x6d\145\54\x73\145\x78\54\x61\147\x65\x2c\x6d\x6f\x62\x69\x6c\145", "\x63\146\x67\x5f\x76\x69\145\x77\x5f\162\x65\x70\157\162\164" => 0, "\x73\x74\141\x74\165\163" => IndexDefs::ENTITY_DRAFT_STATUS]; } public function getSurvey($id) { $survey = Db::table("\x73\165\x72\x76\x65\x79")->where("\151\x64", $id)->field("\52")->find(); return $survey; } public function saveSurvey($id, $formData) { goto UKZER; cmUNp: $model = SurveyModel::get($id); goto IfD3y; BcPgi: ft9Ab: goto RWz53; b4CER: adXG3: goto IXPSo; IXPSo: $model = new SurveyModel(); goto xfLbr; XQ9Zc: $model->allowField(true)->save(); goto bWPu9; mMcqh: $model->data($formData); goto XQ9Zc; RWz53: goto esD6Q; goto b4CER; HBdkQ: $formData["\x62\141\156\156\x65\x72"] = $banner; goto CeCPc; rEUuF: UiS8g: goto Cf282; IKCup: if (!$banner) { goto KBXu8; } goto HBdkQ; N8ske: goto S1vOV; goto rEUuF; Cf282: OperationLogs::I()->subjecCombinationtLog("\xe6\x96\260\xe5\xa2\236\xe6\x99\xae\xe6\237\245\x20\55\40{$model->name}", beautifyLogArray($formData, [], "\x73\165\162\166\x65\171"), OperationLogs::OPT_ADD_TYPE, $model->id); goto gyeEm; gyeEm: S1vOV: goto h5O6b; inVCU: OperationLogs::I()->subjecCombinationtLog("\344\xbf\xae\xe6\224\271\xe6\x99\256\346\237\xa5\40\55\x20{$model->name}", beautifyLogArray($formData, $originals, "\163\x75\162\x76\x65\171"), OperationLogs::OPT_UPDATE_TYPE, $id); goto N8ske; tflGw: $originals = Db::table("\163\165\x62\152\145\x63\x74\x5f\143\157\155\142\151\156\x61\164\151\157\156")->where(["\x69\x64" => $id])->field(true)->find(); goto cmUNp; V8x_S: $formData["\155\x74\151\155\145"] = date("\131\55\155\x2d\144\x20\110\72\151\x3a\x73"); goto mMcqh; xfLbr: esD6Q: goto ljSHu; CeCPc: KBXu8: goto V8x_S; bWPu9: if (empty($id)) { goto UiS8g; } goto inVCU; ljSHu: $banner = autoGenerateBannerImage($formData["\x6e\141\x6d\x65"], $formData["\x62\x61\156\x6e\145\162"]); goto IKCup; uDNv7: exception("\xe6\227\xa0\346\263\x95\346\x89\276\345\x88\260\350\xaf\xa5\351\207\217\350\241\250"); goto BcPgi; UKZER: if (empty($id)) { goto adXG3; } goto tflGw; IfD3y: if ($model) { goto ft9Ab; } goto uDNv7; h5O6b: } public function deleteSurvey($id) { goto nOKr8; eNdaD: $model->data(["\144\145\x6c\x65\164\145\137\146\x6c\x61\x67" => 1]); goto GhfC9; AOXZv: oIKP2: goto eNdaD; GhfC9: $model->save(); goto v6er9; mbW1l: if ($model) { goto oIKP2; } goto UN5gX; UN5gX: exception("\346\x97\240\346\xb3\225\346\x89\276\345\x88\260\350\257\xa5\xe9\x87\x8f\xe8\xa1\xa8"); goto AOXZv; nOKr8: $model = SurveyModel::get($id); goto mbW1l; v6er9: } public function deleteForceSurvey($id) { goto Q7sLg; KLtpT: Db::table("\x73\165\x72\x76\145\171\137\157\162\x67\x61\x6e\151\x7a\x61\164\151\157\x6e")->where(["\163\x75\x72\x76\145\171\x5f\151\x64" => $id])->delete(); goto lsbry; hHdRd: Db::table("\163\x75\142\x6a\145\x63\x74\137\157\162\x64\x65\x72")->where(["\163\x75\162\166\145\171\137\x6f\x72\x64\145\x72\x5f\x69\144" => ["\x69\x6e", $orderIds]])->delete(); goto XRBPo; Q7sLg: $orderIds = Db::table("\163\165\x72\x76\x65\x79\x5f\157\x72\144\145\162")->where(["\163\x75\x72\x76\x65\171\137\x69\x64" => $id])->column("\151\144"); goto RS5a8; XRBPo: nct0m: goto iFJLh; RS5a8: if (!$orderIds) { goto nct0m; } goto hHdRd; iFJLh: Db::table("\x73\165\x72\166\x65\171\x5f\157\x72\x64\145\162")->where(["\163\165\162\166\145\x79\137\151\144" => $id])->delete(); goto KLtpT; lsbry: Db::table("\x73\165\162\166\x65\x79")->where(["\151\x64" => $id])->delete(); goto YdGL1; YdGL1: } }

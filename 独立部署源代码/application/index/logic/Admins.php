<?php
 namespace app\index\logic; use app\index\model\Setting as SettingModel; use app\index\service\RequestContext; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use think\Url; use think\Cache; use app\index\model\Admins as AdminsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\OperationLogs; use app\index\logic\LoginLogs as LoginLogsLogic; class Admins extends Base { protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto b7v_I; Gz7Tn: $adminRoleTable = "\x61\144\155\151\x6e\137\162\x6f\x6c\x65"; goto uqn4u; b7v_I: if ($sort == "\144\151\x73\141\142\x6c\x65\144") { goto LLJC6; } goto KMXHs; PhAc1: pa1EF: goto JqZ0x; IwP0Y: $order = "\x41\x2e\154\x61\x73\x74\x5f\154\157\x67\151\x6e\x5f\164\x69\x6d\145\40" . $order; goto KNr91; EhqhE: return ["\x74\157\164\x61\x6c" => $totalCount, "\162\157\167\163" => $records]; goto GL1z8; JqZ0x: $conditions = []; goto RHI0g; tGIxG: mvSzl: goto Ko8pm; Kr1vr: $records = Db::table($adminsTable)->alias("\x41")->join("{$adminRoleTable}\40\122", "\101\x2e\x72\157\x6c\x65\x5f\x69\144\75\122\56\162\x6f\x6c\x65\137\151\x64", "\x4c\105\x46\x54")->where($conditions)->page($page, $rows)->order($order)->field("\x41\x2e\52\54\122\x2e\162\x6f\x6c\145\x5f\156\x61\x6d\x65")->select(); goto EhqhE; xyqoH: $adminsTable = "\141\144\x6d\151\156\x73"; goto Gz7Tn; qY0iu: $order = "\101\56\141\x64\155\151\156\x5f\x69\x64\40\144\145\163\143"; goto SYC3L; JroFj: x8ZB4: goto xyqoH; SYC3L: goto F7PST; goto HF00K; Ko8pm: if (emptyInArray($search, "\x72\145\x61\154\156\141\x6d\145")) { goto x8ZB4; } goto MhIW2; r98Sp: LLJC6: goto S2dl5; MhIW2: $conditions["\x72\145\x61\154\156\x61\x6d\145"] = ["\154\151\153\145", "\x25" . $search["\162\x65\141\x6c\x6e\x61\155\145"] . "\x25"]; goto JroFj; HF00K: WBh6B: goto IwP0Y; KNr91: F7PST: goto mt7gI; uqn4u: $totalCount = Db::table($adminsTable)->alias("\x41")->where($conditions)->count(); goto Kr1vr; S2dl5: $order = "\101\56\x64\151\x73\141\x62\x6c\145\x64\x20" . $order; goto PhAc1; gfnEb: $conditions["\154\x6f\x67\x69\x6e\x5f\x6e\x61\155\145"] = trim($search["\154\x6f\147\x69\x6e\x5f\x6e\141\155\x65"]); goto tGIxG; mt7gI: goto pa1EF; goto r98Sp; RHI0g: if (emptyInArray($search, "\x6c\x6f\147\x69\156\137\x6e\x61\x6d\x65")) { goto mvSzl; } goto gfnEb; KMXHs: if ($sort == "\x6c\141\x73\x74\137\x6c\x6f\x67\151\x6e\137\x74\x69\x6d\x65") { goto WBh6B; } goto qY0iu; GL1z8: } protected function password($password, $encrypt = '') { goto zo7fr; b2kX8: $pwd["\145\x6e\x63\162\x79\160\x74"] = $encrypt ? $encrypt : \think\helper\Str::random(6); goto aG5c6; zo7fr: $pwd = array(); goto b2kX8; b5V0L: return $encrypt ? $pwd["\x70\x61\163\x73\x77\x6f\x72\x64"] : $pwd; goto vqvbx; aG5c6: $pwd["\x70\141\x73\163\x77\x6f\162\x64"] = md5(md5(trim($password)) . $pwd["\145\156\x63\162\171\x70\x74"]); goto b5V0L; vqvbx: } public function addAdmin($infos) { goto OQR1Z; F7SBv: return true; goto JG52I; aS0uc: $infos["\154\157\x67\x69\156\x5f\x70\x61\x73\163\x77\x6f\x72\x64"] = $passwordInfos["\x70\141\163\163\167\157\162\x64"]; goto ZPPz5; la7Wz: OperationLogs::I()->systemLog("\xe6\x96\xb0\345\242\236\xe7\256\xa1\xe7\x90\x86\xe5\221\x98", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_ADD_TYPE, $adminsModel->admin_id); goto F7SBv; JEa_f: $infos["\162\157\154\x65\137\151\x64"] = 0; goto XvdQx; OQR1Z: $adminsTable = "\x61\144\x6d\151\x6e\163"; goto BQIB6; jI24T: $infos["\x70\141\x73\163\167\157\162\x64\x5f\x63\x68\x61\156\147\145\144"] = date("\x59\x2d\155\55\144"); goto uZm4L; ZPPz5: $infos["\x6c\x6f\x67\151\156\x5f\145\156\143\162\171\x70\164"] = $passwordInfos["\145\x6e\143\162\171\x70\x74"]; goto cSjMa; uZm4L: $passwordInfos = $this->password($infos["\x6c\157\147\x69\156\137\x70\x61\x73\x73\167\x6f\x72\x64"]); goto aS0uc; XvdQx: GtHTU: goto Os6De; cSjMa: if (!isset($infos["\x73\165\x70\x65\162\137\x75\x73\145\x72"])) { goto GtHTU; } goto JEa_f; BQIB6: $adminsModel = new AdminsModel(); goto jI24T; Os6De: $adminsModel->allowField(true)->save($infos); goto la7Wz; JG52I: } public function editAdmin($adminId, $infos) { goto LQryg; zA0qb: goto jVHwM; goto LoeOw; JqZZC: Qca8Q: goto GHCmD; naFnK: $infos["\x64\151\x73\x61\142\x6c\145\144"] = Defs::eDisabledStatus; goto zA0qb; IZNdp: return true; goto XUVSk; ESnLD: if ($adminsModel) { goto XswI1; } goto o32JM; eMNLG: GfaVU: goto IZNdp; hs4yK: OperationLogs::I()->systemLog("\344\xbf\xae\xe6\x94\xb9\347\xae\xa1\xe7\220\206\345\221\x98", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_UPDATE_TYPE, $adminId); goto eMNLG; J89NX: jVHwM: goto MJg1c; iOLHY: ND_mZ: goto fUntD; GHCmD: $infos["\162\x6f\x6c\x65\137\x69\144"] = 0; goto iOLHY; sFV9B: XswI1: goto xdayk; JeARv: $result = $adminsModel->allowField(true)->save(); goto RUwuw; GMGmb: $adminsModel = AdminsModel::get($adminId); goto ESnLD; RUwuw: if (!$result) { goto GfaVU; } goto hs4yK; LoeOw: Vg6Ha: goto s4avM; o32JM: exception("\xe6\x97\xa0\346\xb3\225\346\x89\276\xe5\210\xb0\350\257\245\347\xae\xa1\347\220\x86\345\221\230"); goto sFV9B; fJD9d: $infos["\x73\x75\160\x65\x72\x5f\x75\x73\x65\162"] = AdminsModel::eAdminCommonRole; goto jd9wu; fUntD: if (!isset($infos["\x64\151\163\x61\x62\154\x65\144"])) { goto Vg6Ha; } goto naFnK; jd9wu: goto ND_mZ; goto JqZZC; MJg1c: $adminsModel->data($infos); goto JeARv; LQryg: $adminsTable = "\141\144\155\151\x6e\163"; goto GMGmb; s4avM: $infos["\x64\x69\163\141\x62\154\x65\x64"] = Defs::eEnableStatus; goto J89NX; xdayk: if (isset($infos["\x73\165\x70\x65\162\x5f\x75\x73\x65\162"])) { goto Qca8Q; } goto fJD9d; XUVSk: } public function deleteAdmin($adminId) { goto D8PVM; PgdZZ: if ($adminsModel) { goto mU4pw; } goto qTLJj; qTLJj: exception("\xe6\227\240\xe6\xb3\225\xe6\x89\xbe\xe5\210\260\350\257\xa5\347\xae\xa1\347\x90\x86\xe5\x91\230"); goto SK8PG; om6T9: OperationLogs::I()->systemLog("\345\x88\xa0\xe9\231\xa4\347\xae\xa1\347\220\206\xe5\221\230", $adminsModel->login_name, OperationLogs::OPT_DELETE_TYPE, $adminId); goto ommVN; D8PVM: $adminsModel = AdminsModel::get($adminId); goto PgdZZ; xzG0S: return true; goto DKrgy; SK8PG: mU4pw: goto om6T9; ommVN: $adminsModel->delete(); goto xzG0S; DKrgy: } public function changeAdminPwd($adminId, $infos) { goto y3pcb; dFjJc: qX4ur: goto fQoNA; iwj2p: exception("\346\x96\260\xe5\257\x86\347\240\x81\351\x9d\x9e\346\xb3\225"); goto dFjJc; cBZXe: $datas["\x6c\x6f\x67\x69\x6e\137\145\x6e\x63\x72\171\160\164"] = $passwordInfos["\145\x6e\143\162\x79\x70\164"]; goto mri7V; eC052: $newPassword = isset($infos["\154\157\147\x69\x6e\x5f\160\x61\163\163\167\x6f\162\x64"]) ? $infos["\154\157\x67\151\x6e\x5f\x70\141\163\x73\167\157\162\144"] : ''; goto GQM3_; BdpJL: $datas["\154\x6f\147\151\x6e\137\x70\141\163\x73\167\157\162\x64"] = $passwordInfos["\160\x61\163\x73\167\157\162\144"]; goto cBZXe; pmFet: buGz5: goto eC052; ta39h: return true; goto ZIU_z; cusgR: OperationLogs::I()->systemLog("\344\277\xae\346\x94\xb9\xe7\256\241\xe7\220\x86\xe5\221\x98\xe5\257\x86\xe7\240\201", beautifyLogArray($infos), OperationLogs::OPT_OTHER_TYPE, $adminId); goto adsm0; adsm0: flVHI: goto ta39h; GQM3_: if (!empty($newPassword)) { goto qX4ur; } goto iwj2p; fQoNA: $datas = []; goto u3WRT; VfSmN: if (!$result) { goto flVHI; } goto cusgR; u3WRT: $passwordInfos = $this->password($newPassword); goto BdpJL; Uidae: if ($adminsModel) { goto buGz5; } goto CC3e1; mri7V: $result = $adminsModel->allowField(true)->save($datas); goto VfSmN; y3pcb: $adminsModel = AdminsModel::get($adminId); goto Uidae; CC3e1: exception("\xe6\227\240\346\xb3\225\xe6\x89\276\345\x88\260\xe8\xaf\xa5\347\256\241\xe7\x90\206\345\x91\x98"); goto pmFet; ZIU_z: } public function getAdminInfos($adminId) { $adminsModel = AdminsModel::get($adminId); return $adminsModel; } public function getAdminIds() { $adminIds = Db::table("\x61\144\155\151\156\163")->where(["\x64\x69\163\x61\142\x6c\x65\x64" => Defs::eEnableStatus])->column("\x61\144\155\x69\156\x5f\151\x64"); return $adminIds; } public function login($username, $password) { goto S8UmL; YsNXD: Session::set("\x75\x73\145\162\162\x6f\x6c\145\151\x64", $adminsModel->role_id); goto tf6Wv; dsETS: Session::set("\162\145\141\154\x6e\141\155\x65", $adminsModel->realname); goto YsNXD; SV_GA: return false; goto Unx_a; yt0rC: $loginLogsLogic = LoginLogsLogic::newObj(); goto F_kPB; NEprv: if ($adminsModel) { goto MT31q; } goto JVOmR; txGj0: w36J6: goto mmSk5; JVOmR: return false; goto Z0aNs; HLqzM: return $adminsModel; goto A8U67; mmSk5: Session::set("\165\163\145\162\x69\x64", $adminsModel->admin_id); goto BTTAd; BTTAd: Session::set("\x75\163\x65\162\x6e\141\x6d\145", $adminsModel->login_name); goto dsETS; hkH1W: Session::set("\x6c\x61\163\x74\154\x6f\x67\x69\x6e\164\x69\x6d\x65", time()); goto reP_m; qWdmU: Cache::set("\x53\x49\124\105\x5f\x55\122\114", SITE_URL); goto yt0rC; MhxSs: if (!($adminsModel->disabled != Defs::eEnableStatus)) { goto K1_td; } goto SV_GA; SEzhb: if (!($encryptPassword != $adminsModel->login_password)) { goto w36J6; } goto sUA8i; F_kPB: $loginLogsLogic->add($adminsModel->login_name, $adminsModel->admin_id, truncateString(request()->header("\x75\x73\145\x72\x2d\141\x67\x65\x6e\x74"), 100), request()->ip()); goto g0G_N; sUA8i: return false; goto txGj0; reP_m: Session::set("\x6c\x61\163\x74\154\x6f\x67\x69\x6e\x69\160", request()->ip()); goto pSDDA; S8UmL: $adminsModel = AdminsModel::get(["\154\x6f\147\x69\156\x5f\156\x61\155\x65" => $username]); goto NEprv; pSDDA: Cache::set("\123\105\x53\x53\x49\x4f\x4e\137\x49\x44\x5f" . $adminsModel->admin_id, session_id()); goto qWdmU; Z0aNs: MT31q: goto MhxSs; Unx_a: K1_td: goto js5lR; g0G_N: $adminsModel->save(["\x6c\x61\163\164\x5f\x6c\x6f\x67\151\156\x5f\x74\x69\x6d\145" => Db::raw("\156\157\x77\50\51")]); goto HLqzM; js5lR: $encryptPassword = $this->password($password, $adminsModel->login_encrypt); goto SEzhb; tf6Wv: Session::set("\x73\165\160\145\x72\x5f\x75\163\x65\162", $adminsModel->super_user == AdminsModel::eAdminSuperRole); goto hkH1W; A8U67: } public function logout() { Session::delete(["\165\163\145\x72\x69\144", "\x75\x73\145\162\156\x61\x6d\145", "\162\145\x61\x6c\156\141\155\x65", "\165\163\145\x72\162\x6f\154\x65\151\144", "\x73\x75\x70\145\x72\x5f\x75\x73\145\x72", "\x6c\x61\x73\164\x6c\157\147\151\x6e\x74\151\155\x65", "\154\141\163\164\154\x6f\147\151\156\x69\x70"]); } public function modifyAdminPwd($adminId, $oldPassword, $newPassword) { goto kr40F; FEN1C: $passwordInfos = $this->password($newPassword); goto fmBTI; qXyVk: jgtyG: goto crDG3; VGGYo: if (!($encryptPassword != $adminsModel->login_password)) { goto fYzFf; } goto DaXGQ; BAoCi: exception("\346\227\240\xe6\xb3\225\xe6\211\xbe\345\210\260\350\257\245\xe7\xae\241\347\x90\206\345\221\x98"); goto M8JoI; DaXGQ: exception("\xe6\x97\xa7\xe5\xaf\x86\347\240\x81\xe9\x94\x99\350\xaf\257"); goto oP1m0; mB91h: if ($adminsModel) { goto jhVyR; } goto BAoCi; nEL6o: $encryptPassword = $this->password($oldPassword, $adminsModel->login_encrypt); goto VGGYo; vL7Z8: $datas["\x6c\157\147\151\156\x5f\x65\x6e\x63\162\171\160\164"] = $passwordInfos["\145\x6e\143\162\171\160\x74"]; goto oNpsb; fmBTI: $datas["\154\x6f\x67\x69\156\137\x70\x61\x73\163\167\x6f\162\x64"] = $passwordInfos["\160\x61\163\163\167\157\x72\144"]; goto vL7Z8; K5R3B: if (!$result) { goto jgtyG; } goto xMC1s; oNpsb: $result = $adminsModel->save($datas); goto K5R3B; RyyGn: $datas = []; goto FEN1C; kr40F: $adminsModel = AdminsModel::get($adminId); goto mB91h; oP1m0: fYzFf: goto RyyGn; crDG3: return true; goto vWvpP; M8JoI: jhVyR: goto nEL6o; xMC1s: OperationLogs::I()->systemLog("\xe4\277\xae\xe6\x94\271\xe7\256\xa1\xe7\220\x86\345\221\x98\345\257\206\347\xa0\x81", beautifyLogArray($datas), OperationLogs::OPT_OTHER_TYPE, $adminId); goto qXyVk; vWvpP: } public function getAdminRolePairs() { return Db::table("\x61\x64\155\151\x6e\x5f\162\157\154\x65")->column("\162\x6f\154\x65\137\x69\144\54\40\162\157\154\145\137\x6e\x61\155\x65"); } }

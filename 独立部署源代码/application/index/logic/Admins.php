<?php
 namespace app\index\logic; use app\index\model\Setting as SettingModel; use app\index\service\RequestContext; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use think\Url; use think\Cache; use app\index\model\Admins as AdminsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\OperationLogs; use app\index\logic\LoginLogs as LoginLogsLogic; class Admins extends Base { protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto A1I3q; jPFzX: e0tMF: goto D4DPH; I2d95: goto e0tMF; goto A4fLw; XLwbA: $conditions = []; goto O4McE; A4fLw: buVlv: goto VEldA; jYPpx: $order = "\101\56\x61\144\155\x69\156\137\151\144\x20\144\145\163\143"; goto I2d95; A1I3q: if ($sort == "\x64\151\x73\141\x62\154\145\144") { goto UTlae; } goto lwWGX; VDXef: $adminRoleTable = "\141\x64\155\151\156\x5f\162\157\154\x65"; goto Vwc96; Vwc96: $totalCount = Db::table($adminsTable)->alias("\x41")->where($conditions)->count(); goto lGEQx; ucVm6: $conditions["\x6c\157\x67\151\156\137\156\x61\155\145"] = trim($search["\154\x6f\147\x69\x6e\x5f\x6e\x61\x6d\x65"]); goto ImqSG; D4DPH: goto ZUpeO; goto M2TEC; kRRTt: return ["\x74\157\164\141\154" => $totalCount, "\162\157\167\163" => $records]; goto Az638; VEldA: $order = "\101\x2e\154\141\x73\x74\137\x6c\x6f\147\x69\x6e\137\164\151\155\x65\40" . $order; goto jPFzX; O4McE: if (emptyInArray($search, "\154\x6f\147\151\x6e\137\156\x61\x6d\x65")) { goto kW0cR; } goto ucVm6; IF1Wg: wdGP1: goto lfq34; OdJFe: $conditions["\162\x65\141\154\x6e\141\155\x65"] = ["\x6c\151\x6b\145", "\45" . $search["\x72\x65\141\154\156\x61\155\145"] . "\x25"]; goto IF1Wg; x3sn7: ZUpeO: goto XLwbA; lfq34: $adminsTable = "\141\x64\155\x69\x6e\x73"; goto VDXef; M2TEC: UTlae: goto LCYQo; lwWGX: if ($sort == "\x6c\141\163\x74\x5f\154\157\x67\x69\156\137\164\x69\x6d\x65") { goto buVlv; } goto jYPpx; eb7n2: if (emptyInArray($search, "\x72\145\141\x6c\x6e\x61\x6d\145")) { goto wdGP1; } goto OdJFe; lGEQx: $records = Db::table($adminsTable)->alias("\x41")->join("{$adminRoleTable}\40\122", "\101\x2e\x72\x6f\154\145\137\x69\x64\x3d\122\x2e\162\157\x6c\145\137\151\144", "\x4c\105\x46\x54")->where($conditions)->page($page, $rows)->order($order)->field("\x41\56\x2a\54\x52\x2e\162\157\x6c\145\x5f\156\141\x6d\145")->select(); goto kRRTt; ImqSG: kW0cR: goto eb7n2; LCYQo: $order = "\101\x2e\144\x69\163\x61\x62\x6c\x65\144\40" . $order; goto x3sn7; Az638: } protected function password($password, $encrypt = '') { goto ra_y2; iN5DX: $pwd["\x70\141\163\163\x77\x6f\162\x64"] = md5(md5(trim($password)) . $pwd["\x65\x6e\x63\162\171\x70\164"]); goto IiRge; Oy2OK: $pwd["\x65\156\x63\162\x79\160\164"] = $encrypt ? $encrypt : \think\helper\Str::random(6); goto iN5DX; ra_y2: $pwd = array(); goto Oy2OK; IiRge: return $encrypt ? $pwd["\x70\x61\163\x73\167\x6f\162\x64"] : $pwd; goto JZbyw; JZbyw: } public function addAdmin($infos) { goto dGNVN; CnlmV: $infos["\160\x61\163\163\x77\157\162\144\x5f\143\x68\x61\156\x67\x65\144"] = date("\131\55\x6d\55\144"); goto iOw_A; nki_q: $infos["\154\157\x67\151\x6e\137\160\x61\163\163\167\x6f\162\144"] = $passwordInfos["\x70\x61\163\x73\167\157\x72\144"]; goto XSnDQ; dGNVN: $adminsTable = "\x61\x64\155\151\x6e\163"; goto Irok7; Qbu8t: e2aMe: goto ftV6x; Irok7: $adminsModel = new AdminsModel(); goto CnlmV; JdQId: if (!isset($infos["\x73\165\x70\145\162\137\x75\x73\x65\162"])) { goto e2aMe; } goto tU0XT; iOw_A: $passwordInfos = $this->password($infos["\x6c\157\x67\151\156\x5f\160\141\163\163\x77\157\162\144"]); goto nki_q; t8MWs: return true; goto hDvGk; CcrHS: OperationLogs::I()->systemLog("\346\x96\260\xe5\xa2\236\347\xae\241\347\220\206\345\x91\x98", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_ADD_TYPE, $adminsModel->admin_id); goto t8MWs; tU0XT: $infos["\162\157\x6c\x65\137\x69\144"] = 0; goto Qbu8t; XSnDQ: $infos["\x6c\157\x67\151\x6e\x5f\145\156\x63\x72\171\160\x74"] = $passwordInfos["\145\x6e\x63\x72\x79\x70\164"]; goto JdQId; ftV6x: $adminsModel->allowField(true)->save($infos); goto CcrHS; hDvGk: } public function editAdmin($adminId, $infos) { goto Q8dx_; gwWw1: r_wtU: goto mSDqJ; yobpo: f96id: goto q2hzl; ZlqlO: $infos["\144\x69\x73\x61\142\154\x65\144"] = Defs::eDisabledStatus; goto cMwcv; q2hzl: return true; goto wtVqe; GPwYc: goto p8hOL; goto gwWw1; rTIK9: $result = $adminsModel->allowField(true)->save(); goto l7wwy; Ep_6l: xbtNk: goto Dzswr; kyPdX: $infos["\x64\x69\x73\141\142\x6c\x65\144"] = Defs::eEnableStatus; goto mHYXI; EqveQ: if (!isset($infos["\x64\151\163\141\142\x6c\145\144"])) { goto TKMXT; } goto ZlqlO; l7wwy: if (!$result) { goto f96id; } goto iWUzc; Fi6E3: TKMXT: goto kyPdX; CTWgc: if ($adminsModel) { goto xbtNk; } goto S0En8; Dzswr: if (isset($infos["\x73\165\160\x65\162\137\x75\x73\145\162"])) { goto r_wtU; } goto RTpz2; ipLga: p8hOL: goto EqveQ; RTpz2: $infos["\x73\165\x70\145\162\137\165\163\x65\x72"] = AdminsModel::eAdminCommonRole; goto GPwYc; h4AvL: $adminsModel->data($infos); goto rTIK9; mSDqJ: $infos["\x72\x6f\x6c\x65\x5f\x69\144"] = 0; goto ipLga; S0En8: exception("\xe6\227\xa0\xe6\xb3\x95\346\x89\276\xe5\210\xb0\350\257\xa5\xe7\256\xa1\347\220\x86\345\x91\230"); goto Ep_6l; mHYXI: odqTY: goto h4AvL; iWUzc: OperationLogs::I()->systemLog("\344\277\256\346\224\xb9\xe7\xae\xa1\xe7\220\206\345\x91\230", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_UPDATE_TYPE, $adminId); goto yobpo; Q8dx_: $adminsTable = "\141\x64\155\151\x6e\x73"; goto uLocp; cMwcv: goto odqTY; goto Fi6E3; uLocp: $adminsModel = AdminsModel::get($adminId); goto CTWgc; wtVqe: } public function deleteAdmin($adminId) { goto CrMVk; ZCMor: S9Z4o: goto eXL55; XE9E3: exception("\346\x97\240\xe6\263\225\xe6\x89\276\345\210\xb0\350\257\245\xe7\256\241\347\220\206\345\x91\x98"); goto ZCMor; KZhEU: $adminsModel->delete(); goto bnK35; eXL55: OperationLogs::I()->systemLog("\345\210\240\xe9\x99\xa4\347\xae\xa1\xe7\x90\x86\345\x91\x98", $adminsModel->login_name, OperationLogs::OPT_DELETE_TYPE, $adminId); goto KZhEU; DDkUl: if ($adminsModel) { goto S9Z4o; } goto XE9E3; CrMVk: $adminsModel = AdminsModel::get($adminId); goto DDkUl; bnK35: return true; goto QI0IK; QI0IK: } public function changeAdminPwd($adminId, $infos) { goto JC0pc; aZggj: exception("\xe6\x96\xb0\345\xaf\206\347\240\201\xe9\x9d\236\346\xb3\225"); goto DMxmO; kirKs: if (!empty($newPassword)) { goto E5mMR; } goto aZggj; YWBLa: $newPassword = isset($infos["\154\x6f\x67\151\x6e\137\x70\141\163\163\x77\x6f\x72\144"]) ? $infos["\x6c\157\x67\x69\156\137\x70\141\163\x73\x77\x6f\x72\144"] : ''; goto kirKs; FQ0NI: zHlEG: goto YWBLa; E0Uu4: $datas["\154\157\147\x69\156\x5f\160\141\163\x73\167\157\162\x64"] = $passwordInfos["\160\x61\163\163\x77\157\162\144"]; goto ye6vU; UcGb1: exception("\346\x97\xa0\346\xb3\225\xe6\211\xbe\xe5\x88\260\xe8\257\245\347\xae\241\xe7\220\206\xe5\x91\x98"); goto FQ0NI; JC0pc: $adminsModel = AdminsModel::get($adminId); goto HGbKB; OA3GH: $passwordInfos = $this->password($newPassword); goto E0Uu4; p2Xm1: $datas = []; goto OA3GH; HGbKB: if ($adminsModel) { goto zHlEG; } goto UcGb1; QzovA: if (!$result) { goto WUudC; } goto IO3Ib; XU_YO: return true; goto wVrPE; ye6vU: $datas["\154\x6f\147\x69\x6e\137\145\x6e\x63\x72\171\x70\x74"] = $passwordInfos["\145\156\x63\162\x79\160\x74"]; goto nxKZK; m20Tc: WUudC: goto XU_YO; IO3Ib: OperationLogs::I()->systemLog("\xe4\xbf\256\xe6\224\271\347\xae\xa1\347\220\206\345\x91\x98\345\xaf\x86\xe7\xa0\201", beautifyLogArray($infos), OperationLogs::OPT_OTHER_TYPE, $adminId); goto m20Tc; DMxmO: E5mMR: goto p2Xm1; nxKZK: $result = $adminsModel->allowField(true)->save($datas); goto QzovA; wVrPE: } public function getAdminInfos($adminId) { $adminsModel = AdminsModel::get($adminId); return $adminsModel; } public function getAdminIds() { $adminIds = Db::table("\x61\x64\x6d\x69\x6e\163")->where(["\x64\151\x73\x61\142\154\x65\144" => Defs::eEnableStatus])->column("\141\x64\x6d\x69\x6e\137\151\x64"); return $adminIds; } public function login($username, $password) { goto mxDwT; ljo5z: return false; goto AZa7K; g3xjn: Session::set("\x6c\x61\163\164\154\157\x67\151\x6e\x69\160", request()->ip()); goto qyvqh; Fso9W: Session::set("\x75\163\145\162\156\141\155\145", $adminsModel->login_name); goto qmXmd; qXE1q: return false; goto RpHTs; IAISs: Cache::set("\123\111\x54\x45\x5f\x55\122\x4c", SITE_URL); goto VOE6P; qmXmd: Session::set("\x72\145\141\x6c\x6e\141\x6d\145", $adminsModel->realname); goto kH_Ky; mxDwT: $adminsModel = AdminsModel::get(["\x6c\157\x67\151\x6e\137\x6e\x61\155\145" => $username]); goto PObke; kH_Ky: Session::set("\x75\163\x65\162\162\x6f\x6c\145\x69\x64", $adminsModel->role_id); goto ob0Iy; QFs9O: $adminsModel->save(["\x6c\141\x73\164\137\154\x6f\147\151\x6e\x5f\164\151\x6d\x65" => Db::raw("\156\157\167\50\51")]); goto mF6kE; mF6kE: return $adminsModel; goto JYGdR; VOE6P: $loginLogsLogic = LoginLogsLogic::newObj(); goto QHGve; NBHcQ: DPPAp: goto eepcc; eepcc: $encryptPassword = $this->password($password, $adminsModel->login_encrypt); goto HcGmS; IhpmD: return false; goto NBHcQ; XQnGb: Session::set("\x6c\x61\x73\x74\x6c\157\147\x69\156\164\151\x6d\x65", time()); goto g3xjn; QHGve: $loginLogsLogic->add($adminsModel->login_name, $adminsModel->admin_id, truncateString(request()->header("\165\163\145\162\x2d\x61\x67\x65\156\x74"), 100), request()->ip()); goto QFs9O; AZa7K: kCrPc: goto uWnOZ; aKUGo: if (!($adminsModel->disabled != Defs::eEnableStatus)) { goto DPPAp; } goto IhpmD; RpHTs: biM0C: goto aKUGo; ob0Iy: Session::set("\x73\x75\x70\x65\x72\137\x75\x73\145\162", $adminsModel->super_user == AdminsModel::eAdminSuperRole); goto XQnGb; PObke: if ($adminsModel) { goto biM0C; } goto qXE1q; HcGmS: if (!($encryptPassword != $adminsModel->login_password)) { goto kCrPc; } goto ljo5z; uWnOZ: Session::set("\x75\163\145\162\151\x64", $adminsModel->admin_id); goto Fso9W; qyvqh: Cache::set("\x53\105\x53\123\x49\x4f\x4e\137\x49\x44\x5f" . $adminsModel->admin_id, session_id()); goto IAISs; JYGdR: } public function logout() { Session::delete(["\165\163\145\x72\151\x64", "\x75\163\145\162\156\x61\x6d\x65", "\162\145\141\154\156\x61\155\x65", "\x75\x73\145\x72\162\x6f\154\x65\151\144", "\x73\165\x70\145\x72\x5f\x75\163\145\162", "\154\x61\163\164\154\157\x67\x69\156\x74\x69\155\x65", "\154\141\x73\164\x6c\x6f\x67\x69\x6e\151\160"]); } public function modifyAdminPwd($adminId, $oldPassword, $newPassword) { goto kmfcz; eFTUW: XyiTM: goto pzAQG; vhji6: $result = $adminsModel->save($datas); goto Aj3Fj; HjHUU: exception("\346\227\240\xe6\263\x95\346\x89\276\xe5\210\xb0\350\xaf\xa5\347\xae\xa1\xe7\220\x86\345\221\x98"); goto eFTUW; Y4X3X: $datas["\154\157\x67\151\x6e\137\x70\141\x73\163\167\x6f\x72\x64"] = $passwordInfos["\x70\x61\x73\x73\167\157\162\x64"]; goto Re7rH; GlekR: DaoWk: goto GSdoe; Lakxp: if (!($encryptPassword != $adminsModel->login_password)) { goto DF2kO; } goto WX71z; GSdoe: return true; goto fHPra; y9MmR: if ($adminsModel) { goto XyiTM; } goto HjHUU; wL0LM: $passwordInfos = $this->password($newPassword); goto Y4X3X; Y9F0S: OperationLogs::I()->systemLog("\344\xbf\xae\xe6\x94\271\xe7\xae\241\xe7\x90\x86\xe5\221\x98\xe5\257\206\xe7\240\201", beautifyLogArray($datas), OperationLogs::OPT_OTHER_TYPE, $adminId); goto GlekR; Aj3Fj: if (!$result) { goto DaoWk; } goto Y9F0S; QxCGK: $datas = []; goto wL0LM; wWX0D: DF2kO: goto QxCGK; WX71z: exception("\346\227\xa7\xe5\257\206\347\240\201\351\x94\x99\350\257\xaf"); goto wWX0D; Re7rH: $datas["\154\x6f\x67\x69\x6e\137\x65\156\x63\x72\171\x70\x74"] = $passwordInfos["\145\x6e\143\162\x79\160\x74"]; goto vhji6; kmfcz: $adminsModel = AdminsModel::get($adminId); goto y9MmR; pzAQG: $encryptPassword = $this->password($oldPassword, $adminsModel->login_encrypt); goto Lakxp; fHPra: } public function getAdminRolePairs() { return Db::table("\141\x64\155\x69\156\x5f\x72\157\154\145")->column("\162\x6f\154\x65\137\x69\x64\x2c\40\x72\x6f\x6c\x65\137\156\141\155\145"); } }

<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class SubjectCombination extends Base { public function __construct() { } public function loadSubjectCombination($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto hsrSZ; gSgol: qRobh: goto toDw1; JCgAq: if (emptyInArray($search, "\x73\x74\x61\164\x75\x73")) { goto GmbtK; } goto eW5ov; jIvkx: if (emptyInArray($search, "\x64\145\154\145\164\x65\x5f\146\154\x61\147")) { goto G632T; } goto T45I2; VIeb2: GmbtK: goto jIvkx; I16ZU: $where = ["\x64\145\154\145\x74\145\137\146\154\141\x67" => 0]; goto jaPor; hEkSt: foreach ($rows as &$row) { goto Udwsg; Jieg5: $row["\x73\165\x62\152\145\x63\164\x73\x5f\156\141\155\x65\x73"] = $subjectNames; goto IuDbH; IuDbH: $row["\x62\x61\156\156\x65\162"] = generateThumbnailUrl($row["\142\141\156\156\145\x72"], 100); goto XPpv6; JUBFl: $subjectIds = explode("\54", $row["\163\x75\142\152\145\143\164\163"]); goto MkmtC; Udwsg: $subjectNames = ''; goto JUBFl; FKY8c: c7kSg: goto ak6F3; SSaxl: Rw5IA: goto Jieg5; MkmtC: foreach ($subjectIds as $subjectId) { goto DIxBY; DIxBY: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto aVSI9; fFCzi: UEow0: goto f_vF3; DLq4G: if (!$subjectNames) { goto AY1I6; } goto fPIr_; eCvJO: $subjectNames .= $subjectName; goto P31JM; P31JM: ntNBZ: goto fFCzi; fPIr_: $subjectNames .= "\74\x62\x72\40\57\76"; goto nO6J6; nO6J6: AY1I6: goto eCvJO; aVSI9: if (!$subjectName) { goto ntNBZ; } goto DLq4G; f_vF3: } goto SSaxl; XPpv6: $row["\x64\145\x73\143\162\151\x70\164\x69\157\x6e"] = ellipsisString($row["\144\145\x73\143\162\x69\160\x74\x69\x6f\x6e"], 32); goto FKY8c; ak6F3: } goto B6PX0; oNBiy: $where["\x6e\x61\x6d\x65"] = ["\x6c\x69\153\145", "\x25{$search["\156\141\155\145"]}\45"]; goto PbScV; B6PX0: QMsO_: goto DiLaJ; DiLaJ: return ["\x74\x6f\x74\141\x6c" => $count, "\x72\x6f\167\x73" => $rows]; goto jlLgT; qqW7C: $count = Db::table("\163\165\x62\x6a\145\143\x74\x5f\143\x6f\155\x62\x69\156\141\164\151\157\156")->where($where)->count(); goto SgxcE; d1UXa: goto JaWUv; goto rVUZl; SgxcE: $subjectPairs = Db::table("\x73\x75\x62\x6a\x65\143\x74")->where([])->column("\x6e\141\x6d\145", "\151\x64"); goto rmoOF; RLo6o: JaWUv: goto I16ZU; rVUZl: BAsH3: goto KbI7r; PbScV: ELJOo: goto JCgAq; kJgQU: $order = "\x69\x64\x20\144\x65\163\x63"; goto d1UXa; KbI7r: $order = "\x73\164\x61\164\x75\x73\x20{$order}"; goto RLo6o; hsrSZ: if ($sort == "\x73\164\141\164\x75\x73") { goto BAsH3; } goto kJgQU; T45I2: $where["\144\145\x6c\x65\x74\x65\137\x66\154\x61\x67"] = $search["\144\145\x6c\x65\164\x65\x5f\146\154\141\147"]; goto fOUb0; eW5ov: $where["\163\x74\141\164\x75\163"] = $search["\163\x74\141\x74\165\163"]; goto VIeb2; jaPor: if (!(isset($search["\156\141\155\145"]) && $search["\156\141\155\145"])) { goto ELJOo; } goto oNBiy; fOUb0: G632T: goto qqW7C; toDw1: $rows = Db::table("\x73\x75\142\152\x65\x63\164\137\x63\157\x6d\142\151\156\141\x74\151\x6f\x6e")->where($where)->page($page, $rows)->order($order)->field(true)->select(); goto hEkSt; rmoOF: if (!empty($subjectPairs)) { goto qRobh; } goto c2kEy; c2kEy: $subjectPairs = []; goto gSgol; jlLgT: } public function getSubjectCombination($id) { $record = Db::table("\163\165\142\x6a\145\143\164\x5f\143\157\155\142\x69\x6e\x61\164\x69\157\156")->where("\x69\x64", $id)->field("\52")->find(); return $record; } public function saveSubjectCombination($id, $data) { goto szx9W; cx8e3: wexception("\350\xaf\267\xe9\x80\x89\346\x8b\xa9\xe4\xb8\244\344\xb8\252\344\xbb\xa5\344\xb8\x8a\351\x87\x8f\350\241\xa8"); goto ziu29; ziu29: izi74: goto rodGa; pH4MC: wexception("\xe6\267\273\345\x8a\240\xe5\xa4\261\350\xb4\245"); goto MLsKq; d37X5: if (!empty($id)) { goto XL7ut; } goto pH4MC; hDONs: $data["\x6d\164\151\x6d\x65"] = date("\131\x2d\155\x2d\144\x20\110\x3a\151\x3a\x73"); goto kMMsn; t07u4: if (!(count(explode("\54", $data["\x73\165\142\x6a\x65\x63\164\163"])) == 1)) { goto izi74; } goto cx8e3; szx9W: if (!empty($data["\163\165\x62\152\145\x63\164\x73"])) { goto lsBtk; } goto myBk1; gplEu: xofaw: goto RYj8V; kMMsn: $originals = Db::table("\x73\x75\x62\152\x65\143\164\x5f\x63\157\155\142\x69\156\x61\164\x69\157\x6e")->where(["\x69\x64" => $id])->field(true)->find(); goto BnH2s; t0zjP: if (!$banner) { goto k32gP; } goto UF5r5; VbJ1r: lsBtk: goto t07u4; NaCGj: OperationLogs::I()->subjecCombinationtLog("\346\226\xb0\xe5\xa2\236\347\xbb\204\345\220\210\xe9\x87\x8f\350\xa1\250\x20\55\x20{$data["\x6e\141\155\145"]}", beautifyLogArray($data, [], "\x73\x75\142\152\x65\x63\164\137\x63\157\155\142\151\156\x61\x74\151\157\x6e"), OperationLogs::OPT_ADD_TYPE, $id); goto Tck9i; Fb9KZ: $id = Db::table("\163\165\x62\152\x65\143\164\137\x63\157\x6d\142\x69\x6e\x61\x74\x69\157\x6e")->insertGetId($data); goto d37X5; RYj8V: $banner = autoGenerateBannerImage($data["\x6e\x61\x6d\x65"], $data["\x62\141\x6e\156\x65\162"]); goto t0zjP; ifVSk: k32gP: goto zngP0; rodGa: if (!(count(explode("\54", $data["\163\x75\142\152\x65\143\x74\x73"])) > 20)) { goto xofaw; } goto c8J6P; Tck9i: m6LrY: goto GbIm7; TZCgh: OperationLogs::I()->subjecCombinationtLog("\344\277\256\xe6\x94\xb9\347\273\x84\xe5\220\x88\xe9\x87\217\xe8\241\250\x20\55\x20{$data["\x6e\x61\155\145"]}", beautifyLogArray($data, $originals, "\x73\x75\142\152\x65\143\x74\x5f\143\x6f\x6d\x62\x69\x6e\141\x74\151\157\x6e"), OperationLogs::OPT_UPDATE_TYPE, $id); goto wI2Ws; BnH2s: Db::table("\x73\165\142\x6a\145\143\x74\x5f\x63\157\155\142\x69\156\x61\164\151\x6f\156")->where(["\x69\144" => $id])->update($data); goto TZCgh; zngP0: if (empty($id)) { goto Cbfh_; } goto hDONs; c8J6P: wexception("\344\xb8\x8d\xe8\203\xbd\xe9\x80\x89\346\x8b\xa9\350\xb6\x85\xe8\277\x87\x32\x30\344\270\xaa\344\xbb\xa5\xe4\270\x8a\xe9\207\x8f\350\xa1\250"); goto gplEu; MLsKq: XL7ut: goto NaCGj; uOycI: Cbfh_: goto Fb9KZ; UF5r5: $data["\142\141\x6e\156\145\x72"] = $banner; goto ifVSk; myBk1: wexception("\350\xaf\xb7\351\x80\x89\346\213\xa9\351\207\x8f\350\xa1\250"); goto VbJ1r; wI2Ws: goto m6LrY; goto uOycI; GbIm7: } public function deleteSubjectCombination($id) { goto cbVNO; XAek8: $name = Db::table("\x73\x75\142\152\145\x63\x74\137\x63\x6f\155\142\151\x6e\141\164\x69\157\156")->where(["\151\x64" => $id])->value("\156\141\x6d\x65"); goto u8lxU; u8lxU: OperationLogs::I()->subjecCombinationtLog("\345\x88\240\351\x99\244\347\273\x84\345\x90\210\351\x87\217\350\xa1\xa8", $name, OperationLogs::OPT_DELETE_TYPE, $id); goto meC4d; cbVNO: Db::table("\163\x75\x62\152\145\x63\x74\137\143\157\155\142\x69\156\x61\164\x69\157\156")->where(["\151\x64" => $id])->update(["\144\x65\154\x65\164\x65\x5f\146\x6c\x61\x67" => 1]); goto XAek8; meC4d: } public function deleteForceSubjectCombination($id) { goto OzYtw; opP2x: Db::table("\x73\x75\142\x6a\145\x63\x74\137\x6f\x72\144\145\x72")->where(["\143\x62\x5f\157\162\144\145\162\x5f\x69\x64" => ["\x69\156", $orderIds]])->delete(); goto LLSe1; LLSe1: CFQWM: goto kN_T7; vR5xX: if (!$orderIds) { goto CFQWM; } goto opP2x; LBFmb: Db::table("\163\x75\x62\152\x65\143\x74\137\x63\157\155\x62\x69\156\141\164\x69\157\x6e")->where(["\x69\144" => $id])->delete(); goto OpyG2; OzYtw: $orderIds = Db::table("\x63\157\155\x62\151\x6e\141\x74\x69\157\x6e\137\157\162\144\145\162")->where(["\143\x6f\155\142\x69\x6e\x61\164\x69\x6f\x6e\x5f\151\144" => $id])->column("\x69\x64"); goto vR5xX; kN_T7: Db::table("\143\x6f\x6d\x62\x69\156\141\x74\x69\x6f\x6e\x5f\157\162\144\145\162")->where(["\143\157\x6d\142\151\x6e\x61\164\151\x6f\156\137\x69\144" => $id])->delete(); goto LBFmb; OpyG2: } public function qrcode($id) { goto cPMoc; XSU5K: $path = "\x2f\161\x72\x63\x6f\x64\145\57" . $scene_id . "\x2e\x6a\160\x67"; goto hwi_3; BgjeP: wexception("\346\227\240\346\263\225\346\x89\276\xe5\x88\260\350\257\245\xe9\207\217\350\241\xa8"); goto FgEwO; SMRCc: if ($result) { goto qlB4F; } goto Q3W6p; f_sbA: if (systemSetting("\127\130\137\117\106\x46\x49\x43\105\137\101\x43\x43\117\125\x4e\x54\137\x41\x50\x50\137\x49\104")) { goto ot8ou; } goto H7Q2f; su7ph: try { goto eTMQD; sV0HL: Log::notice("\163\x75\142\x6a\145\143\x74\x20\x63\x6f\x6d\142\x69\156\x61\x74\x69\157\x6e\x20\161\x72\143\157\x64\x65\40\x72\145\x74\165\x72\156\x20" . var_export($res, true)); goto odaRk; sdA01: if (!$res) { goto XDIzN; } goto sV0HL; jxNOF: exception("\346\x8e\xa5\345\x8f\xa3\350\277\224\345\x9b\x9e\xe5\xa4\261\xe8\264\245\x2c\40" . var_export($res, true)); goto HQt0s; g4ugc: if (!(!$res || !isset($res["\164\x69\x63\x6b\x65\164"]))) { goto Vyv6n; } goto jxNOF; eTMQD: $res = $app->qrcode->forever($scene_id); goto sdA01; NVsGK: $url = $app->qrcode->url($res["\164\x69\x63\153\145\164"]); goto F7BXf; HQt0s: Vyv6n: goto NVsGK; odaRk: XDIzN: goto g4ugc; F7BXf: } catch (\Exception $e) { wexception("\347\x94\237\xe6\x88\220\345\244\261\350\264\245\357\xbc\x9a" . $e->getMessage()); } goto XSU5K; SaRX_: wxPaySetting(); goto od2tY; hwi_3: $result = file_put_contents(SITE_DIR . $path, file_get_contents($url)); goto SMRCc; Tmf55: ot8ou: goto SaRX_; H7Q2f: wexception("\347\x94\237\xe6\210\x90\345\244\261\350\264\xa5\xef\274\x9a\xe6\x9c\252\351\205\215\xe7\xbd\xae\345\205\xac\344\274\227\345\x8f\xb7\xe5\x8f\x82\xe6\225\260"); goto Tmf55; cPMoc: $subject = Db::table("\x73\165\142\x6a\145\x63\164\137\143\157\x6d\142\151\x6e\x61\164\151\x6f\x6e")->where(["\x69\144" => $id])->find(); goto VT3Np; S99K8: return $path; goto ZCO1h; u2IGY: $scene_id = "\143\157\x6d\142\151\156\141\164\151\157\x6e\137\151\x64\x5f" . $id; goto su7ph; d1wNK: qlB4F: goto aJhsF; aJhsF: Db::table("\x73\165\x62\x6a\x65\143\164\137\143\x6f\155\x62\x69\156\x61\164\x69\157\156")->where(["\x69\144" => $id])->setField("\x71\x72\143\x6f\144\x65", $path); goto S99K8; od2tY: $app = \EasyWeChat\Factory::officialAccount(config("\x77\x78\x2e\x6f\146\x66\151\x63\151\141\x6c\137\x61\x63\x63\157\x75\156\x74")); goto u2IGY; VT3Np: if ($subject) { goto cvK28; } goto BgjeP; FgEwO: cvK28: goto f_sbA; Q3W6p: wexception("\xe5\x86\x99\345\x85\xa5\xe5\233\xbe\345\x83\x8f\346\226\x87\344\273\xb6\345\xa4\261\350\264\245"); goto d1wNK; ZCO1h: } }

<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class SubjectCombination extends Base { public function __construct() { } public function loadSubjectCombination($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto FKzKJ; NbJfC: if (!(isset($search["\156\x61\155\145"]) && $search["\156\x61\x6d\x65"])) { goto kK4q8; } goto BiVb0; ZIm33: xJ57e: goto zpgOI; JoAY8: i1h0A: goto E5SHk; KPIh2: cOyfj: goto alYr4; J_0tV: if (emptyInArray($search, "\144\145\154\x65\x74\145\137\x66\154\141\147")) { goto i1h0A; } goto oqcJ1; Xl11v: goto xJ57e; goto WDKPG; alYr4: return ["\x74\x6f\164\141\154" => $count, "\x72\157\167\x73" => $rows]; goto EZhi_; TzD6U: $order = "\x69\x64\x20\x64\x65\x73\x63"; goto Xl11v; y7JTG: $subjectPairs = []; goto ZN0C2; E5SHk: $count = Db::table("\163\x75\x62\x6a\145\143\164\x5f\143\157\155\x62\x69\156\141\x74\151\157\156")->where($where)->count(); goto aOWBf; oqcJ1: $where["\x64\x65\x6c\x65\164\145\137\146\x6c\x61\x67"] = $search["\x64\x65\154\145\x74\145\137\x66\x6c\141\x67"]; goto JoAY8; kE806: $where["\x73\x74\141\x74\x75\163"] = $search["\x73\x74\141\x74\165\x73"]; goto c6lNL; qqH01: kK4q8: goto ZXILt; FKzKJ: if ($sort == "\x73\x74\x61\164\165\163") { goto dJpNI; } goto TzD6U; aOWBf: $subjectPairs = Db::table("\163\x75\x62\152\145\143\x74")->where([])->column("\156\141\x6d\x65", "\151\x64"); goto WwNYa; AGIrL: $rows = Db::table("\x73\x75\x62\x6a\145\143\x74\137\143\x6f\x6d\142\x69\156\141\x74\x69\157\156")->where($where)->page($page, $rows)->order($order)->field(true)->select(); goto UIAHF; c6lNL: etdhX: goto J_0tV; zpgOI: $where = ["\144\x65\154\x65\x74\x65\x5f\146\x6c\x61\x67" => 0]; goto NbJfC; BiVb0: $where["\x6e\141\x6d\145"] = ["\x6c\151\153\x65", "\45{$search["\156\141\x6d\x65"]}\x25"]; goto qqH01; UIAHF: foreach ($rows as &$row) { goto a1e10; Oqo1w: foreach ($subjectIds as $subjectId) { goto r4oDc; r4oDc: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto hFgh3; tOsIz: inlpG: goto wuA8u; wuA8u: zyBy6: goto oEWrT; ThxfQ: $subjectNames .= $subjectName; goto tOsIz; hFgh3: if (!$subjectName) { goto inlpG; } goto o0EX_; aJTde: Kdrkc: goto ThxfQ; o0EX_: if (!$subjectNames) { goto Kdrkc; } goto NfdqZ; NfdqZ: $subjectNames .= "\74\x62\x72\40\57\x3e"; goto aJTde; oEWrT: } goto HA7kv; yccMT: RKiyc: goto lYIFE; xoJAy: $row["\x62\x61\156\x6e\145\162"] = generateThumbnailUrl($row["\x62\141\156\156\145\162"], 100); goto rdADr; a1e10: $subjectNames = ''; goto f50_1; z_gr0: $row["\x73\165\x62\x6a\x65\x63\164\x73\137\x6e\141\x6d\x65\x73"] = $subjectNames; goto xoJAy; HA7kv: oBRN2: goto z_gr0; f50_1: $subjectIds = explode("\x2c", $row["\163\165\x62\x6a\x65\x63\x74\163"]); goto Oqo1w; rdADr: $row["\x64\145\x73\x63\x72\151\x70\164\x69\157\156"] = ellipsisString($row["\x64\x65\x73\x63\162\151\160\164\151\x6f\156"], 32); goto yccMT; lYIFE: } goto KPIh2; ZN0C2: wGgNf: goto AGIrL; WwNYa: if (!empty($subjectPairs)) { goto wGgNf; } goto y7JTG; ZXILt: if (emptyInArray($search, "\163\164\141\164\165\x73")) { goto etdhX; } goto kE806; vWLVn: $order = "\163\164\x61\x74\165\163\40{$order}"; goto ZIm33; WDKPG: dJpNI: goto vWLVn; EZhi_: } public function getSubjectCombination($id) { $record = Db::table("\163\165\142\x6a\145\x63\x74\137\143\x6f\x6d\x62\x69\156\x61\x74\151\x6f\x6e")->where("\x69\x64", $id)->field("\52")->find(); return $record; } public function saveSubjectCombination($id, $data) { goto lVKh6; WEcZS: $data["\142\141\x6e\156\145\x72"] = $banner; goto XTVaA; vPDn1: wexception("\346\267\273\xe5\x8a\240\xe5\xa4\xb1\350\xb4\xa5"); goto MaKNh; PTaiD: if (empty($id)) { goto GfZKV; } goto roBnZ; cgO_G: wexception("\350\257\267\351\x80\x89\xe6\x8b\251\344\270\244\344\xb8\252\344\xbb\245\xe4\xb8\212\351\x87\x8f\xe8\241\xa8"); goto fGEG0; Rvpg1: OperationLogs::I()->subjecCombinationtLog("\344\xbf\256\346\224\xb9\347\xbb\204\xe5\220\210\xe9\207\217\xe8\xa1\xa8\x20\55\x20{$data["\x6e\141\x6d\145"]}", beautifyLogArray($data, $originals, "\x73\x75\x62\152\x65\143\x74\x5f\x63\x6f\155\142\x69\x6e\x61\x74\151\x6f\156"), OperationLogs::OPT_UPDATE_TYPE, $id); goto mopf9; q8_oH: Bp7v_: goto zKL8i; roBnZ: $data["\x6d\164\x69\155\145"] = date("\131\55\x6d\55\x64\40\110\72\x69\x3a\x73"); goto xNeoU; fGEG0: l3cO5: goto PKq8O; p3J4V: wexception("\xe8\xaf\267\xe9\x80\x89\xe6\213\xa9\351\x87\217\xe8\241\250"); goto FaPdy; H3KR0: if (!(count(explode("\54", $data["\x73\x75\x62\152\x65\143\x74\x73"])) == 1)) { goto l3cO5; } goto cgO_G; lvdpA: Db::table("\163\165\x62\152\x65\143\164\137\x63\157\x6d\x62\151\156\x61\x74\151\157\x6e")->where(["\151\x64" => $id])->update($data); goto Rvpg1; XTVaA: fZFkI: goto PTaiD; xNeoU: $originals = Db::table("\x73\165\x62\x6a\x65\143\164\x5f\x63\x6f\x6d\142\x69\156\x61\x74\151\x6f\156")->where(["\x69\x64" => $id])->field(true)->find(); goto lvdpA; lVKh6: if (!empty($data["\x73\x75\142\x6a\145\x63\164\163"])) { goto bzl56; } goto p3J4V; mopf9: goto Bp7v_; goto LcMti; IubCJ: OperationLogs::I()->subjecCombinationtLog("\xe6\x96\xb0\345\xa2\x9e\xe7\xbb\x84\345\220\x88\xe9\207\x8f\350\xa1\250\40\55\40{$data["\x6e\141\x6d\x65"]}", beautifyLogArray($data, [], "\163\x75\x62\152\145\143\164\x5f\x63\157\155\142\x69\x6e\x61\x74\x69\x6f\156"), OperationLogs::OPT_ADD_TYPE, $id); goto q8_oH; dAhl2: $banner = autoGenerateBannerImage($data["\156\x61\x6d\x65"], $data["\x62\x61\x6e\x6e\145\162"]); goto AWYZZ; pjF9k: if (!empty($id)) { goto DitIn; } goto vPDn1; UdRIg: wexception("\344\xb8\215\xe8\x83\275\351\200\x89\xe6\x8b\xa9\350\xb6\x85\xe8\277\207\x32\x30\344\xb8\xaa\344\273\245\xe4\xb8\x8a\xe9\207\217\350\241\250"); goto PlXH6; PlXH6: dFTDm: goto dAhl2; PKq8O: if (!(count(explode("\54", $data["\x73\165\142\x6a\145\143\x74\x73"])) > 20)) { goto dFTDm; } goto UdRIg; MaKNh: DitIn: goto IubCJ; trBuJ: $id = Db::table("\163\165\x62\152\145\x63\164\137\143\157\x6d\x62\151\x6e\x61\x74\x69\x6f\156")->insertGetId($data); goto pjF9k; FaPdy: bzl56: goto H3KR0; AWYZZ: if (!$banner) { goto fZFkI; } goto WEcZS; LcMti: GfZKV: goto trBuJ; zKL8i: } public function deleteSubjectCombination($id) { goto seAgB; seAgB: Db::table("\163\x75\142\x6a\x65\x63\x74\137\143\157\155\x62\x69\156\x61\164\151\157\156")->where(["\151\144" => $id])->update(["\x64\x65\154\145\x74\x65\137\x66\154\141\x67" => 1]); goto fXG8x; fXG8x: $name = Db::table("\163\x75\142\x6a\x65\x63\164\x5f\x63\x6f\x6d\x62\x69\156\141\164\x69\157\156")->where(["\151\144" => $id])->value("\x6e\x61\x6d\x65"); goto rk6VV; rk6VV: OperationLogs::I()->subjecCombinationtLog("\345\x88\240\351\231\244\xe7\xbb\204\xe5\220\210\351\x87\x8f\xe8\xa1\xa8", $name, OperationLogs::OPT_DELETE_TYPE, $id); goto gTLBv; gTLBv: } public function deleteForceSubjectCombination($id) { goto Gw55V; eieb1: Db::table("\x63\157\155\x62\151\x6e\x61\x74\151\x6f\x6e\137\x6f\162\144\x65\162")->where(["\x63\157\155\142\151\x6e\141\164\x69\157\x6e\x5f\x69\x64" => $id])->delete(); goto sD8zx; PrloN: if (!$orderIds) { goto VOQUK; } goto OHs_z; Gw55V: $orderIds = Db::table("\143\157\x6d\x62\x69\x6e\x61\164\x69\x6f\x6e\137\x6f\162\x64\x65\162")->where(["\x63\157\x6d\x62\151\156\141\x74\x69\x6f\x6e\137\151\x64" => $id])->column("\151\144"); goto PrloN; OHs_z: Db::table("\x73\x75\142\x6a\x65\x63\164\137\157\x72\x64\x65\x72")->where(["\x63\x62\137\x6f\x72\144\145\162\x5f\x69\144" => ["\x69\x6e", $orderIds]])->delete(); goto eUmyu; eUmyu: VOQUK: goto eieb1; sD8zx: Db::table("\x73\x75\142\x6a\145\143\164\x5f\x63\157\x6d\x62\x69\x6e\x61\164\x69\157\156")->where(["\151\144" => $id])->delete(); goto GPqVQ; GPqVQ: } public function qrcode($id) { goto NUvCn; cmK5S: if (systemSetting("\127\130\137\117\106\106\x49\x43\x45\137\101\103\x43\117\125\x4e\x54\x5f\x41\x50\x50\137\x49\104")) { goto H3Evx; } goto mfnXn; XFDEy: Db::table("\163\165\x62\152\145\143\x74\137\143\157\155\x62\151\156\141\164\151\x6f\x6e")->where(["\151\144" => $id])->setField("\x71\162\x63\157\144\145", $path); goto XO4El; ygOuz: try { goto Ghytq; Xa0Xi: if (!(!$res || !isset($res["\164\151\x63\153\x65\164"]))) { goto S_2SP; } goto gQPNx; P7eOd: GsUx7: goto Xa0Xi; gQPNx: exception("\346\216\245\xe5\x8f\xa3\350\xbf\224\345\x9b\x9e\345\xa4\xb1\350\264\xa5\x2c\40" . var_export($res, true)); goto aPfJI; jKxc4: Log::notice("\x73\165\x62\152\145\143\x74\40\x63\x6f\x6d\x62\151\x6e\141\x74\151\x6f\x6e\40\x71\162\x63\157\x64\x65\40\162\145\x74\x75\x72\x6e\x20" . var_export($res, true)); goto P7eOd; qHWBN: $url = $app->qrcode->url($res["\x74\151\x63\153\x65\164"]); goto A4ThA; Ghytq: $res = $app->qrcode->forever($scene_id); goto MfCnR; MfCnR: if (!$res) { goto GsUx7; } goto jKxc4; aPfJI: S_2SP: goto qHWBN; A4ThA: } catch (\Exception $e) { wexception("\xe7\224\237\346\x88\x90\345\xa4\261\xe8\264\245\357\274\x9a" . $e->getMessage()); } goto UGHVT; GgvXf: H3Evx: goto mNY84; TDj1r: $scene_id = "\x63\157\x6d\142\x69\156\x61\x74\151\x6f\156\137\x69\144\x5f" . $id; goto ygOuz; ZvFeg: wexception("\xe6\x97\xa0\xe6\xb3\x95\xe6\x89\xbe\xe5\x88\260\350\257\xa5\351\207\x8f\xe8\xa1\250"); goto XvxSa; mNY84: wxPaySetting(); goto LbrVt; LbrVt: $app = \EasyWeChat\Factory::officialAccount(config("\167\170\56\x6f\146\146\151\x63\151\141\x6c\137\x61\143\x63\x6f\165\156\164")); goto TDj1r; XZbB4: wexception("\345\x86\x99\xe5\205\xa5\xe5\233\xbe\xe5\x83\x8f\xe6\226\207\xe4\xbb\266\xe5\xa4\261\350\xb4\245"); goto HhSu3; XO4El: return $path; goto dlpsM; XvxSa: s_uG4: goto cmK5S; zLqYP: if ($result) { goto owKlD; } goto XZbB4; NUvCn: $subject = Db::table("\x73\x75\142\152\x65\143\164\137\143\x6f\155\x62\x69\x6e\x61\x74\151\157\156")->where(["\151\x64" => $id])->find(); goto xA_Fk; mfnXn: wexception("\347\x94\x9f\xe6\210\x90\345\244\xb1\xe8\xb4\xa5\357\xbc\x9a\346\x9c\252\xe9\205\215\347\275\256\345\x85\254\344\274\227\345\x8f\267\345\x8f\202\346\225\xb0"); goto GgvXf; HhSu3: owKlD: goto XFDEy; xA_Fk: if ($subject) { goto s_uG4; } goto ZvFeg; UGHVT: $path = "\57\161\x72\x63\x6f\144\x65\57" . $scene_id . "\56\152\x70\x67"; goto xbRcj; xbRcj: $result = file_put_contents(SITE_DIR . $path, file_get_contents($url)); goto zLqYP; dlpsM: } }

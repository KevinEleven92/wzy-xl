<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class SubjectCombination extends Base { public function __construct() { } public function loadSubjectCombination($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto Bwk1T; mGIC5: if (!empty($subjectPairs)) { goto bLuVG; } goto FUpDz; wg9Lx: $count = Db::table("\x73\x75\142\x6a\x65\143\x74\137\143\157\x6d\142\x69\x6e\x61\164\x69\157\156")->where($where)->count(); goto kU1Ne; IhQvL: EqqHn: goto WQtZL; K8Aa2: $where = ["\144\x65\x6c\145\x74\x65\x5f\146\154\x61\x67" => 0]; goto FrYmK; yh9lP: $rows = Db::table("\x73\x75\142\x6a\x65\x63\164\137\143\x6f\x6d\x62\151\x6e\141\x74\x69\157\156")->where($where)->page($page, $rows)->order($order)->field(true)->select(); goto fnnc6; W5oc0: $order = "\x73\164\141\164\x75\x73\40{$order}"; goto rYLQ1; WQtZL: return ["\x74\x6f\x74\x61\x6c" => $count, "\162\x6f\167\163" => $rows]; goto qb1gy; Abk6V: if (emptyInArray($search, "\x64\145\154\145\x74\x65\137\x66\154\x61\x67")) { goto Ouch4; } goto hVL0J; LDm42: xzy07: goto W5oc0; FUpDz: $subjectPairs = []; goto g7GCw; kU1Ne: $subjectPairs = Db::table("\x73\165\142\x6a\145\143\164")->where([])->column("\x6e\x61\155\145", "\x69\x64"); goto mGIC5; WF9Q3: $where["\163\x74\x61\164\x75\163"] = $search["\163\x74\141\164\x75\x73"]; goto ZBlvx; WkjS2: UG8eJ: goto PCcYs; FrYmK: if (!(isset($search["\x6e\x61\x6d\145"]) && $search["\156\141\155\145"])) { goto UG8eJ; } goto xPDm4; Bwk1T: if ($sort == "\163\x74\141\164\165\163") { goto xzy07; } goto stjWk; fnnc6: foreach ($rows as &$row) { goto CQEJs; A3wwB: nTgiT: goto UYXsi; tRYw2: $subjectIds = explode("\54", $row["\163\165\142\152\145\x63\164\163"]); goto FHWTi; CQEJs: $subjectNames = ''; goto tRYw2; n4zzL: $row["\144\145\163\143\162\x69\x70\x74\x69\157\156"] = ellipsisString($row["\x64\145\163\143\162\151\x70\164\x69\157\156"], 32); goto A3wwB; QSW62: $row["\x62\x61\x6e\156\x65\x72"] = generateThumbnailUrl($row["\x62\x61\x6e\156\x65\x72"], 100); goto n4zzL; f6ewZ: $row["\x73\165\142\x6a\x65\143\164\163\x5f\x6e\x61\155\145\x73"] = $subjectNames; goto QSW62; FHWTi: foreach ($subjectIds as $subjectId) { goto h3FYu; QdKnd: $subjectNames .= $subjectName; goto QW6eN; QW6eN: nMELU: goto mWlL_; h3FYu: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto jPdku; JyO7D: zTNJT: goto QdKnd; jPdku: if (!$subjectName) { goto nMELU; } goto kUQal; mWlL_: KhpFv: goto bH468; kUQal: if (!$subjectNames) { goto zTNJT; } goto ixfeO; ixfeO: $subjectNames .= "\x3c\142\162\40\57\76"; goto JyO7D; bH468: } goto EWHzd; EWHzd: rZPOl: goto f6ewZ; UYXsi: } goto IhQvL; PCcYs: if (emptyInArray($search, "\163\164\141\x74\165\x73")) { goto PCCK0; } goto WF9Q3; xPDm4: $where["\156\141\155\145"] = ["\154\x69\153\145", "\x25{$search["\156\141\155\x65"]}\x25"]; goto WkjS2; I8JeX: Ouch4: goto wg9Lx; rYLQ1: eAB0q: goto K8Aa2; JMFHE: goto eAB0q; goto LDm42; g7GCw: bLuVG: goto yh9lP; hVL0J: $where["\144\x65\x6c\145\164\145\137\x66\x6c\x61\x67"] = $search["\144\x65\154\145\x74\145\137\x66\154\141\x67"]; goto I8JeX; ZBlvx: PCCK0: goto Abk6V; stjWk: $order = "\x69\x64\40\x64\145\x73\x63"; goto JMFHE; qb1gy: } public function getSubjectCombination($id) { $record = Db::table("\x73\165\x62\152\145\143\164\x5f\143\157\x6d\x62\151\x6e\141\164\x69\157\156")->where("\151\x64", $id)->field("\52")->find(); return $record; } public function saveSubjectCombination($id, $data) { goto q_Be1; QHWQV: wexception("\xe8\257\xb7\351\x80\x89\xe6\x8b\xa9\xe9\x87\x8f\xe8\241\xa8"); goto ZTMyG; efPe4: $id = Db::table("\x73\165\142\152\x65\x63\x74\137\143\x6f\155\x62\151\156\x61\164\151\x6f\x6e")->insertGetId($data); goto hf97D; WRT32: $data["\x62\x61\156\156\x65\x72"] = $banner; goto Xs9db; uh43Q: WB0N_: goto efPe4; ekQfo: if (!(count(explode("\x2c", $data["\163\x75\142\x6a\x65\x63\164\x73"])) > 20)) { goto aYpGX; } goto hIpUo; GuH9k: c91q2: goto ekQfo; fu2qi: OperationLogs::I()->subjecCombinationtLog("\346\226\260\345\xa2\x9e\347\xbb\x84\xe5\x90\210\351\207\x8f\350\xa1\xa8\40\x2d\x20{$data["\x6e\x61\x6d\x65"]}", beautifyLogArray($data, [], "\163\x75\x62\x6a\x65\x63\164\x5f\143\157\155\x62\151\x6e\141\x74\151\x6f\x6e"), OperationLogs::OPT_ADD_TYPE, $id); goto YelTY; O_NF6: if (!$banner) { goto YII71; } goto WRT32; Xs9db: YII71: goto fW_7o; K7omA: goto CKtJW; goto uh43Q; YztTQ: $data["\155\x74\x69\155\x65"] = date("\131\x2d\155\x2d\144\40\110\x3a\x69\72\x73"); goto yrAo8; YDMI9: Db::table("\163\x75\142\152\x65\x63\164\137\143\157\155\x62\x69\156\141\x74\151\157\x6e")->where(["\151\x64" => $id])->update($data); goto r32Ej; r32Ej: OperationLogs::I()->subjecCombinationtLog("\xe4\xbf\256\346\x94\271\xe7\273\x84\xe5\220\210\xe9\x87\217\350\xa1\250\x20\55\x20{$data["\156\141\155\x65"]}", beautifyLogArray($data, $originals, "\163\x75\142\x6a\x65\143\x74\137\x63\157\155\142\x69\156\x61\164\x69\157\156"), OperationLogs::OPT_UPDATE_TYPE, $id); goto K7omA; DZM56: if (!(count(explode("\x2c", $data["\x73\165\142\x6a\145\x63\164\x73"])) == 1)) { goto c91q2; } goto f5b2n; q_Be1: if (!empty($data["\163\165\142\152\x65\143\164\163"])) { goto uFatW; } goto QHWQV; ZNeLJ: $banner = autoGenerateBannerImage($data["\x6e\141\155\x65"], $data["\x62\x61\x6e\x6e\145\162"]); goto O_NF6; yrAo8: $originals = Db::table("\x73\x75\x62\152\x65\143\164\x5f\x63\x6f\155\142\x69\x6e\x61\x74\x69\157\x6e")->where(["\151\x64" => $id])->field(true)->find(); goto YDMI9; hIpUo: wexception("\344\xb8\x8d\350\203\xbd\xe9\x80\211\346\x8b\xa9\350\xb6\205\350\277\207\62\60\xe4\270\252\344\273\xa5\344\xb8\212\351\207\217\350\xa1\250"); goto PSHZa; LLx9u: BNCWX: goto fu2qi; ZTMyG: uFatW: goto DZM56; irsgM: wexception("\xe6\267\xbb\345\212\240\xe5\xa4\261\350\264\245"); goto LLx9u; PSHZa: aYpGX: goto ZNeLJ; hf97D: if (!empty($id)) { goto BNCWX; } goto irsgM; f5b2n: wexception("\350\xaf\267\351\200\x89\xe6\213\251\xe4\xb8\244\344\270\252\xe4\273\245\xe4\xb8\212\xe9\x87\217\350\241\250"); goto GuH9k; fW_7o: if (empty($id)) { goto WB0N_; } goto YztTQ; YelTY: CKtJW: goto Ox3df; Ox3df: } public function deleteSubjectCombination($id) { goto HRZFu; HRZFu: Db::table("\x73\165\142\x6a\x65\143\164\137\x63\x6f\155\x62\151\156\141\164\151\157\x6e")->where(["\151\x64" => $id])->update(["\x64\x65\154\x65\164\145\x5f\x66\x6c\141\147" => 1]); goto Pzisu; Pzisu: $name = Db::table("\x73\x75\x62\152\145\x63\x74\137\x63\x6f\155\142\x69\156\141\164\x69\157\156")->where(["\151\x64" => $id])->value("\x6e\x61\x6d\x65"); goto M_wrY; M_wrY: OperationLogs::I()->subjecCombinationtLog("\345\210\xa0\xe9\231\xa4\347\xbb\x84\xe5\x90\x88\xe9\207\217\xe8\xa1\250", $name, OperationLogs::OPT_DELETE_TYPE, $id); goto vZ0yB; vZ0yB: } public function deleteForceSubjectCombination($id) { goto Q1kum; KAix1: Db::table("\x73\165\x62\152\145\x63\164\137\x63\x6f\155\142\151\156\141\x74\151\x6f\156")->where(["\x69\144" => $id])->delete(); goto P5Y2a; oWJs3: Mqv5x: goto F_ma2; zqHks: Db::table("\163\165\142\152\145\143\x74\137\x6f\162\144\145\x72")->where(["\143\142\x5f\157\162\144\145\x72\x5f\x69\144" => ["\151\156", $orderIds]])->delete(); goto oWJs3; Q1kum: $orderIds = Db::table("\x63\157\155\x62\151\156\141\164\x69\157\156\x5f\157\162\x64\x65\162")->where(["\143\x6f\x6d\142\151\x6e\141\164\151\157\x6e\x5f\x69\x64" => $id])->column("\151\x64"); goto F9NLH; F_ma2: Db::table("\143\157\x6d\142\x69\156\x61\x74\x69\x6f\156\137\157\162\x64\145\162")->where(["\143\x6f\155\142\x69\x6e\141\164\x69\x6f\x6e\137\x69\144" => $id])->delete(); goto KAix1; F9NLH: if (!$orderIds) { goto Mqv5x; } goto zqHks; P5Y2a: } public function qrcode($id) { goto F0jSj; SH8St: bV9JX: goto XHGFY; m2eTJ: try { goto hfMF0; f0aOQ: C2xeb: goto PQ8N3; PQ8N3: if (!(!$res || !isset($res["\164\151\143\x6b\145\164"]))) { goto VknRY; } goto ztXx2; peQzd: $url = $app->qrcode->url($res["\x74\151\x63\153\145\164"]); goto YKyzG; hfMF0: $res = $app->qrcode->forever($scene_id); goto tCbaW; tCbaW: if (!$res) { goto C2xeb; } goto QnaVk; v8Jo1: VknRY: goto peQzd; ztXx2: exception("\xe6\216\xa5\345\217\xa3\350\xbf\x94\345\233\x9e\345\xa4\xb1\350\xb4\xa5\x2c\x20" . var_export($res, true)); goto v8Jo1; QnaVk: Log::notice("\163\x75\142\152\145\x63\164\x20\143\157\155\142\x69\x6e\x61\164\x69\x6f\x6e\40\x71\162\x63\x6f\x64\145\x20\x72\145\x74\x75\162\156\x20" . var_export($res, true)); goto f0aOQ; YKyzG: } catch (\Exception $e) { wexception("\xe7\x94\x9f\xe6\210\x90\345\xa4\xb1\xe8\264\xa5\xef\274\x9a" . $e->getMessage()); } goto NgmAf; nTzrs: mu9_h: goto E7LPZ; F0jSj: $subject = Db::table("\x73\x75\x62\152\x65\143\164\137\143\x6f\155\142\x69\x6e\x61\164\151\x6f\x6e")->where(["\x69\x64" => $id])->find(); goto JkdyW; cHQm6: if (systemSetting("\x57\x58\137\x4f\x46\x46\x49\x43\x45\137\x41\103\103\x4f\x55\x4e\x54\137\101\120\x50\x5f\111\x44")) { goto bV9JX; } goto SBLMi; JkdyW: if ($subject) { goto m1zkF; } goto p8Upb; XHGFY: wxPaySetting(); goto uKd1u; uKd1u: $app = \EasyWeChat\Factory::officialAccount(config("\167\170\56\x6f\146\x66\x69\x63\x69\141\x6c\x5f\141\143\x63\x6f\x75\156\x74")); goto rM15f; zauYJ: $result = file_put_contents(SITE_DIR . $path, file_get_contents($url)); goto v1iZc; rM15f: $scene_id = "\x63\157\155\142\151\x6e\141\164\151\157\156\137\x69\x64\x5f" . $id; goto m2eTJ; b2WZu: m1zkF: goto cHQm6; E7LPZ: Db::table("\163\165\142\x6a\145\143\164\137\143\157\x6d\142\151\156\x61\x74\x69\x6f\x6e")->where(["\151\x64" => $id])->setField("\161\x72\x63\157\x64\x65", $path); goto iMN7W; v1iZc: if ($result) { goto mu9_h; } goto GrO1R; GrO1R: wexception("\345\206\231\345\x85\xa5\345\233\xbe\xe5\x83\x8f\346\226\207\344\273\xb6\345\244\261\350\xb4\xa5"); goto nTzrs; SBLMi: wexception("\347\224\237\xe6\x88\220\345\244\xb1\xe8\264\245\xef\274\x9a\346\234\252\351\x85\215\347\xbd\256\xe5\x85\254\344\xbc\x97\xe5\217\xb7\xe5\x8f\x82\xe6\x95\xb0"); goto SH8St; NgmAf: $path = "\x2f\x71\x72\143\x6f\x64\145\x2f" . $scene_id . "\56\152\x70\147"; goto zauYJ; iMN7W: return $path; goto z6dlU; p8Upb: wexception("\346\227\240\346\263\225\346\211\276\345\210\xb0\350\xaf\xa5\351\207\x8f\xe8\241\xa8"); goto b2WZu; z6dlU: } }

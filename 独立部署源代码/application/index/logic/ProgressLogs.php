<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; use app\index\logic\Defs; use app\index\logic\Attachments as AttachmentsLogic; class ProgressLogs extends Base { const PROGRESS_LOG_ALL_CATEGORY = 0; const PROGRESS_LOG_FUND_COLLECT_CATEGORY = 1; const EVENT_LOG_FUND_MANAGE_CATEGORY = 2; const SHAREHOLDER_DECISION_CATEGORY = 3; const INVESTED_SUPPORT_CATEGORY = 5; const INVESTED_PROGRESS_CATEGORY = 6; const PROGRESS_LOG_PARTNER_CATEGORY = 7; public static $progressLogCategoryDefs = array(self::PROGRESS_LOG_FUND_COLLECT_CATEGORY => "\345\237\272\351\207\221\345\x8b\237\xe9\x9b\x86\xe8\xbf\233\xe5\272\xa6", self::EVENT_LOG_FUND_MANAGE_CATEGORY => "\xe5\x9f\xba\351\x87\221\347\256\241\xe7\x90\206\xe4\xba\x8b\344\273\xb6", self::SHAREHOLDER_DECISION_CATEGORY => "\344\274\232\350\xae\256\xe5\x86\xb3\xe8\256\xae", self::INVESTED_SUPPORT_CATEGORY => "\346\212\225\xe5\x90\216\346\x94\257\346\x8c\201", self::INVESTED_PROGRESS_CATEGORY => "\xe8\xbf\x9b\xe5\xb1\x95\346\217\217\xe8\277\260", self::PROGRESS_LOG_PARTNER_CATEGORY => "\xe5\x90\x88\xe4\xbc\x99\344\272\272\xe8\xbf\x9b\345\xb1\225"); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\160\162\157\147\x72\145\163\x73\x5f\154\x6f\x67\137\151\x64", $order = "\144\145\163\143", $category = \app\index\logic\ProgressLogs::PROGRESS_LOG_ALL_CATEGORY, $externalId = 0) { goto AbTZF; VrZzt: $order = "\160\x72\157\x67\162\145\x73\163\137\154\157\x67\x5f\151\144\x20" . $order; goto KMvMp; qpyZ0: $admins = Db::table("\x61\x64\x6d\151\156\163")->where("\141\144\155\x69\x6e\x5f\151\x64", "\x69\156", $admin_ids)->column("\x72\145\x61\154\x6e\x61\x6d\x65", "\x61\144\155\151\x6e\x5f\x69\144"); goto rFJXI; rvxsH: $conditions["\x63\141\164\x65\x67\157\x72\x79"] = $category; goto nMGes; rFJXI: foreach ($records as $k => $v) { goto fm6Wr; TN7Ni: $records[$k]["\x72\145\141\154\156\x61\155\145"] = $admins[$v["\x61\144\x6d\x69\x6e\137\151\x64"]]; goto Pus0v; riYKE: Kqo6v: goto ddqrS; fm6Wr: if ($v["\x63\157\x6e\164\x61\x63\x74\137\x69\x64"]) { goto oLAed; } goto TN7Ni; Pus0v: goto bT7th; goto nS5lz; PA742: bT7th: goto riYKE; U1xOD: $records[$k]["\x72\145\x61\154\156\141\155\145"] = $contacts[$v["\143\x6f\156\x74\141\x63\164\137\x69\144"]] . "\xef\xbc\x88\351\xa1\271\347\x9b\xae\346\x96\271\357\xbc\211"; goto PA742; nS5lz: oLAed: goto U1xOD; ddqrS: } goto FyoHO; YpFDH: $contact_ids = []; goto hLW6e; GnJic: $contacts = Db::table("\x63\x6f\156\x74\141\143\x74\x73")->where("\151\144", "\151\156", $contact_ids)->column("\156\141\x6d\x65", "\x69\144"); goto qpyZ0; WIYxp: if ($sort == "\160\x72\x6f\147\x72\x65\163\x73\137\x6c\157\x67\137\x69\144") { goto LhVg5; } goto IcAh5; KMvMp: fvnaD: goto okk17; OzDCw: $totalCount = Db::table("\x70\x72\157\147\x72\145\163\x73\137\x6c\x6f\x67\163")->where($conditions)->count(); goto zuLSh; sNw3K: $admin_ids = []; goto YpFDH; AbTZF: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto WIYxp; N65FC: LhVg5: goto VrZzt; mWfST: return ["\x74\x6f\164\x61\154" => $totalCount, "\162\157\x77\x73" => $records]; goto R7s2s; Zytnt: goto fvnaD; goto N65FC; nMGes: ClcuK: goto OzDCw; zuLSh: $records = Db::table("\160\162\157\x67\x72\x65\x73\163\137\154\x6f\147\163")->where($conditions)->limit($limit)->order($order)->select(); goto sNw3K; okk17: $conditions = ["\145\x78\x74\145\x72\156\141\x6c\137\151\144" => $externalId]; goto hfmWZ; yU7ae: uEWV4: goto GnJic; hLW6e: foreach ($records as $v) { goto zEa2w; z33ZV: v5m8Z: goto cGozn; fL0gB: $contact_ids[$v["\x63\157\x6e\x74\x61\x63\164\137\151\144\x73"]] = $v["\143\157\156\164\x61\143\x74\x5f\x69\x64"]; goto z33ZV; zEa2w: $admin_ids[$v["\141\x64\x6d\x69\x6e\137\x69\144"]] = $v["\141\144\155\x69\x6e\x5f\151\x64"]; goto fL0gB; cGozn: } goto yU7ae; hfmWZ: if (!$category) { goto ClcuK; } goto rvxsH; IcAh5: $order = "\160\162\157\147\x72\145\x73\x73\137\154\x6f\147\x5f\151\144\x20\144\145\163\143"; goto Zytnt; FyoHO: NTFyX: goto mWfST; R7s2s: } public function get($id) { goto q1_gw; IZ213: TopTA: goto y9p7m; q1_gw: $row = Db::table("\160\162\157\x67\x72\x65\163\163\x5f\154\157\147\x73")->where("\160\162\x6f\x67\x72\145\x73\x73\137\x6c\x6f\x67\x5f\151\x64", $id)->find(); goto zjJIv; zjJIv: if (!empty($row)) { goto TopTA; } goto zF4Mp; zF4Mp: $row = []; goto IZ213; y9p7m: return $row; goto ogoJq; ogoJq: } public function add($category, $externalId, $infos) { goto GPU2G; s2crp: $datas["\145\170\x74\x65\x72\x6e\x61\x6c\137\x69\144"] = $externalId; goto c0g27; TuEH2: $datas["\x63\x61\164\145\x67\x6f\162\x79"] = $category; goto s2crp; yD4FY: AttachmentsLogic::I()->relateAttaches($infos["\x61\164\x74\x61\143\x68\x65\163"], $newProgressLogId); goto g2aqP; j2nm4: $datas["\141\144\x6d\151\156\x5f\x69\144"] = intval(RequestContext::I()->loginUserId); goto ZVCbb; xFypM: $datas["\164\x69\164\154\x65"] = empty($infos["\x74\151\164\154\145"]) ? '' : $infos["\x74\151\164\154\x65"]; goto Eu7za; g2aqP: be2yc: goto isbST; Eu7za: $datas["\145\156\164\x72\171"] = !emptyInArray($infos, "\145\156\x74\162\171") ? $infos["\145\156\164\x72\171"] : ''; goto Bhpcc; WH9IM: $newProgressLogId = Db::table("\160\162\157\147\162\x65\x73\x73\137\x6c\157\x67\163")->insertGetId($datas); goto irF10; c0g27: $datas["\157\x63\143\165\x72\x5f\144\x61\164\x65"] = !emptyInArray($infos, "\157\143\143\x75\162\x5f\x64\x61\164\x65") ? $infos["\157\143\x63\x75\x72\x5f\144\141\x74\145"] : null; goto xFypM; ZVCbb: $datas["\x73\150\x6f\167\x5f\x74\151\155\145\x6c\x69\156\145"] = intval($infos["\163\x68\x6f\x77\x5f\x74\x69\155\x65\154\x69\156\x65"]); goto WH9IM; irF10: if (!$infos["\141\164\164\141\143\x68\x65\x73"]) { goto be2yc; } goto yD4FY; GPU2G: $datas = []; goto TuEH2; Bhpcc: $datas["\145\156\164\145\162\145\x64"] = date("\131\55\x6d\x2d\144\x20\110\72\151\x3a\163"); goto j2nm4; isbST: return true; goto TJKm2; TJKm2: } public function delete($progressLogId) { goto gyCNQ; xdc1w: $result = Db::table("\x70\162\x6f\x67\x72\145\163\163\x5f\x6c\157\147\x73")->where("\x70\162\x6f\x67\162\145\163\163\137\154\157\147\x5f\x69\144", $progressLogId)->delete(); goto OroFr; OroFr: return $result > 0 ? true : false; goto xUUop; gyCNQ: AttachmentsLogic::I()->deleteAttaches($progressLogId, AttachmentsLogic::ATTACH_PROGRESS_LOGS); goto xdc1w; xUUop: } }

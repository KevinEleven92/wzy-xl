<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; use app\index\logic\Defs; use app\index\logic\Attachments as AttachmentsLogic; class ProgressLogs extends Base { const PROGRESS_LOG_ALL_CATEGORY = 0; const PROGRESS_LOG_FUND_COLLECT_CATEGORY = 1; const EVENT_LOG_FUND_MANAGE_CATEGORY = 2; const SHAREHOLDER_DECISION_CATEGORY = 3; const INVESTED_SUPPORT_CATEGORY = 5; const INVESTED_PROGRESS_CATEGORY = 6; const PROGRESS_LOG_PARTNER_CATEGORY = 7; public static $progressLogCategoryDefs = array(self::PROGRESS_LOG_FUND_COLLECT_CATEGORY => "\xe5\x9f\xba\xe9\x87\221\345\x8b\x9f\351\233\206\350\277\x9b\xe5\272\246", self::EVENT_LOG_FUND_MANAGE_CATEGORY => "\345\x9f\xba\351\x87\221\xe7\xae\241\xe7\x90\206\xe4\272\213\344\xbb\266", self::SHAREHOLDER_DECISION_CATEGORY => "\344\274\232\350\xae\xae\345\206\xb3\350\xae\256", self::INVESTED_SUPPORT_CATEGORY => "\346\x8a\x95\xe5\x90\216\xe6\224\xaf\346\214\201", self::INVESTED_PROGRESS_CATEGORY => "\350\277\233\xe5\xb1\225\346\x8f\x8f\xe8\277\260", self::PROGRESS_LOG_PARTNER_CATEGORY => "\xe5\220\x88\344\xbc\x99\344\xba\xba\350\277\x9b\xe5\xb1\225"); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\x70\x72\x6f\x67\x72\145\163\x73\137\154\x6f\x67\x5f\x69\144", $order = "\x64\145\163\143", $category = \app\index\logic\ProgressLogs::PROGRESS_LOG_ALL_CATEGORY, $externalId = 0) { goto rf9b0; kAARO: $records = Db::table("\x70\x72\x6f\147\162\145\x73\163\137\154\157\x67\x73")->where($conditions)->limit($limit)->order($order)->select(); goto bEoMV; S_PEH: $conditions["\143\141\x74\x65\147\157\x72\171"] = $category; goto DNClI; pTOeY: $totalCount = Db::table("\x70\162\x6f\x67\x72\145\x73\x73\137\x6c\x6f\147\163")->where($conditions)->count(); goto kAARO; YgGjQ: $contacts = Db::table("\143\x6f\x6e\x74\141\x63\164\x73")->where("\x69\144", "\151\156", $contact_ids)->column("\156\141\x6d\x65", "\x69\144"); goto SIHpx; Q_FqU: B_eD0: goto Mkbc1; y0U2C: aODHB: goto YgGjQ; bEoMV: $admin_ids = []; goto zM39V; P224X: foreach ($records as $v) { goto oRJY1; qkSKH: $contact_ids[$v["\x63\x6f\x6e\x74\x61\143\x74\x5f\x69\144\163"]] = $v["\x63\157\x6e\164\141\x63\164\137\151\144"]; goto HakRY; HakRY: tTinB: goto Fiq2g; oRJY1: $admin_ids[$v["\141\x64\x6d\x69\x6e\137\151\144"]] = $v["\x61\x64\x6d\151\156\137\x69\144"]; goto qkSKH; Fiq2g: } goto y0U2C; uayHk: $conditions = ["\x65\x78\164\x65\x72\156\x61\154\x5f\x69\x64" => $externalId]; goto jBEDp; QY_Qx: $order = "\x70\x72\x6f\x67\162\145\163\163\x5f\x6c\157\147\x5f\x69\144\40" . $order; goto oA8Wj; Mkbc1: return ["\164\x6f\x74\141\x6c" => $totalCount, "\162\x6f\x77\163" => $records]; goto SQd67; gEKrR: ZuM3z: goto QY_Qx; DNClI: FGmRX: goto pTOeY; SIHpx: $admins = Db::table("\x61\144\155\x69\156\163")->where("\x61\144\x6d\151\x6e\137\x69\x64", "\x69\x6e", $admin_ids)->column("\x72\x65\x61\x6c\156\141\x6d\145", "\141\x64\x6d\x69\156\x5f\x69\144"); goto ASNTe; CVwqh: goto vTX4W; goto gEKrR; Ez8L9: $order = "\160\x72\x6f\147\162\145\x73\163\137\154\157\147\137\151\x64\40\144\145\163\143"; goto CVwqh; zM39V: $contact_ids = []; goto P224X; jBEDp: if (!$category) { goto FGmRX; } goto S_PEH; ASNTe: foreach ($records as $k => $v) { goto IBK_2; T4T_M: LVVrF: goto yWQiB; p_rKh: goto LVVrF; goto nyBbC; nKsSe: $records[$k]["\162\145\141\x6c\x6e\x61\155\145"] = $admins[$v["\x61\x64\155\151\x6e\x5f\x69\x64"]]; goto p_rKh; HS92s: $records[$k]["\162\145\x61\x6c\x6e\x61\155\145"] = $contacts[$v["\143\157\156\164\141\x63\x74\x5f\151\144"]] . "\xef\274\210\351\241\xb9\347\233\256\xe6\x96\271\357\xbc\211"; goto T4T_M; yWQiB: P166I: goto eOc7X; IBK_2: if ($v["\x63\157\x6e\164\141\143\x74\x5f\151\x64"]) { goto KaNEM; } goto nKsSe; nyBbC: KaNEM: goto HS92s; eOc7X: } goto Q_FqU; oA8Wj: vTX4W: goto uayHk; rf9b0: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto CnrH8; CnrH8: if ($sort == "\160\162\157\147\x72\x65\x73\x73\137\x6c\x6f\x67\137\x69\x64") { goto ZuM3z; } goto Ez8L9; SQd67: } public function get($id) { goto qJlUh; GVtUu: $row = []; goto xu7VB; W0K3I: if (!empty($row)) { goto eA9nF; } goto GVtUu; sukaI: return $row; goto UyU4v; qJlUh: $row = Db::table("\160\162\x6f\x67\162\145\163\163\137\x6c\157\147\163")->where("\160\162\x6f\x67\x72\x65\x73\163\137\154\x6f\x67\x5f\x69\144", $id)->find(); goto W0K3I; xu7VB: eA9nF: goto sukaI; UyU4v: } public function add($category, $externalId, $infos) { goto G11dG; G11dG: $datas = []; goto b_x8F; i3syX: AttachmentsLogic::I()->relateAttaches($infos["\141\164\164\x61\x63\150\x65\163"], $newProgressLogId); goto dBe4a; b_x8F: $datas["\143\141\164\145\147\x6f\162\x79"] = $category; goto trFxQ; vFVz6: $newProgressLogId = Db::table("\160\162\157\147\x72\x65\163\x73\137\154\x6f\x67\x73")->insertGetId($datas); goto HVkgb; dBe4a: dFy0L: goto TUVfw; HVkgb: if (!$infos["\x61\164\x74\141\x63\150\145\163"]) { goto dFy0L; } goto i3syX; TUVfw: return true; goto m6hLV; LgN4H: $datas["\145\x6e\x74\x65\162\145\x64"] = date("\x59\55\x6d\x2d\x64\x20\x48\72\151\72\x73"); goto dcvQE; QiwXF: $datas["\145\156\x74\x72\171"] = !emptyInArray($infos, "\145\156\164\162\171") ? $infos["\x65\x6e\x74\162\x79"] : ''; goto LgN4H; aoKym: $datas["\x74\151\164\x6c\145"] = empty($infos["\x74\151\x74\154\145"]) ? '' : $infos["\164\x69\x74\x6c\145"]; goto QiwXF; A2pqB: $datas["\163\x68\157\167\x5f\164\x69\x6d\145\x6c\x69\x6e\x65"] = intval($infos["\x73\150\x6f\167\137\x74\x69\155\x65\154\151\x6e\145"]); goto vFVz6; EtKOx: $datas["\157\x63\x63\165\x72\x5f\144\x61\x74\145"] = !emptyInArray($infos, "\157\143\143\165\162\137\x64\141\164\145") ? $infos["\157\x63\143\x75\x72\137\144\x61\164\145"] : null; goto aoKym; dcvQE: $datas["\141\144\x6d\x69\156\137\x69\x64"] = intval(RequestContext::I()->loginUserId); goto A2pqB; trFxQ: $datas["\145\x78\x74\145\x72\156\141\x6c\137\x69\144"] = $externalId; goto EtKOx; m6hLV: } public function delete($progressLogId) { goto zNr7K; zNr7K: AttachmentsLogic::I()->deleteAttaches($progressLogId, AttachmentsLogic::ATTACH_PROGRESS_LOGS); goto E02bQ; SYmey: return $result > 0 ? true : false; goto jqeSE; E02bQ: $result = Db::table("\160\x72\157\147\162\145\x73\163\x5f\154\x6f\x67\x73")->where("\160\x72\x6f\x67\162\145\163\x73\x5f\x6c\157\x67\x5f\151\144", $progressLogId)->delete(); goto SYmey; jqeSE: } }

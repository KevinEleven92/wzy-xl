<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; use app\index\logic\Defs; use app\index\logic\Attachments as AttachmentsLogic; class ProgressLogs extends Base { const PROGRESS_LOG_ALL_CATEGORY = 0; const PROGRESS_LOG_FUND_COLLECT_CATEGORY = 1; const EVENT_LOG_FUND_MANAGE_CATEGORY = 2; const SHAREHOLDER_DECISION_CATEGORY = 3; const INVESTED_SUPPORT_CATEGORY = 5; const INVESTED_PROGRESS_CATEGORY = 6; const PROGRESS_LOG_PARTNER_CATEGORY = 7; public static $progressLogCategoryDefs = array(self::PROGRESS_LOG_FUND_COLLECT_CATEGORY => "\xe5\x9f\xba\351\x87\x91\345\x8b\x9f\351\x9b\206\xe8\277\x9b\345\xba\246", self::EVENT_LOG_FUND_MANAGE_CATEGORY => "\xe5\237\272\xe9\x87\x91\xe7\xae\xa1\347\220\x86\344\xba\x8b\344\273\xb6", self::SHAREHOLDER_DECISION_CATEGORY => "\xe4\274\x9a\350\xae\256\345\206\263\xe8\256\256", self::INVESTED_SUPPORT_CATEGORY => "\346\x8a\x95\xe5\220\x8e\346\x94\xaf\xe6\214\201", self::INVESTED_PROGRESS_CATEGORY => "\350\277\x9b\345\xb1\225\346\x8f\x8f\350\277\xb0", self::PROGRESS_LOG_PARTNER_CATEGORY => "\xe5\220\210\xe4\274\x99\344\xba\xba\xe8\xbf\x9b\xe5\261\225"); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\160\162\x6f\x67\162\145\x73\x73\x5f\154\157\x67\x5f\151\144", $order = "\x64\x65\x73\x63", $category = \app\index\logic\ProgressLogs::PROGRESS_LOG_ALL_CATEGORY, $externalId = 0) { goto W763V; cdzPu: $records = Db::table("\160\x72\157\147\162\x65\163\163\137\154\157\147\163")->where($conditions)->limit($limit)->order($order)->select(); goto rSSRO; EguQd: $conditions = ["\x65\170\164\x65\x72\156\x61\154\x5f\x69\144" => $externalId]; goto ikk5q; SMB17: pJcI1: goto my33i; rSSRO: $admin_ids = []; goto LwNRJ; N8Kj2: OyP4s: goto EguQd; F52uE: foreach ($records as $v) { goto mfY2k; t3JQ9: iUa12: goto SelM_; gaR_X: $contact_ids[$v["\x63\x6f\156\164\141\x63\164\137\x69\x64\x73"]] = $v["\143\157\156\164\x61\x63\164\x5f\x69\x64"]; goto t3JQ9; mfY2k: $admin_ids[$v["\x61\x64\155\x69\156\137\x69\x64"]] = $v["\x61\x64\x6d\x69\x6e\137\151\x64"]; goto gaR_X; SelM_: } goto H8H8M; nC7F_: IT4iL: goto x1hwF; f09ot: $contacts = Db::table("\x63\157\x6e\x74\141\x63\164\163")->where("\151\144", "\x69\156", $contact_ids)->column("\x6e\141\x6d\145", "\x69\144"); goto g8yEF; ikk5q: if (!$category) { goto FgpvA; } goto KIaCg; tk1Vv: FgpvA: goto hik66; stih2: goto OyP4s; goto nC7F_; g8yEF: $admins = Db::table("\x61\144\155\x69\x6e\x73")->where("\x61\x64\x6d\x69\156\x5f\x69\x64", "\151\156", $admin_ids)->column("\162\145\141\154\x6e\141\155\x65", "\x61\144\x6d\x69\156\x5f\151\144"); goto J1Yux; C5_ae: $order = "\160\162\x6f\147\x72\x65\163\x73\x5f\154\157\147\137\151\144\x20\144\145\163\143"; goto stih2; LwNRJ: $contact_ids = []; goto F52uE; ZMCvD: if ($sort == "\x70\162\157\147\162\x65\x73\163\137\154\157\147\x5f\x69\144") { goto IT4iL; } goto C5_ae; my33i: return ["\x74\157\164\141\x6c" => $totalCount, "\x72\157\167\163" => $records]; goto Q9uX4; J1Yux: foreach ($records as $k => $v) { goto cvtQx; Yvbn0: $records[$k]["\x72\145\x61\154\156\x61\155\x65"] = $contacts[$v["\x63\x6f\156\x74\141\143\x74\x5f\x69\144"]] . "\xef\xbc\210\351\241\271\347\233\256\346\x96\xb9\357\xbc\x89"; goto werqI; vrSVa: $records[$k]["\162\145\x61\x6c\156\x61\x6d\x65"] = $admins[$v["\x61\144\155\x69\156\137\151\x64"]]; goto aPVQT; cvtQx: if ($v["\143\157\x6e\164\141\143\x74\x5f\151\144"]) { goto uTS0h; } goto vrSVa; bz8XR: Cymzf: goto w8_Gg; aPVQT: goto yLSkU; goto Ys2qG; werqI: yLSkU: goto bz8XR; Ys2qG: uTS0h: goto Yvbn0; w8_Gg: } goto SMB17; x1hwF: $order = "\160\162\x6f\147\162\145\x73\163\x5f\154\x6f\x67\137\x69\144\40" . $order; goto N8Kj2; hik66: $totalCount = Db::table("\160\x72\157\147\162\145\163\x73\137\x6c\157\x67\x73")->where($conditions)->count(); goto cdzPu; KIaCg: $conditions["\x63\141\x74\x65\x67\157\162\171"] = $category; goto tk1Vv; W763V: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto ZMCvD; H8H8M: GlpDH: goto f09ot; Q9uX4: } public function get($id) { goto rHMM4; Hxd0r: $row = []; goto DbZcp; vOGCQ: return $row; goto KqvF9; bkFVg: if (!empty($row)) { goto WPTMV; } goto Hxd0r; DbZcp: WPTMV: goto vOGCQ; rHMM4: $row = Db::table("\160\x72\157\x67\x72\x65\163\163\137\154\157\147\x73")->where("\160\162\x6f\x67\x72\145\163\x73\x5f\154\x6f\147\x5f\151\144", $id)->find(); goto bkFVg; KqvF9: } public function add($category, $externalId, $infos) { goto YiJ_7; Awe1Z: WdliB: goto KY3fI; OUaCD: $datas["\x65\156\x74\x65\162\x65\144"] = date("\x59\x2d\x6d\x2d\x64\40\x48\72\x69\72\163"); goto jlDW0; S6Gn3: $datas["\164\151\x74\x6c\145"] = empty($infos["\x74\x69\x74\154\145"]) ? '' : $infos["\x74\x69\x74\x6c\145"]; goto RjRI4; koat4: AttachmentsLogic::I()->relateAttaches($infos["\x61\164\164\x61\x63\x68\x65\163"], $newProgressLogId); goto Awe1Z; RjRI4: $datas["\145\x6e\x74\162\171"] = !emptyInArray($infos, "\145\156\164\x72\171") ? $infos["\x65\x6e\164\162\171"] : ''; goto OUaCD; jlDW0: $datas["\141\x64\155\151\156\x5f\x69\x64"] = intval(RequestContext::I()->loginUserId); goto AIm2d; FH_zp: $datas["\143\x61\x74\145\x67\x6f\x72\171"] = $category; goto ZJCpY; j3VD6: if (!$infos["\x61\x74\164\x61\143\150\x65\163"]) { goto WdliB; } goto koat4; v1cIh: $newProgressLogId = Db::table("\160\x72\x6f\147\162\x65\163\x73\137\x6c\x6f\x67\x73")->insertGetId($datas); goto j3VD6; AFKDP: $datas["\x6f\x63\x63\x75\x72\x5f\x64\x61\x74\x65"] = !emptyInArray($infos, "\157\x63\143\x75\162\x5f\x64\141\164\145") ? $infos["\x6f\143\x63\x75\x72\x5f\144\x61\164\x65"] : null; goto S6Gn3; AIm2d: $datas["\163\150\157\167\x5f\164\151\x6d\145\154\x69\156\x65"] = intval($infos["\x73\x68\157\x77\137\x74\x69\x6d\x65\x6c\151\156\145"]); goto v1cIh; YiJ_7: $datas = []; goto FH_zp; ZJCpY: $datas["\145\170\x74\145\x72\156\141\154\137\x69\x64"] = $externalId; goto AFKDP; KY3fI: return true; goto Kg2si; Kg2si: } public function delete($progressLogId) { goto DrLXt; BanY8: $result = Db::table("\x70\x72\x6f\147\162\x65\163\x73\x5f\x6c\x6f\147\x73")->where("\160\x72\157\147\162\145\x73\x73\x5f\154\157\147\137\x69\x64", $progressLogId)->delete(); goto Yb0I6; DrLXt: AttachmentsLogic::I()->deleteAttaches($progressLogId, AttachmentsLogic::ATTACH_PROGRESS_LOGS); goto BanY8; Yb0I6: return $result > 0 ? true : false; goto JEgvL; JEgvL: } }

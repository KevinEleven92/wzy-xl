<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\service\RequestContext; class SurveyOrganization extends Base { public function loadTreeDatas($surveyId) { goto T8p2r; Ulsxe: return $treeDatas; goto vJijb; DfVxP: $treeDatas[] = $this->loadTreeDataRecursively($surveyId, 0); goto Ulsxe; T8p2r: $treeDatas = []; goto DfVxP; vJijb: } protected function loadTreeDataRecursively($surveyId, $id = 0, $parentId = 0, $breadcrumbParent = '') { goto yvPNq; RHOgV: aLJmx: goto pYfVs; suUxW: $treeNodeDatas = ["\151\144" => 0, "\x70\x61\162\145\x6e\164\x5f\x69\144" => 0, "\x74\145\x78\x74" => $text, "\x69\143\157\x6e\103\x6c\163" => "\x66\x61\40\146\141\x2d\143\x69\x72\x63\x6c\145", "\x73\x74\141\x74\x65" => "\157\160\145\156", "\x63\150\x69\154\x64\162\145\x6e" => [], "\142\162\x65\141\x64\143\x72\165\x6d\x62" => $breadcrumb]; goto x8gbN; ZVY3A: goto piAgO; goto O3IYp; pYfVs: return $treeNodeDatas; goto ktmrB; VbAhs: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\x20\46\x67\164\73\40" . $text; goto y0gJ0; LjXCM: $text = "\346\231\xae\346\237\xa5\xe7\xbb\x84\347\273\207"; goto ThtqL; y0gJ0: $treeNodeDatas = ["\151\x64" => $id, "\160\141\162\x65\156\x74\137\151\144" => $parentId, "\x74\145\x78\164" => $text, "\151\x63\x6f\156\x43\154\x73" => "\151\143\x6f\x6e\163\x2d\x70\157\151\156\x74", "\x73\x74\x61\x74\x65" => "\157\x70\145\x6e", "\143\150\151\x6c\144\162\x65\156" => [], "\142\162\145\x61\x64\x63\162\165\x6d\x62" => $breadcrumb]; goto ZVY3A; x8gbN: piAgO: goto GE1YH; GE1YH: $childOrganizations = Db::table("\163\165\162\166\x65\x79\x5f\x6f\162\x67\141\156\x69\172\141\164\151\157\x6e")->where(["\x70\141\x72\x65\x6e\164\137\151\x64" => $id, "\x73\x75\162\x76\x65\171\x5f\151\144" => $surveyId])->field("\x69\x64\54\156\x61\x6d\x65\54\160\x61\x72\145\156\164\137\x69\144")->order("\157\x72\144\145\162\40\141\163\143\x2c\x20\x69\144\40\141\x73\x63")->select(); goto QHEMu; Dd87X: $text = Db::table("\163\165\162\166\x65\171\x5f\x6f\162\x67\141\x6e\x69\172\x61\x74\151\157\156")->where(["\151\144" => $id])->value("\x6e\x61\x6d\x65"); goto NfomD; ThtqL: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\40\46\147\164\x3b\x20" . $text; goto suUxW; QHEMu: foreach ($childOrganizations as $childOrganization) { goto gNaHQ; GfuIB: $treeNodeDatas["\x63\x68\x69\154\x64\x72\x65\x6e"][] = $childNodeDatas; goto rp561; qQ2Aq: if (!$childNodeDatas) { goto QZW9Y; } goto GfuIB; rp561: QZW9Y: goto KB23u; gNaHQ: $childNodeDatas = $this->loadTreeDataRecursively($surveyId, $childOrganization["\151\x64"], $id, $breadcrumb); goto qQ2Aq; KB23u: pmOey: goto pzXTK; pzXTK: } goto RHOgV; NfomD: if (!($text === null)) { goto WplCK; } goto HqXNO; HqXNO: return null; goto Ugo10; yvPNq: if ($id == 0) { goto tWGhP; } goto Dd87X; Ugo10: WplCK: goto VbAhs; O3IYp: tWGhP: goto LjXCM; ktmrB: } public function loadComboDatas($surveyId, $id = 0, $prefix = '', $datas = array()) { goto ojdIf; nEyoC: dhHnC: goto kluL5; zrjeB: goto jzKXY; goto nIpwk; DqY0j: $nextPrefix = $prefix . $text; goto zrjeB; DjimO: FXUjv: goto kI9Vy; kI9Vy: $datas[$id] = $prefix . $text; goto DqY0j; tROwR: $text = Db::table("\x73\165\x72\166\145\171\137\157\162\x67\x61\x6e\151\172\141\x74\151\x6f\156")->where(["\x69\x64" => $id])->value("\x6e\x61\155\x65"); goto FduFL; KCCPw: jzKXY: goto xRvql; FduFL: if (!$prefix) { goto FXUjv; } goto CkJRA; xRvql: $childOrganizations = Db::table("\x73\x75\162\166\x65\171\x5f\x6f\162\x67\141\156\151\172\141\x74\151\157\x6e")->where(["\x70\x61\x72\145\156\164\x5f\151\x64" => $id, "\x73\165\x72\166\x65\x79\x5f\x69\x64" => $surveyId])->field("\x69\144\54\x6e\x61\155\145\54\x70\141\162\145\156\164\137\151\x64")->order("\x6f\x72\144\x65\162\x20\x61\x73\143\54\40\151\x64\x20\x61\x73\x63")->select(); goto utYSR; ojdIf: if ($id == 0) { goto y24Lv; } goto tROwR; CkJRA: $prefix .= "\x3e"; goto DjimO; DWxHh: $datas[$id] = "\55\350\xaf\267\xe9\200\x89\346\213\xa9\x2d"; goto CDftU; utYSR: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatas($surveyId, $childOrganization["\x69\x64"], $nextPrefix, $datas); iYOtG: } goto nEyoC; CDftU: $nextPrefix = ''; goto KCCPw; kluL5: return $datas; goto xygEe; nIpwk: y24Lv: goto DWxHh; xygEe: } public function loadComboDatasLeaf($surveyId, $id = 0, $prefix = '', $datas = array()) { goto W612Y; PRULt: goto XBGI2; goto F_PFC; C_bbz: $nextPrefix = ''; goto hMeAx; SlmGD: if (!($childCount == 0)) { goto XPqg8; } goto PzYiF; Bi1L0: XPqg8: goto DQ5du; vcBXM: if (!$prefix) { goto sn3VO; } goto otgOI; O_Irk: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatasLeaf($surveyId, $childOrganization["\151\144"], $nextPrefix, $datas); oq8ho: } goto MNgbx; IsUub: $childCount = Db::table("\163\165\162\166\x65\x79\137\157\162\x67\141\156\151\172\x61\x74\x69\x6f\x6e")->where(["\x70\x61\x72\x65\x6e\x74\x5f\151\144" => $id, "\x73\165\162\166\x65\171\x5f\x69\x64" => $surveyId])->count(); goto SlmGD; H5QR2: $childOrganizations = Db::table("\163\165\162\x76\x65\171\x5f\x6f\162\x67\141\x6e\x69\172\141\164\x69\x6f\156")->where(["\160\141\162\145\156\x74\137\x69\x64" => $id, "\163\x75\162\166\x65\x79\137\151\x64" => $surveyId])->field("\x69\x64\54\156\x61\x6d\145\54\160\141\x72\145\156\164\137\151\144")->order("\157\x72\144\x65\x72\40\x61\163\x63\54\40\x69\x64\40\x61\x73\143")->select(); goto O_Irk; W612Y: if ($id == 0) { goto AFrS_; } goto XgvXQ; carH7: $datas[$id] = "\55\350\257\267\351\200\211\xe6\213\xa9\x2d"; goto C_bbz; WAzED: return $datas; goto C5lGa; MNgbx: FxmHn: goto WAzED; hMeAx: XBGI2: goto H5QR2; PzYiF: $datas[$id] = $prefix . $text; goto Bi1L0; F_PFC: AFrS_: goto carH7; WagQ1: sn3VO: goto IsUub; XgvXQ: $text = Db::table("\x73\165\162\x76\x65\171\137\x6f\x72\x67\x61\x6e\x69\x7a\141\x74\151\157\156")->where(["\151\x64" => $id])->value("\x6e\141\155\145"); goto vcBXM; otgOI: $prefix .= "\76"; goto WagQ1; DQ5du: $nextPrefix = $prefix . $text; goto PRULt; C5lGa: } public function loadFullText($id, $suffix = '') { goto ODq3f; E2B3b: fyHfu: goto LxvEe; jjFyz: $fullText = $this->loadFullText($organization["\x70\x61\x72\x65\x6e\164\x5f\x69\x64"], $fullText); goto Dm4FH; RD4gi: $organization = Db::table("\x73\x75\x72\x76\145\x79\137\x6f\x72\147\141\156\x69\172\141\164\151\x6f\156")->where(["\x69\144" => $id])->field("\x6e\141\155\145\x2c\40\160\141\162\145\156\x74\137\151\x64")->find(); goto aKHWO; LxvEe: $fullText = $organization["\156\141\155\145"]; goto DRqCo; tKJOy: KWh8o: goto RD4gi; aKHWO: if (!empty($organization)) { goto fyHfu; } goto l4yZV; jrl0U: $fullText .= "\40\46\147\x74\73\x20" . $suffix; goto WYllJ; rlcOg: return $suffix; goto tKJOy; ODq3f: if (!($id == 0)) { goto KWh8o; } goto rlcOg; l4yZV: return $suffix; goto E2B3b; Dm4FH: return $fullText; goto spnQp; DRqCo: if (!$suffix) { goto wBPpt; } goto jrl0U; WYllJ: wBPpt: goto jjFyz; spnQp: } public function isEmpty($surveyId) { $count = Db::table("\163\165\162\x76\x65\x79\x5f\x6f\x72\147\141\x6e\151\x7a\141\x74\x69\157\x6e")->where(["\160\x61\162\145\156\164\x5f\151\x64" => 0, "\163\x75\162\166\x65\171\x5f\x69\x64" => $surveyId])->count(); return $count ? false : true; } public function add($surveyId, $name, $parentId) { goto smG41; vBiuz: Db::table("\x73\x75\162\x76\145\171\x5f\157\162\147\x61\x6e\x69\172\x61\164\151\157\156")->where(["\151\144" => $id])->setField("\157\x72\x64\x65\162", $id); goto baN7W; HxPZn: $id = Db::table("\163\x75\162\x76\x65\171\137\157\x72\147\x61\156\x69\x7a\141\164\151\x6f\x6e")->insertGetId($data); goto vBiuz; smG41: $data = array("\x73\x75\162\166\145\171\x5f\x69\144" => $surveyId, "\156\141\x6d\x65" => $name, "\160\141\162\145\156\164\x5f\x69\x64" => $parentId); goto HxPZn; baN7W: return true; goto C7_7u; C7_7u: } public function update($id, $name) { goto pVKPa; ULhXz: Db::table("\x73\165\162\166\x65\171\x5f\x6f\162\147\x61\156\151\172\141\164\x69\x6f\x6e")->where("\151\x64", $id)->update($data); goto l6QW1; l6QW1: return true; goto yoMde; pVKPa: $data = array("\x6e\141\155\145" => $name); goto ULhXz; yoMde: } public function delete($surveyId, $id) { goto pVij5; pVij5: $orders = Db::table("\163\x75\x72\166\145\171\137\157\162\144\x65\162")->where(["\x73\x75\x72\166\145\171\x5f\151\144" => $surveyId, "\x73\x75\162\x76\x65\x79\137\x6f\162\x67\x61\156\151\172\x61\x74\x69\x6f\x6e\137\x69\144" => $id])->field("\151\x64\x2c\40\x70\145\x72\163\x6f\x6e\141\154\137\x64\x61\x74\x61")->select(); goto vfJ8Y; Hy3gk: Db::table("\163\x75\162\x76\145\171\x5f\157\x72\x64\x65\162")->where(["\163\x75\x72\166\x65\x79\137\x69\x64" => $surveyId, "\x73\x75\x72\x76\x65\171\x5f\x6f\162\x67\141\156\x69\x7a\x61\x74\x69\x6f\156\x5f\151\x64" => $id])->setField("\x73\165\x72\166\x65\171\x5f\157\162\x67\x61\x6e\x69\172\x61\164\151\157\156\x5f\x69\x64", 0); goto YSmJY; vfJ8Y: foreach ($orders as $order) { goto s3A8n; s3A8n: $orderId = $order["\x69\x64"]; goto o1T2J; ruX0V: if (!isset($personalData["\157\x72\147\x61\156\151\172\x61\164\151\x6f\x6e"])) { goto qK4gI; } goto rtOz8; o1T2J: $personalData = json_decode($order["\160\x65\162\x73\x6f\156\x61\154\x5f\144\x61\x74\x61"], true); goto ruX0V; rtOz8: $personalData["\157\162\147\x61\x6e\151\x7a\141\x74\x69\x6f\x6e"] = 0; goto sBYQO; H7jn3: Db::table("\x73\x75\162\166\145\171\x5f\x6f\x72\x64\145\162")->where("\x69\144", $orderId)->setField("\x70\x65\162\163\157\156\x61\x6c\x5f\x64\x61\x74\x61", json_encode($personalData)); goto EfIg1; EfIg1: I7K8y: goto CX_VV; sBYQO: qK4gI: goto H7jn3; CX_VV: } goto GWf8z; bqVvj: return $result != 1 ? false : true; goto i_U3j; GWf8z: gI6h0: goto Hy3gk; YSmJY: $result = Db::table("\x73\165\x72\x76\x65\x79\x5f\157\162\x67\141\156\x69\172\x61\164\151\x6f\156")->where("\x69\x64", $id)->delete(); goto bqVvj; i_U3j: } public function up($id) { goto p1zNx; S3681: Kd6WG: goto GXOWA; mcqeQ: if (!($i == 0)) { goto MuV1d; } goto x7wjQ; fw25j: if ($i < count($siblingOrganizations)) { goto OiXF5; } goto S3681; cmF40: $order = $siblingOrganizations[$i]["\157\162\144\145\162"]; goto Xkq2U; dlT3k: Z34Nw: goto aV6AG; JvV_J: return; goto tS7pU; HiRKa: if (!($siblingOrganizations[$i]["\x69\x64"] == $id)) { goto Z34Nw; } goto mcqeQ; TwaY0: OiXF5: goto HiRKa; egTyY: $siblingOrganizations = Db::table("\163\x75\x72\x76\145\171\137\x6f\x72\x67\141\x6e\151\172\141\x74\x69\157\x6e")->where(["\x70\141\x72\x65\x6e\x74\x5f\151\x64" => $parentId])->field("\x69\x64\x2c\x6e\x61\155\x65\x2c\160\x61\x72\145\156\164\x5f\x69\x64\x2c\x6f\x72\x64\145\x72")->order("\157\162\x64\x65\162\40\x61\163\x63\54\x20\x69\144\40\141\x73\143")->select(); goto MYWDc; p1zNx: $parentId = Db::table("\x73\165\x72\166\x65\171\x5f\157\x72\x67\x61\x6e\151\172\x61\x74\151\157\x6e")->where(["\x69\144" => $id])->value("\x70\141\162\145\x6e\x74\137\151\144"); goto egTyY; MYWDc: if (!empty($siblingOrganizations)) { goto kBS6i; } goto JvV_J; MgGpY: if (!(count($siblingOrganizations) <= 1)) { goto gwPFD; } goto WQY1h; B1Ua8: $i = 0; goto TwaY0; RzM5V: MuV1d: goto cmF40; WQY1h: return; goto N0oJt; ev1u5: Db::table("\163\x75\162\166\145\171\x5f\x6f\162\147\141\x6e\x69\172\141\164\151\157\x6e")->where(["\151\144" => $id])->setField("\157\162\x64\145\162", $orderPre); goto c2sdT; N0oJt: gwPFD: goto B1Ua8; c2sdT: Db::table("\x73\165\162\166\x65\171\137\x6f\162\x67\141\156\x69\x7a\x61\x74\x69\x6f\x6e")->where(["\151\144" => $siblingOrganizations[$i - 1]["\151\144"]])->setField("\157\x72\x64\x65\162", $order); goto dlT3k; tS7pU: kBS6i: goto MgGpY; aV6AG: $i++; goto fw25j; Xkq2U: $orderPre = $siblingOrganizations[$i - 1]["\157\x72\144\x65\162"]; goto ev1u5; x7wjQ: goto Kd6WG; goto RzM5V; GXOWA: } public function down($id) { goto htW3q; RHJSD: Db::table("\163\165\162\166\x65\171\x5f\157\162\147\141\x6e\x69\172\x61\x74\151\x6f\156")->where(["\x69\x64" => $siblingOrganizations[$i + 1]["\151\x64"]])->setField("\x6f\162\144\145\x72", $order); goto L7iLL; gJx1b: return; goto qhkta; xDQfi: Db::table("\x73\x75\162\166\145\171\137\157\162\x67\141\x6e\151\x7a\x61\164\151\157\156")->where(["\x69\144" => $id])->setField("\157\x72\x64\145\162", $orderNext); goto RHJSD; tAlB9: goto gZ5oB; goto y7zou; L7iLL: fYZn3: goto T65XN; jRaSF: if (!(count($siblingOrganizations) <= 1)) { goto e3E3T; } goto tLpr7; qhkta: L6srO: goto jRaSF; Wwkr9: if (!($i == count($siblingOrganizations) - 1)) { goto BL7fP; } goto tAlB9; T65XN: $i++; goto EGkg3; ZO5Rm: $i = 0; goto Q7VGg; y7zou: BL7fP: goto WhHvO; DtFuS: if (!($siblingOrganizations[$i]["\x69\144"] == $id)) { goto fYZn3; } goto Wwkr9; pb5dn: e3E3T: goto ZO5Rm; tLpr7: return; goto pb5dn; Q7VGg: xz5U6: goto DtFuS; aN6yn: $siblingOrganizations = Db::table("\x73\165\x72\166\x65\171\x5f\157\x72\147\x61\x6e\151\172\141\164\x69\x6f\x6e")->where(["\x70\x61\x72\145\x6e\x74\x5f\151\x64" => $parentId])->field("\151\144\x2c\156\x61\155\145\x2c\160\141\x72\145\x6e\164\x5f\x69\x64\54\157\x72\144\145\162")->order("\157\x72\144\145\162\40\141\163\x63\54\x20\x69\x64\40\x61\163\143")->select(); goto bwGpg; bwGpg: if (!empty($siblingOrganizations)) { goto L6srO; } goto gJx1b; WhHvO: $order = $siblingOrganizations[$i]["\x6f\162\144\145\x72"]; goto yOXpn; yOXpn: $orderNext = $siblingOrganizations[$i + 1]["\157\x72\x64\145\162"]; goto xDQfi; EGkg3: if ($i < count($siblingOrganizations)) { goto xz5U6; } goto dUcX9; htW3q: $parentId = Db::table("\x73\165\162\166\145\171\x5f\157\162\x67\141\x6e\151\x7a\x61\x74\151\157\x6e")->where(["\151\x64" => $id])->value("\160\x61\162\145\x6e\x74\x5f\151\x64"); goto aN6yn; dUcX9: gZ5oB: goto d8Mmx; d8Mmx: } public function changeLevel($id, $parentId) { Db::table("\163\165\162\166\x65\x79\x5f\157\162\147\141\156\x69\x7a\x61\x74\x69\x6f\x6e")->where("\x69\x64", $id)->setField("\x70\x61\162\145\156\x74\x5f\151\144", $parentId); return true; } }

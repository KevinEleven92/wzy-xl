<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\service\RequestContext; class SurveyOrganization extends Base { public function loadTreeDatas($surveyId) { goto dT3gJ; A0Tcw: return $treeDatas; goto hrW6G; CY15l: $treeDatas[] = $this->loadTreeDataRecursively($surveyId, 0); goto A0Tcw; dT3gJ: $treeDatas = []; goto CY15l; hrW6G: } protected function loadTreeDataRecursively($surveyId, $id = 0, $parentId = 0, $breadcrumbParent = '') { goto QLkSP; pX31N: $treeNodeDatas = ["\x69\144" => 0, "\x70\x61\x72\145\x6e\x74\137\151\x64" => 0, "\164\x65\x78\164" => $text, "\x69\143\x6f\156\x43\x6c\163" => "\146\x61\40\146\141\x2d\x63\151\162\x63\x6c\x65", "\163\x74\x61\x74\x65" => "\157\160\x65\x6e", "\143\x68\x69\x6c\x64\x72\x65\156" => [], "\142\162\x65\x61\x64\143\162\165\x6d\142" => $breadcrumb]; goto fGiNg; nNbsu: goto GXhqk; goto Aj_fz; L_B5N: $text = "\346\231\xae\xe6\x9f\xa5\xe7\273\204\xe7\xbb\207"; goto A3GQ6; QLkSP: if ($id == 0) { goto VkNO0; } goto Bbmi_; xbdqP: Ut4Fc: goto VQjb3; Bbmi_: $text = Db::table("\x73\x75\x72\x76\145\x79\x5f\157\x72\x67\141\x6e\151\172\x61\164\151\x6f\x6e")->where(["\x69\x64" => $id])->value("\156\141\x6d\x65"); goto UFeKz; UhcSN: $treeNodeDatas = ["\x69\x64" => $id, "\160\141\162\x65\x6e\x74\137\151\x64" => $parentId, "\164\145\170\164" => $text, "\x69\x63\x6f\156\103\154\163" => "\151\x63\x6f\156\x73\x2d\160\x6f\x69\156\x74", "\x73\164\141\x74\x65" => "\x6f\160\145\156", "\x63\x68\x69\154\x64\162\145\x6e" => [], "\x62\x72\x65\x61\x64\143\162\165\155\x62" => $breadcrumb]; goto nNbsu; hRgYE: return null; goto xbdqP; DflB0: $childOrganizations = Db::table("\163\165\x72\166\145\171\x5f\157\162\x67\141\x6e\151\172\x61\x74\151\157\156")->where(["\x70\141\x72\145\156\x74\137\151\144" => $id, "\x73\x75\162\x76\145\x79\137\151\144" => $surveyId])->field("\x69\144\x2c\156\141\x6d\x65\54\160\x61\162\x65\156\x74\137\x69\144")->order("\157\162\x64\x65\x72\40\141\x73\x63\54\40\x69\x64\x20\x61\x73\x63")->select(); goto DUy6f; UFeKz: if (!($text === null)) { goto Ut4Fc; } goto hRgYE; A3GQ6: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\40\46\x67\x74\x3b\x20" . $text; goto pX31N; Aj_fz: VkNO0: goto L_B5N; DUy6f: foreach ($childOrganizations as $childOrganization) { goto cGOMC; Mr2Rn: $treeNodeDatas["\143\150\151\154\144\162\x65\156"][] = $childNodeDatas; goto ULKGz; ULKGz: rYg0e: goto xMB6n; uALpi: if (!$childNodeDatas) { goto rYg0e; } goto Mr2Rn; xMB6n: vFDYp: goto caX4f; cGOMC: $childNodeDatas = $this->loadTreeDataRecursively($surveyId, $childOrganization["\151\144"], $id, $breadcrumb); goto uALpi; caX4f: } goto zEK98; VQjb3: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\x20\x26\x67\x74\x3b\40" . $text; goto UhcSN; YuEzP: return $treeNodeDatas; goto wAzVO; fGiNg: GXhqk: goto DflB0; zEK98: KIE_l: goto YuEzP; wAzVO: } public function loadComboDatas($surveyId, $id = 0, $prefix = '', $datas = array()) { goto dXaze; meOfF: cNc3c: goto Gd6j1; JBVP5: CjZ9h: goto Hqj80; Hqj80: return $datas; goto cW9bC; eiq2V: $datas[$id] = $prefix . $text; goto PlW71; jjS03: if (!$prefix) { goto yEZ2C; } goto qaNd3; DIpib: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatas($surveyId, $childOrganization["\x69\x64"], $nextPrefix, $datas); e9WpZ: } goto JBVP5; dXaze: if ($id == 0) { goto qQkRG; } goto uwk53; Gd6j1: $childOrganizations = Db::table("\163\x75\162\166\x65\x79\x5f\x6f\162\x67\141\x6e\151\x7a\x61\x74\151\157\x6e")->where(["\160\141\x72\145\x6e\x74\x5f\x69\144" => $id, "\163\165\162\166\x65\x79\137\x69\144" => $surveyId])->field("\x69\144\x2c\x6e\x61\x6d\145\54\x70\141\x72\145\156\164\137\151\144")->order("\157\162\144\x65\162\x20\141\x73\x63\x2c\x20\x69\144\x20\141\163\x63")->select(); goto DIpib; uwk53: $text = Db::table("\x73\165\162\166\145\x79\x5f\157\x72\x67\x61\156\151\x7a\141\x74\151\157\x6e")->where(["\151\144" => $id])->value("\156\141\x6d\x65"); goto jjS03; PlW71: $nextPrefix = $prefix . $text; goto fTKRv; fTKRv: goto cNc3c; goto O0XAs; cI3fm: $nextPrefix = ''; goto meOfF; pqOKu: $datas[$id] = "\55\350\xaf\267\xe9\x80\211\xe6\213\xa9\x2d"; goto cI3fm; K1Gdg: yEZ2C: goto eiq2V; O0XAs: qQkRG: goto pqOKu; qaNd3: $prefix .= "\76"; goto K1Gdg; cW9bC: } public function loadComboDatasLeaf($surveyId, $id = 0, $prefix = '', $datas = array()) { goto rOUWh; yaz67: $datas[$id] = $prefix . $text; goto h7Rxt; uu44l: $text = Db::table("\x73\165\x72\166\x65\171\x5f\x6f\162\147\x61\156\x69\172\x61\164\151\x6f\156")->where(["\x69\144" => $id])->value("\156\141\x6d\x65"); goto p4Lqn; dXUnL: if (!($childCount == 0)) { goto WDbzn; } goto yaz67; p4Lqn: if (!$prefix) { goto fVJdW; } goto EQc2j; EQc2j: $prefix .= "\76"; goto y0mv4; kY7TD: $childOrganizations = Db::table("\163\x75\162\x76\145\x79\x5f\157\162\147\x61\x6e\151\172\141\164\151\x6f\156")->where(["\160\x61\x72\145\156\x74\137\151\x64" => $id, "\x73\165\x72\166\x65\171\x5f\x69\x64" => $surveyId])->field("\x69\144\54\156\x61\155\x65\x2c\160\141\x72\x65\x6e\x74\137\x69\144")->order("\x6f\162\x64\145\x72\x20\x61\x73\143\x2c\x20\x69\144\40\x61\x73\x63")->select(); goto UywYM; UhMu9: c4uUk: goto CpFoZ; g8Z_P: goto k9nnN; goto UhMu9; faDC1: $nextPrefix = ''; goto mfyMS; y0mv4: fVJdW: goto oiwkx; UywYM: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatasLeaf($surveyId, $childOrganization["\151\x64"], $nextPrefix, $datas); IKkWY: } goto idjow; rOUWh: if ($id == 0) { goto c4uUk; } goto uu44l; b9pHm: return $datas; goto rn7Qr; h7Rxt: WDbzn: goto JSyPf; mfyMS: k9nnN: goto kY7TD; JSyPf: $nextPrefix = $prefix . $text; goto g8Z_P; idjow: SoIrh: goto b9pHm; CpFoZ: $datas[$id] = "\55\xe8\257\267\351\x80\211\xe6\x8b\xa9\55"; goto faDC1; oiwkx: $childCount = Db::table("\163\x75\162\x76\145\x79\x5f\x6f\x72\x67\x61\x6e\x69\x7a\141\164\x69\157\156")->where(["\x70\x61\x72\x65\156\164\137\x69\144" => $id, "\x73\165\x72\x76\145\171\x5f\151\144" => $surveyId])->count(); goto dXUnL; rn7Qr: } public function loadFullText($id, $suffix = '') { goto JEh9V; LwdYK: if (!$suffix) { goto z9O_y; } goto PGHLx; PGHLx: $fullText .= "\x20\x26\147\x74\x3b\x20" . $suffix; goto AmjFJ; JEh9V: if (!($id == 0)) { goto IBz_j; } goto sj1bW; k7JHd: IBz_j: goto LHlf2; v7h88: B4_vY: goto GemYK; LHlf2: $organization = Db::table("\x73\165\x72\166\x65\171\137\x6f\162\147\x61\156\151\x7a\x61\x74\x69\157\156")->where(["\x69\144" => $id])->field("\156\141\x6d\x65\54\40\160\x61\162\x65\x6e\164\137\x69\144")->find(); goto ksQMI; sj1bW: return $suffix; goto k7JHd; OfRGO: return $fullText; goto haWFD; X1o4o: $fullText = $this->loadFullText($organization["\160\141\x72\145\156\x74\137\151\144"], $fullText); goto OfRGO; AmjFJ: z9O_y: goto X1o4o; HJzOq: return $suffix; goto v7h88; GemYK: $fullText = $organization["\x6e\141\x6d\x65"]; goto LwdYK; ksQMI: if (!empty($organization)) { goto B4_vY; } goto HJzOq; haWFD: } public function isEmpty($surveyId) { $count = Db::table("\163\165\x72\166\x65\x79\137\157\162\x67\x61\156\x69\x7a\x61\164\151\x6f\156")->where(["\160\x61\x72\145\156\x74\137\x69\144" => 0, "\163\165\162\x76\145\x79\137\x69\144" => $surveyId])->count(); return $count ? false : true; } public function add($surveyId, $name, $parentId) { goto hlExp; c2h57: $id = Db::table("\163\165\x72\x76\145\171\x5f\x6f\x72\x67\x61\x6e\151\172\x61\x74\151\157\156")->insertGetId($data); goto HPFOq; Vlbgn: return true; goto h6LM0; HPFOq: Db::table("\163\x75\x72\166\145\171\x5f\x6f\162\x67\x61\156\x69\x7a\x61\164\x69\157\x6e")->where(["\151\x64" => $id])->setField("\157\x72\x64\x65\x72", $id); goto Vlbgn; hlExp: $data = array("\163\x75\162\x76\145\x79\x5f\x69\x64" => $surveyId, "\x6e\141\x6d\145" => $name, "\x70\141\x72\x65\x6e\164\x5f\x69\x64" => $parentId); goto c2h57; h6LM0: } public function update($id, $name) { goto VjrwZ; VjrwZ: $data = array("\x6e\x61\x6d\145" => $name); goto ymnW3; ymnW3: Db::table("\163\x75\162\x76\145\x79\x5f\157\162\x67\x61\x6e\x69\x7a\x61\x74\x69\157\156")->where("\x69\144", $id)->update($data); goto kJw98; kJw98: return true; goto Caai7; Caai7: } public function delete($surveyId, $id) { goto WqJQp; mHlm_: return $result != 1 ? false : true; goto BuRyM; WqJQp: $orders = Db::table("\x73\165\162\x76\x65\171\137\157\x72\x64\x65\162")->where(["\163\165\x72\x76\145\171\137\x69\x64" => $surveyId, "\163\x75\162\x76\x65\x79\137\157\x72\147\141\x6e\151\172\141\x74\151\157\156\137\151\x64" => $id])->field("\151\144\54\40\x70\145\162\x73\x6f\x6e\141\x6c\137\x64\141\x74\141")->select(); goto J_sDB; Y0vkA: O1WHi: goto vPipo; kxHg1: $result = Db::table("\163\x75\x72\166\x65\171\137\x6f\162\147\141\x6e\151\x7a\x61\x74\x69\157\x6e")->where("\x69\144", $id)->delete(); goto mHlm_; vPipo: Db::table("\x73\x75\x72\166\145\x79\137\x6f\x72\144\x65\x72")->where(["\x73\165\162\x76\x65\171\137\x69\144" => $surveyId, "\x73\x75\162\x76\145\171\137\157\162\x67\141\156\x69\x7a\141\x74\x69\x6f\156\x5f\x69\x64" => $id])->setField("\x73\165\162\166\145\x79\x5f\157\162\x67\x61\156\x69\x7a\141\164\151\157\156\137\x69\144", 0); goto kxHg1; J_sDB: foreach ($orders as $order) { goto WQaUy; WQaUy: $orderId = $order["\x69\x64"]; goto F3X3W; iO_z8: pKj5W: goto kP1Yp; s93nV: if (!isset($personalData["\157\162\147\141\x6e\x69\172\x61\x74\x69\157\156"])) { goto pKj5W; } goto BV951; BV951: $personalData["\157\x72\147\141\156\151\172\141\x74\x69\x6f\156"] = 0; goto iO_z8; kP1Yp: Db::table("\x73\x75\x72\166\x65\x79\x5f\157\x72\x64\145\162")->where("\x69\x64", $orderId)->setField("\x70\145\x72\x73\157\156\x61\x6c\137\144\141\164\x61", json_encode($personalData)); goto mrFGx; mrFGx: vO6oT: goto Clj8m; F3X3W: $personalData = json_decode($order["\x70\145\x72\163\x6f\156\141\x6c\x5f\x64\x61\x74\141"], true); goto s93nV; Clj8m: } goto Y0vkA; BuRyM: } public function up($id) { goto nq8vS; BJZJa: $order = $siblingOrganizations[$i]["\157\162\x64\145\x72"]; goto AuuHp; exJ22: $siblingOrganizations = Db::table("\x73\x75\162\166\x65\x79\x5f\x6f\162\x67\x61\156\151\x7a\141\x74\x69\157\156")->where(["\160\x61\162\145\156\164\137\x69\x64" => $parentId])->field("\151\144\x2c\156\x61\155\145\54\x70\141\x72\x65\156\x74\x5f\x69\x64\54\x6f\x72\x64\x65\x72")->order("\157\x72\x64\x65\162\40\141\x73\143\54\x20\151\x64\x20\141\x73\143")->select(); goto UrVCW; KL6GG: B7xA_: goto d1aIJ; KpUV0: $i = 0; goto KL6GG; LtqKU: nmi4f: goto VoshW; cVrim: if (!($i == 0)) { goto vgFe5; } goto mUObK; h03ud: return; goto lYq0M; d1aIJ: if (!($siblingOrganizations[$i]["\151\144"] == $id)) { goto D7hT0; } goto cVrim; JiPrI: D7hT0: goto TH7Jm; UrVCW: if (!empty($siblingOrganizations)) { goto BDahr; } goto LH1mS; AuuHp: $orderPre = $siblingOrganizations[$i - 1]["\157\x72\144\145\x72"]; goto qa3ed; mUObK: goto nmi4f; goto vtKq8; BQ02o: BDahr: goto RHlGa; vtKq8: vgFe5: goto BJZJa; qPgsn: if ($i < count($siblingOrganizations)) { goto B7xA_; } goto LtqKU; nq8vS: $parentId = Db::table("\163\x75\162\166\145\171\x5f\x6f\162\147\141\156\x69\172\141\164\x69\x6f\x6e")->where(["\151\144" => $id])->value("\x70\x61\x72\145\x6e\164\137\151\144"); goto exJ22; lYq0M: wRQMv: goto KpUV0; a46VN: Db::table("\163\x75\162\166\x65\171\137\x6f\x72\147\141\x6e\151\172\141\164\x69\x6f\x6e")->where(["\151\x64" => $siblingOrganizations[$i - 1]["\x69\x64"]])->setField("\x6f\x72\x64\x65\162", $order); goto JiPrI; TH7Jm: $i++; goto qPgsn; LH1mS: return; goto BQ02o; qa3ed: Db::table("\x73\165\162\166\x65\x79\x5f\157\162\147\141\x6e\x69\172\141\164\151\157\156")->where(["\151\144" => $id])->setField("\x6f\162\x64\x65\162", $orderPre); goto a46VN; RHlGa: if (!(count($siblingOrganizations) <= 1)) { goto wRQMv; } goto h03ud; VoshW: } public function down($id) { goto MunoM; MunoM: $parentId = Db::table("\163\165\x72\166\x65\171\x5f\157\x72\147\141\156\x69\172\141\164\x69\157\x6e")->where(["\x69\144" => $id])->value("\x70\x61\x72\145\x6e\x74\137\151\x64"); goto j0qaW; LvDYf: $order = $siblingOrganizations[$i]["\x6f\162\x64\x65\x72"]; goto ejJMX; VkGhs: iPAGp: goto M1OKx; KC8r6: Psvsp: goto cJqDL; btWFs: if ($i < count($siblingOrganizations)) { goto Psvsp; } goto uGYiD; bu8l6: Db::table("\163\x75\162\x76\x65\171\x5f\157\162\x67\x61\156\x69\172\141\164\x69\157\156")->where(["\151\144" => $siblingOrganizations[$i + 1]["\151\x64"]])->setField("\157\x72\x64\x65\x72", $order); goto B5TEK; lrfOS: $i++; goto btWFs; SLRz2: nBJXg: goto LvDYf; M1OKx: if (!(count($siblingOrganizations) <= 1)) { goto b10q3; } goto HZJEn; B5TEK: A3PQY: goto lrfOS; j0qaW: $siblingOrganizations = Db::table("\x73\x75\162\x76\x65\x79\x5f\157\162\147\x61\x6e\151\172\141\x74\x69\x6f\x6e")->where(["\x70\141\x72\145\x6e\x74\137\151\144" => $parentId])->field("\151\144\54\x6e\141\x6d\145\54\160\x61\x72\x65\x6e\164\x5f\151\144\54\157\x72\x64\x65\162")->order("\x6f\x72\144\145\x72\x20\141\163\x63\54\x20\x69\x64\40\141\x73\x63")->select(); goto lOctS; lOctS: if (!empty($siblingOrganizations)) { goto iPAGp; } goto yZbl6; AiaHd: if (!($i == count($siblingOrganizations) - 1)) { goto nBJXg; } goto rX2Xt; rX2Xt: goto ok9eu; goto SLRz2; ZdQ07: $i = 0; goto KC8r6; ejJMX: $orderNext = $siblingOrganizations[$i + 1]["\157\x72\x64\x65\162"]; goto Wa5JS; Wa5JS: Db::table("\x73\x75\162\x76\145\171\x5f\157\162\x67\141\x6e\x69\x7a\x61\x74\x69\157\x6e")->where(["\x69\144" => $id])->setField("\x6f\x72\144\145\x72", $orderNext); goto bu8l6; uGYiD: ok9eu: goto kcB2A; cJqDL: if (!($siblingOrganizations[$i]["\151\144"] == $id)) { goto A3PQY; } goto AiaHd; TqJa7: b10q3: goto ZdQ07; HZJEn: return; goto TqJa7; yZbl6: return; goto VkGhs; kcB2A: } public function changeLevel($id, $parentId) { Db::table("\x73\165\x72\166\145\x79\x5f\157\162\147\x61\x6e\151\x7a\141\x74\151\x6f\x6e")->where("\x69\x64", $id)->setField("\160\x61\x72\x65\x6e\x74\137\x69\x64", $parentId); return true; } }

<?php
 namespace app\index\service; use think\Log; use think\Db; use think\Debug; use think\Request; use app\index\service\RequestContext; use app\Defs; use app\index\logic\Defs as IndexDefs; class OperationLogs extends Base { protected function __construct() { parent::__construct(); } const CATEGORY_SYSTEM = 0; const CATEGORY_EXPERT = 1; const CATEGORY_SUBJECT = 2; const CATEGORY_SUBJECT_COMBINATION = 3; const CATEGORY_SURVEY = 4; const CATEGORY_ORDER = 5; const CATEGORY_DEFS = array(self::CATEGORY_SYSTEM => "\347\xb3\273\347\xbb\x9f", self::CATEGORY_EXPERT => "\344\xb8\223\xe5\256\xb6", self::CATEGORY_SUBJECT => "\xe9\x87\x8f\xe8\241\250", self::CATEGORY_SUBJECT_COMBINATION => "\xe7\xbb\204\345\220\x88\351\207\217\xe8\xa1\250", self::CATEGORY_SURVEY => "\xe6\x99\xae\xe6\237\xa5", self::CATEGORY_ORDER => "\xe8\256\xa2\345\215\225"); const OPT_ADD_TYPE = 1; const OPT_UPDATE_TYPE = 2; const OPT_DELETE_TYPE = 3; const OPT_RESTORE_TYPE = 4; const OPT_OTHER_TYPE = 5; const OPT_DEFS = array(self::OPT_ADD_TYPE => "\xe6\226\260\xe5\xa2\236", self::OPT_UPDATE_TYPE => "\344\277\xae\xe6\x94\xb9", self::OPT_DELETE_TYPE => "\345\210\xa0\xe9\x99\xa4", self::OPT_RESTORE_TYPE => "\xe6\201\242\345\244\x8d", self::OPT_OTHER_TYPE => "\345\x85\266\344\xbb\226"); const CHANNEL_ADMIN = 1; const CHANNEL_CLI = 3; const CHANNEL_DEFS = array(self::CHANNEL_ADMIN => "\347\xae\xa1\xe7\x90\206\347\xab\257", self::CHANNEL_CLI => "\346\x8e\247\345\x88\xb6\345\217\xb0"); public function systemLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_SYSTEM, $title, $content, $type, $entityId); } public function expertLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto SyfBk; l7TI1: return $this->log(self::CATEGORY_EXPERT, $title, $content, $type, $entityId); goto lruAk; RHtie: lUI80: goto l7TI1; SyfBk: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto lUI80; } goto zTRfx; zTRfx: return; goto RHtie; lruAk: } public function subjectLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto VOlUv; xmN1G: ubzSB: goto emhqF; VOlUv: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto ubzSB; } goto VSPaZ; VSPaZ: return; goto xmN1G; emhqF: return $this->log(self::CATEGORY_SUBJECT, $title, $content, $type, $entityId); goto rKi4f; rKi4f: } public function subjecCombinationtLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto j3BMo; O9tt6: return $this->log(self::CATEGORY_SUBJECT_COMBINATION, $title, $content, $type, $entityId); goto uhMaW; kYv5C: R_Khb: goto O9tt6; gkPBG: return; goto kYv5C; j3BMo: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto R_Khb; } goto gkPBG; uhMaW: } public function surveyLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto WPGb1; WPGb1: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto Wu1Fn; } goto PteXm; vVrgo: Wu1Fn: goto Acl5Z; PteXm: return; goto vVrgo; Acl5Z: return $this->log(self::CATEGORY_SURVEY, $title, $content, $type, $entityId); goto XRDDp; XRDDp: } public function orderLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_ORDER, $title, $content, $type, $entityId); } public function log($category = OperationLogs::CATEGORY_EXPERT, $title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto JVlOq; zPzio: if (RequestContext::I()->loginUserId) { goto NpJjB; } goto SDH8p; WNnYh: NpJjB: goto fI1SJ; TYi3i: $channel = self::CHANNEL_ADMIN; goto LlWrS; kzRW1: mVIy1: goto bSso8; kbBjq: $ip = request()->ip(); goto pruye; Caug9: $device = Defs::DEVICE_DESKTOP; goto eM4B_; eM4B_: $channel = self::CHANNEL_CLI; goto kzRW1; LlWrS: goto mVIy1; goto pH_sj; pH_sj: Wobrw: goto y6yTY; y6yTY: $changed_by = "\xe6\x8e\xa7\345\x88\xb6\xe5\217\xb0"; goto vJr0O; vJr0O: $ip = "\61\62\x37\56\x30\56\x30\x2e\61"; goto Caug9; JVlOq: if (request()->isCli()) { goto Wobrw; } goto zPzio; d743h: goto R0Mw1; goto WNnYh; fI1SJ: $changed_by = RequestContext::I()->loginUserName . "\x28" . RequestContext::I()->loginRealName . "\x29"; goto zOBdj; PcdfX: return $result == 1 ? true : false; goto JF0tO; bSso8: $result = Db::table("\x6f\x70\x65\x72\x61\164\x69\x6f\156\x5f\x6c\x6f\x67\163")->insert(["\143\141\x74\x65\x67\x6f\x72\x79" => $category, "\164\151\x74\154\145" => truncateString($title, 128), "\143\x6f\156\x74\145\156\x74" => truncateString($content, 4096), "\164\171\x70\145" => $type, "\162\145\143\157\x72\144\137\151\144" => $entityId, "\151\x70" => $ip, "\x64\x65\166\x69\143\145" => $device, "\143\150\141\x6e\x67\x65\x64\x5f\142\x79" => $changed_by]); goto PcdfX; SDH8p: $changed_by = ''; goto d743h; pruye: $device = Request::instance()->isMobile() ? Defs::DEVICE_MOBILE : Defs::DEVICE_DESKTOP; goto TYi3i; zOBdj: R0Mw1: goto kbBjq; JF0tO: } }

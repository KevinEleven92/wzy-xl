<?php
 namespace app\index\service; use think\Log; use think\Db; use think\Debug; use think\Request; use app\index\service\RequestContext; use app\Defs; use app\index\logic\Defs as IndexDefs; class OperationLogs extends Base { protected function __construct() { parent::__construct(); } const CATEGORY_SYSTEM = 0; const CATEGORY_EXPERT = 1; const CATEGORY_SUBJECT = 2; const CATEGORY_SUBJECT_COMBINATION = 3; const CATEGORY_SURVEY = 4; const CATEGORY_ORDER = 5; const CATEGORY_DEFS = array(self::CATEGORY_SYSTEM => "\347\263\xbb\xe7\xbb\x9f", self::CATEGORY_EXPERT => "\xe4\xb8\223\xe5\xae\266", self::CATEGORY_SUBJECT => "\351\x87\217\350\xa1\250", self::CATEGORY_SUBJECT_COMBINATION => "\347\xbb\x84\345\220\x88\351\207\x8f\xe8\xa1\xa8", self::CATEGORY_SURVEY => "\346\x99\256\xe6\x9f\245", self::CATEGORY_ORDER => "\xe8\256\242\xe5\215\x95"); const OPT_ADD_TYPE = 1; const OPT_UPDATE_TYPE = 2; const OPT_DELETE_TYPE = 3; const OPT_RESTORE_TYPE = 4; const OPT_OTHER_TYPE = 5; const OPT_DEFS = array(self::OPT_ADD_TYPE => "\xe6\x96\260\345\242\x9e", self::OPT_UPDATE_TYPE => "\xe4\277\256\xe6\x94\xb9", self::OPT_DELETE_TYPE => "\345\210\xa0\351\x99\244", self::OPT_RESTORE_TYPE => "\346\x81\xa2\xe5\244\215", self::OPT_OTHER_TYPE => "\xe5\x85\266\xe4\xbb\226"); const CHANNEL_ADMIN = 1; const CHANNEL_CLI = 3; const CHANNEL_DEFS = array(self::CHANNEL_ADMIN => "\xe7\xae\xa1\347\x90\206\xe7\253\257", self::CHANNEL_CLI => "\346\216\xa7\345\x88\266\345\217\xb0"); public function systemLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_SYSTEM, $title, $content, $type, $entityId); } public function expertLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto XEJr3; Fl1ig: return; goto y2J2l; TlIMM: return $this->log(self::CATEGORY_EXPERT, $title, $content, $type, $entityId); goto bkLei; XEJr3: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto Pt339; } goto Fl1ig; y2J2l: Pt339: goto TlIMM; bkLei: } public function subjectLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto xmDH8; mAtGj: cq2G0: goto tVHCb; xmDH8: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto cq2G0; } goto p4S6b; tVHCb: return $this->log(self::CATEGORY_SUBJECT, $title, $content, $type, $entityId); goto ru_hC; p4S6b: return; goto mAtGj; ru_hC: } public function subjecCombinationtLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto pqg65; yGBsA: return $this->log(self::CATEGORY_SUBJECT_COMBINATION, $title, $content, $type, $entityId); goto pUcXf; rND95: return; goto nwQBV; pqg65: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto T2uOY; } goto rND95; nwQBV: T2uOY: goto yGBsA; pUcXf: } public function surveyLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto VMCTw; vZIIq: return; goto LbJVz; gAkhv: return $this->log(self::CATEGORY_SURVEY, $title, $content, $type, $entityId); goto ey8Ai; LbJVz: qTOmo: goto gAkhv; VMCTw: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto qTOmo; } goto vZIIq; ey8Ai: } public function orderLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_ORDER, $title, $content, $type, $entityId); } public function log($category = OperationLogs::CATEGORY_EXPERT, $title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto PlXDO; QVXLu: $channel = self::CHANNEL_CLI; goto erjrd; PlXDO: if (request()->isCli()) { goto UYN0w; } goto wxwno; EW2hJ: $changed_by = "\xe6\216\247\345\210\xb6\345\217\xb0"; goto o6Msn; EM06t: meD_z: goto T0wX7; LsbzY: $device = Request::instance()->isMobile() ? Defs::DEVICE_MOBILE : Defs::DEVICE_DESKTOP; goto LBVcI; wxwno: if (RequestContext::I()->loginUserId) { goto L0QgY; } goto pLNMn; vQQBd: goto CUgIf; goto Nur6Z; erjrd: CUgIf: goto yaDEi; YrSzf: $device = Defs::DEVICE_DESKTOP; goto QVXLu; lyH_G: return $result == 1 ? true : false; goto mNGh7; yaDEi: $result = Db::table("\x6f\160\x65\162\141\164\x69\157\156\137\154\x6f\147\163")->insert(["\x63\141\x74\145\147\157\x72\x79" => $category, "\164\x69\x74\154\x65" => truncateString($title, 128), "\143\157\x6e\x74\145\x6e\164" => truncateString($content, 4096), "\164\x79\160\x65" => $type, "\162\x65\x63\157\162\144\137\x69\x64" => $entityId, "\151\x70" => $ip, "\144\x65\x76\x69\x63\x65" => $device, "\x63\x68\x61\x6e\x67\x65\x64\137\x62\x79" => $changed_by]); goto lyH_G; T0wX7: $ip = request()->ip(); goto LsbzY; o6Msn: $ip = "\61\62\x37\56\60\x2e\x30\56\61"; goto YrSzf; pLNMn: $changed_by = ''; goto MqI8d; Nur6Z: UYN0w: goto EW2hJ; MqI8d: goto meD_z; goto V8pIg; LBVcI: $channel = self::CHANNEL_ADMIN; goto vQQBd; V8pIg: L0QgY: goto VvAe0; VvAe0: $changed_by = RequestContext::I()->loginUserName . "\50" . RequestContext::I()->loginRealName . "\51"; goto EM06t; mNGh7: } }
